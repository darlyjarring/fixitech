<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Gesti√≥n de Ventas y Compras - Fixitech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Estilos b√°sicos para la ventana emergente de detalle de factura */
        .popup-invoice-container {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            color: #333;
            max-width: 800px;
            margin: 20px auto;
            border: 1px solid #eee;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            background-color: #fff;
        }
        .popup-invoice-container h2 {
            text-align: center;
            color: #0f766e;
            margin-bottom: 25px;
        }
        .popup-invoice-container .info-section {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas peque√±as */
        }
        .popup-invoice-container .info-section > div {
            flex: 1;
            min-width: 280px; /* Asegura un ancho m√≠nimo para cada columna */
            margin-right: 20px;
            margin-bottom: 10px;
        }
        .popup-invoice-container .info-section > div:last-child {
            margin-right: 0;
        }
        .popup-invoice-container p {
            margin: 5px 0;
            line-height: 1.4;
        }
        .popup-invoice-container strong {
            color: #555;
        }
        .popup-invoice-container table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .popup-invoice-container th,
        .popup-invoice-container td {
            border: 1px solid #ddd;
            padding: 10px 8px;
            text-align: left;
        }
        .popup-invoice-container th {
            background-color: #f8f8f8;
            color: #666;
            font-weight: 600;
        }
        .popup-invoice-container tfoot tr.total-row td {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: right;
        }
        .popup-invoice-container .text-right {
            text-align: right;
        }
        .popup-invoice-container .text-center {
            text-align: center;
        }
        .popup-invoice-container .btn-actions {
            text-align: center;
            margin-top: 30px;
        }
        .popup-invoice-container .btn-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 0 5px; /* Espacio entre botones */
        }
        .popup-invoice-container .btn-actions .btn-print {
            background-color: #0f766e; /* Teal */
            color: white;
        }
        .popup-invoice-container .btn-actions .btn-edit {
            background-color: #2563eb; /* Blue */
            color: white;
        }
        .popup-invoice-container .btn-actions .btn-return {
            background-color: #dc2626; /* Red */
            color: white;
        }
        .popup-invoice-container .btn-actions .btn-close {
            background-color: #6b7280; /* Gray */
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <header class="bg-cyan-800 text-white p-4 flex justify-between items-center shadow">
        <h1 class="text-xl font-bold">Fixitech - Gesti√≥n de Ventas</h1>
        <nav class="space-x-4 text-sm">
            <a href="#" onclick="mostrarSeccion('nuevaVentaSection')" class="hover:underline">Nueva Venta</a>
            <a href="#" onclick="mostrarSeccion('gestionFacturasSection')" class="hover:underline">Gesti√≥n de Facturas</a>
            <a href="#" onclick="mostrarSeccion('gestionClientesSection')" class="hover:underline">Clientes</a>
            <a href="#" onclick="mostrarSeccion('gestionProductosSection')" class="hover:underline">Productos/Servicios</a>
            <a href="#" onclick="mostrarSeccion('gestionComprasSection')" class="hover:underline">Compras</a>
        </nav>
    </header>

    <div id="nuevaVentaSection" class="max-w-6xl mx-auto mt-6 bg-white p-6 rounded shadow">
        <h2 class="font-semibold text-lg mb-4" id="formFacturaTitle">Datos del Cliente y Nueva Venta</h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <div>
                <label for="cedulaCliente" class="block text-sm font-medium text-gray-700">C√©dula:</label>
                <input type="text" id="cedulaCliente" placeholder="C√©dula del Cliente" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" oninput="buscarClientePorCedulaONombre()" />
            </div>
            <div>
                <label for="nombreCliente" class="block text-sm font-medium text-gray-700">Nombre:</label>
                <input type="text" id="nombreCliente" placeholder="Nombre del Cliente" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" oninput="buscarClientePorCedulaONombre()" />
            </div>
            <div>
                <label for="telefono" class="block text-sm font-medium text-gray-700">Tel√©fono:</label>
                <input type="text" id="telefono" placeholder="Tel√©fono" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" />
            </div>
            <div>
                <label for="direccion" class="block text-sm font-medium text-gray-700">Direcci√≥n:</label>
                <input type="text" id="direccion" placeholder="Direcci√≥n" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" />
            </div>
        </div>
        <div class="flex justify-end mb-6">
            <button onclick="guardarClienteDesdeFactura()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md w-1/4 transition duration-150 ease-in-out">‚ûï Registrar/Actualizar Cliente</button>
        </div>


        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div>
                <label for="fechaIngreso" class="block text-sm font-medium text-gray-700">Fecha de Ingreso:</label>
                <input type="date" id="fechaIngreso" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" />
            </div>
            <div>
                <label for="fechaEntrega" class="block text-sm font-medium text-gray-700">Fecha de Entrega:</label>
                <input type="date" id="fechaEntrega" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" />
            </div>
            <div>
                <label for="estado" class="block text-sm font-medium text-gray-700">Estado del Pedido:</label>
                <select id="estado" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500">
                    <option value="En espera">En espera</option>
                    <option value="Entregado">Entregado</option>
                    <option value="Facturado">Facturado</option>
                    <option value="Devuelto">Devuelto</option> </select>
            </div>
            <div class="flex items-end">
                <button onclick="guardarFactura()" id="guardarFacturaBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md w-full transition duration-150 ease-in-out">üíæ Guardar Venta</button>
            </div>
        </div>

        <h2 class="font-semibold mt-6 mb-3 text-lg">Agregar √çtems a la Venta</h2>
        <div class="grid md:grid-cols-4 gap-4 mb-4">
            <div>
                <label for="descripcion" class="sr-only">Descripci√≥n</label>
                <input type="text" id="descripcion" placeholder="Descripci√≥n del Art√≠culo/Servicio" class="p-2 border border-gray-300 rounded-md w-full focus:ring-teal-500 focus:border-teal-500" />
            </div>
            <div>
                <label for="cantidad" class="sr-only">Cantidad</label>
                <input type="number" id="cantidad" placeholder="Cantidad" class="p-2 border border-gray-300 rounded-md w-full focus:ring-teal-500 focus:border-teal-500" min="1" value="1" />
            </div>
            <div>
                <label for="precio" class="sr-only">Precio Unitario</label>
                <input type="number" id="precio" placeholder="Precio Unitario" class="p-2 border border-gray-300 rounded-md w-full focus:ring-teal-500 focus:border-teal-500" min="0" step="0.01" />
            </div>
            <div class="flex items-end">
                <button onclick="agregarItem()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-md w-full transition duration-150 ease-in-out">+ Agregar √çtem</button>
            </div>
        </div>

        <div class="overflow-x-auto mb-6">
            <table class="min-w-full text-sm text-left border border-gray-300 rounded-md overflow-hidden">
                <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
                    <tr>
                        <th class="px-3 py-3 border-b-2 border-gray-200 tracking-wider">Descripci√≥n</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-center tracking-wider">Cantidad</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-right tracking-wider">Precio Unitario</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-right tracking-wider">Subtotal</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-center tracking-wider">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="tablaItems" class="bg-white divide-y divide-gray-200">
                    </tbody>
                <tfoot>
                    <tr class="bg-gray-50 font-semibold">
                        <td colspan="3" class="text-right px-3 py-2 border-t border-gray-200 text-gray-800">Total:</td>
                        <td class="px-3 py-2 border-t border-gray-200 text-right text-gray-800" id="total">$0.00</td>
                        <td class="border-t border-gray-200"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="flex justify-end space-x-4">
            <button onclick="mostrarFactura()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-md transition duration-150 ease-in-out">üñ® Imprimir / Ver Previsualizaci√≥n</button>
            <button onclick="limpiarFormulario()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-md transition duration-150 ease-in-out">üîÑ Limpiar Formulario</button>
        </div>
    </div>

    <div id="gestionFacturasSection" class="max-w-6xl mx-auto mt-8 bg-white p-6 rounded shadow hidden">
        <h2 class="font-semibold text-lg mb-4">Gesti√≥n y Consulta de Ventas (Pedidos y Facturas)</h2>

        <div class="grid md:grid-cols-3 gap-4 mb-4">
            <div>
                <label for="filtroCliente" class="block text-sm font-medium text-gray-700">Filtrar por Cliente:</label>
                <input type="text" id="filtroCliente" placeholder="Nombre o C√©dula del Cliente" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" onkeyup="filtrarFacturas()" />
            </div>
             <div>
                <label for="filtroNumeroFactura" class="block text-sm font-medium text-gray-700">Filtrar por N¬∞ Factura:</label>
                <input type="text" id="filtroNumeroFactura" placeholder="Ej: 00000125" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" onkeyup="filtrarFacturas()" />
            </div>
            <div class="flex items-end">
                <button onclick="cargarFacturas()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md w-full transition duration-150 ease-in-out">Actualizar Lista</button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left border border-gray-300 rounded-md overflow-hidden">
                <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
                    <tr>
                        <th class="px-3 py-3 border-b-2 border-gray-200 tracking-wider">N¬∞ Factura</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 tracking-wider">Cliente</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-right tracking-wider">Total</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 tracking-wider">Estado</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 tracking-wider">Fecha Ing.</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-center tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody id="listaFacturasTableBody" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="6" class="text-center py-4 text-gray-500">Cargando ventas...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="gestionClientesSection" class="max-w-6xl mx-auto mt-8 bg-white p-6 rounded shadow hidden">
        <h2 class="font-semibold text-lg mb-4">Gesti√≥n y Consulta de Clientes</h2>
        
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
            <div>
                <label for="filtroClienteNombre" class="block text-sm font-medium text-gray-700">Filtrar por Nombre/C√©dula:</label>
                <input type="text" id="filtroClienteNombre" placeholder="Nombre o C√©dula del Cliente" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" onkeyup="filtrarClientes()" />
            </div>
            <div class="flex items-end">
                <button onclick="cargarClientes()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md w-full transition duration-150 ease-in-out">Actualizar Lista</button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left border border-gray-300 rounded-md overflow-hidden">
                <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
                    <tr>
                        <th class="px-3 py-3 border-b-2 border-gray-200 tracking-wider">ID/C√©dula</th>
                        <th class="px-3 py-3 border-b-2 border-gray-20er-200 tracking-wider">Nombre</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 tracking-wider">Tel√©fono</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 tracking-wider">Direcci√≥n</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-center tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody id="listaClientesTableBody" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="5" class="text-center py-4 text-gray-500">Cargando clientes...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="gestionProductosSection" class="max-w-6xl mx-auto mt-8 bg-white p-6 rounded shadow hidden">
        <h2 class="font-semibold text-lg mb-4" id="formProductoServicioTitle">Gesti√≥n de Productos y Servicios</h2>
        
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <div>
                <label for="nombreProducto" class="block text-sm font-medium text-gray-700">Nombre:</label>
                <input type="text" id="nombreProducto" placeholder="Nombre del Producto/Servicio" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" />
            </div>
            <div>
                <label for="tipoProducto" class="block text-sm font-medium text-gray-700">Tipo:</label>
                <select id="tipoProducto" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" onchange="toggleStockInput()">
                    <option value="producto">Producto</option>
                    <option value="servicio">Servicio</option>
                </select>
            </div>
            <div>
                <label for="precioProducto" class="block text-sm font-medium text-gray-700">Precio:</label>
                <input type="number" id="precioProducto" placeholder="Precio" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" min="0" step="0.01" />
            </div>
            <div id="stockInputDiv">
                <label for="stockProducto" class="block text-sm font-medium text-gray-700">Stock:</label>
                <input type="number" id="stockProducto" placeholder="Stock" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" min="0" value="0" />
            </div>
            <div class="flex items-end">
                <button onclick="guardarProductoServicio()" id="guardarProductoBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md w-full transition duration-150 ease-in-out">üíæ Guardar Producto/Servicio</button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left border border-gray-300 rounded-md overflow-hidden">
                <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
                    <tr>
                        <th class="px-3 py-3 border-b-2 border-gray-200 tracking-wider">Nombre</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 tracking-wider">Tipo</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-right tracking-wider">Precio</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-center tracking-wider">Stock</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-center tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody id="listaProductosTableBody" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="5" class="text-center py-4 text-gray-500">Cargando productos y servicios...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div id="gestionComprasSection" class="max-w-6xl mx-auto mt-8 bg-white p-6 rounded shadow hidden">
        <h2 class="font-semibold text-lg mb-4">Registro y Consulta de Compras</h2>
        
        <h3 class="font-medium text-md mb-3 text-gray-700">Registrar Nueva Compra</h3>
        <div class="grid md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6 items-end">
            <div>
                <label for="fechaCompra" class="block text-sm font-medium text-gray-700">Fecha:</label>
                <input type="date" id="fechaCompra" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" />
            </div>
            <div>
                <label for="productoCompra" class="block text-sm font-medium text-gray-700">Producto:</label>
                <select id="productoCompra" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500"></select>
            </div>
            <div>
                <label for="cantidadCompra" class="block text-sm font-medium text-gray-700">Cantidad:</label>
                <input type="number" id="cantidadCompra" placeholder="Cantidad comprada" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" min="1" value="1" />
            </div>
            <div>
                <label for="costoCompra" class="block text-sm font-medium text-gray-700">Costo Unitario:</label>
                <input type="number" id="costoCompra" placeholder="Costo unitario" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" min="0" step="0.01" />
            </div>
            <div>
                <label for="facturaCompra" class="block text-sm font-medium text-gray-700">N¬∞ Factura:</label>
                <input type="text" id="facturaCompra" placeholder="N√∫mero de factura" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" required />
            </div>
            <div>
                <label for="usuarioCompra" class="block text-sm font-medium text-gray-700">Usuario:</label>
                <input type="text" id="usuarioCompra" placeholder="Usuario que registra" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" />
            </div>
            <div class="flex items-end col-span-2">
                <button onclick="guardarCompra()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md w-full transition duration-150 ease-in-out">üíæ Guardar Compra</button>
            </div>
        </div>

        <hr class="my-6 border-gray-200">

        <h3 class="font-medium text-md mb-3 text-gray-700">Historial de Compras</h3>
        <div class="grid md:grid-cols-4 gap-4 mb-4 items-end">
            <div>
                <label for="filtroAno" class="block text-sm font-medium text-gray-700">Filtrar por A√±o:</label>
                <select id="filtroAno" onchange="filtrarCompras()" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500"></select>
            </div>
            <div>
                <label for="filtroMes" class="block text-sm font-medium text-gray-700">Filtrar por Mes:</label>
                <select id="filtroMes" onchange="filtrarCompras()" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Todos</option>
                    <option value="1">Enero</option>
                    <option value="2">Febrero</option>
                    <option value="3">Marzo</option>
                    <option value="4">Abril</option>
                    <option value="5">Mayo</option>
                    <option value="6">Junio</option>
                    <option value="7">Julio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Septiembre</option>
                    <option value="10">Octubre</option>
                    <option value="11">Noviembre</option>
                    <option value="12">Diciembre</option>
                </select>
            </div>
            <div>
                <label for="filtroDia" class="block text-sm font-medium text-gray-700">Filtrar por D√≠a:</label>
                <input type="number" id="filtroDia" placeholder="D√≠a (ej. 15)" onkeyup="filtrarCompras()" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" min="1" max="31" />
            </div>
            <div class="flex items-end">
                <button onclick="cargarCompras()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md w-full transition duration-150 ease-in-out">Actualizar Lista</button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left border border-gray-300 rounded-md overflow-hidden">
                <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
                    <tr>
                        <th class="px-3 py-3 border-b-2 border-gray-200 tracking-wider">Fecha</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 tracking-wider">Producto</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-center tracking-wider">Cantidad</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-right tracking-wider">Costo Unitario</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-right tracking-wider">Total Compra</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 tracking-wider">N¬∞ Factura</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 tracking-wider">Usuario</th>
                    </tr>
                </thead>
                <tbody id="listaComprasTableBody" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="7" class="text-center py-4 text-gray-500">Cargando compras...</td></tr>
                </tbody>
                <tfoot id="comprasSummaryFooter">
                    </tfoot>
            </table>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
    <script src="firebase.js"></script> 
    <script>
        const db = firebase.firestore();
        let items = [];
        let todasLasFacturas = []; // Para almacenar todas las facturas/pedidos
        let facturaEnEdicionId = null; 
        let todaLaInformacionFacturaEnEdicion = null; 
        
        let todosLosClientes = []; 
        let todosLosProductosYServicios = []; 
        let productoServicioEnEdicionId = null; 

        let todasLasCompras = []; 
        
        function mostrarMensaje(mensaje, colorClass = 'bg-blue-500') {
            const container = document.createElement('div');
            container.className = `fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-md shadow-lg text-white ${colorClass} transition-all duration-300 z-50`;
            container.textContent = mensaje;
            document.body.appendChild(container);
            setTimeout(() => {
                container.classList.add('opacity-0', 'translate-y-4');
                container.addEventListener('transitionend', () => container.remove());
            }, 3000);
        }

        function limpiarFormulario() {
            document.getElementById('cedulaCliente').value = '';
            document.getElementById('nombreCliente').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('direccion').value = '';
            document.getElementById('fechaIngreso').value = new Date().toISOString().split('T')[0];
            document.getElementById('fechaEntrega').value = new Date().toISOString().split('T')[0];
            document.getElementById('estado').value = 'En espera';
            items = [];
            actualizarTabla();
            
            facturaEnEdicionId = null;
            todaLaInformacionFacturaEnEdicion = null;
            document.getElementById('formFacturaTitle').textContent = 'Datos del Cliente y Nueva Venta';
            document.getElementById('guardarFacturaBtn').textContent = 'üíæ Guardar Venta';
        }

        function limpiarFormularioCompra() {
            document.getElementById('fechaCompra').value = new Date().toISOString().split('T')[0];
            document.getElementById('productoCompra').value = '';
            document.getElementById('cantidadCompra').value = '1';
            document.getElementById('costoCompra').value = '';
            document.getElementById('facturaCompra').value = '';
            document.getElementById('usuarioCompra').value = '';
        }

        function limpiarFormularioProductoServicio() {
            document.getElementById('nombreProducto').value = '';
            document.getElementById('tipoProducto').value = 'producto';
            document.getElementById('precioProducto').value = '';
            document.getElementById('stockProducto').value = '0';
            document.getElementById('stockInputDiv').classList.remove('hidden');
            productoServicioEnEdicionId = null;
            document.getElementById('formProductoServicioTitle').textContent = 'Gesti√≥n de Productos y Servicios';
            document.getElementById('guardarProductoBtn').textContent = 'üíæ Guardar Producto/Servicio';
        }


        // Funci√≥n para mostrar/ocultar secciones
        function mostrarSeccion(sectionId) {
            document.querySelectorAll('div[id$="Section"]').forEach(section => {
                section.classList.add('hidden');
            });

            document.getElementById(sectionId).classList.remove('hidden');

            // L√≥gica espec√≠fica al mostrar cada secci√≥n
            if (sectionId === 'nuevaVentaSection') {
                if (facturaEnEdicionId === null) { 
                    limpiarFormulario();
                }
                document.getElementById('formFacturaTitle').textContent = 'Datos del Cliente y Nueva Venta';
                document.getElementById('guardarFacturaBtn').textContent = 'üíæ Guardar Venta';
            } else if (sectionId === 'gestionFacturasSection') {
                cargarFacturas(); 
                facturaEnEdicionId = null; 
                todaLaInformacionFacturaEnEdicion = null;
            } else if (sectionId === 'gestionClientesSection') {
                cargarClientes();
            } else if (sectionId === 'gestionProductosSection') {
                limpiarFormularioProductoServicio();
                cargarProductosServicios();
            } else if (sectionId === 'gestionComprasSection') {
                limpiarFormularioCompra();
                cargarProductosParaCompras(); 
                cargarCompras(); 
            }
        }


        // Inicializar las fechas a la fecha actual y mostrar la secci√≥n de nueva venta
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fechaIngreso').value = today;
            document.getElementById('fechaEntrega').value = today;
            document.getElementById('fechaCompra').value = today; // Nueva fecha de compra
            actualizarTabla(); // Para el formulario de nueva factura (mostrar "No hay √≠tems...")
            mostrarSeccion('nuevaVentaSection'); // Muestra la secci√≥n de Nueva Venta por defecto
        });

        function agregarItem() {
            const descripcionInput = document.getElementById('descripcion');
            const cantidadInput = document.getElementById('cantidad');
            const precioInput = document.getElementById('precio');

            const descripcion = descripcionInput.value.trim();
            const cantidad = parseInt(cantidadInput.value);
            const precio = parseFloat(precioInput.value);

            if (!descripcion || isNaN(cantidad) || cantidad <= 0 || isNaN(precio) || precio < 0) {
                mostrarMensaje('Por favor, ingresa una descripci√≥n v√°lida, una cantidad positiva y un precio unitario no negativo.', 'bg-red-500');
                return;
            }

            const subtotal = cantidad * precio;
            items.push({ descripcion, cantidad, precio, subtotal });

            // Limpiar campos despu√©s de agregar
            descripcionInput.value = '';
            cantidadInput.value = '1';
            precioInput.value = '';
            descripcionInput.focus();

            actualizarTabla();
        }

        function actualizarTabla() {
            const tabla = document.getElementById('tablaItems');
            const totalEl = document.getElementById('total');
            tabla.innerHTML = '';
            let total = 0;

            if (items.length === 0) {
                tabla.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No hay √≠tems agregados a√∫n.</td></tr>`;
                totalEl.textContent = `$0.00`;
                return;
            }

            items.forEach((item, index) => {
                total += item.subtotal;
                tabla.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 border-b border-gray-200">${item.descripcion}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-center">${item.cantidad}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-right">$${item.precio.toFixed(2)}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-right">$${item.subtotal.toFixed(2)}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-center">
                            <button onclick="eliminarItem(${index})" class="text-red-600 hover:text-red-800 transition duration-150 ease-in-out" title="Eliminar √çtem">‚úñ</button>
                        </td>
                    </tr>
                `;
            });
            totalEl.textContent = `$${total.toFixed(2)}`;
        }

        function eliminarItem(index) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este √≠tem?')) {
                items.splice(index, 1);
                actualizarTabla();
            }
        }

        // Funci√≥n auxiliar para formatear el n√∫mero de factura
        function formatInvoiceNumber(number) {
            const year = new Date().getFullYear();
            const paddedNumber = String(number).padStart(6, '0');
            return `${paddedNumber}${year.toString().substring(2)}`;
        }

        // Nueva funci√≥n para actualizar el stock
        async function actualizarStock(items, tipoOperacion = 'restar') {
            const batch = db.batch();
            try {
                for (const item of items) {
                    // La descripci√≥n en el formulario puede no ser un producto,
                    // por lo que necesitamos buscar su ID en nuestra lista de productos
                    const producto = todosLosProductosYServicios.find(p => p.nombre === item.descripcion && p.tipo === 'producto');

                    if (producto) {
                        const productoRef = db.collection('productosYServicios').doc(producto.id);
                        const productoDoc = await productoRef.get();
                        const stockActual = productoDoc.data().stock || 0;
                        let nuevoStock = stockActual;

                        if (tipoOperacion === 'restar') {
                            nuevoStock = stockActual - item.cantidad;
                        } else if (tipoOperacion === 'sumar') {
                            nuevoStock = stockActual + item.cantidad;
                        }

                        if (nuevoStock < 0) {
                             throw new Error(`No hay suficiente stock para el producto "${item.descripcion}". Stock actual: ${stockActual}.`);
                        }
                        
                        batch.update(productoRef, { stock: nuevoStock });
                    }
                }
                await batch.commit();
            } catch (error) {
                throw error;
            }
        }

        async function guardarFactura() {
            const clienteCedula = document.getElementById('cedulaCliente').value.trim();
            const clienteNombre = document.getElementById('nombreCliente').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const direccion = document.getElementById('direccion').value.trim();
            const fechaIngreso = document.getElementById('fechaIngreso').value;
            const fechaEntrega = document.getElementById('fechaEntrega').value;
            const estado = document.getElementById('estado').value;
            const total = items.reduce((sum, item) => sum + item.subtotal, 0);

            if (!clienteCedula && !clienteNombre) {
                mostrarMensaje('Por favor, ingresa al menos la C√©dula o el Nombre del cliente.', 'bg-red-500');
                return;
            }
            if (!telefono || !direccion || !fechaIngreso || !fechaEntrega) {
                mostrarMensaje('Por favor, completa el Tel√©fono, Direcci√≥n y las Fechas.', 'bg-red-500');
                return;
            }
            if (items.length === 0) {
                mostrarMensaje('La venta debe contener al menos un √≠tem.', 'bg-red-500');
                return;
            }
            if (new Date(fechaIngreso) > new Date(fechaEntrega)) {
                mostrarMensaje('La fecha de entrega no puede ser anterior a la fecha de ingreso.', 'bg-red-500');
                return;
            }

            let message = '';
            let docRef;

            if (facturaEnEdicionId) {
                docRef = db.collection('facturas').doc(facturaEnEdicionId);
            } else {
                docRef = db.collection('facturas').doc();
            }
            
            try {
                if (estado === 'Facturado') {
                    // L√≥gica para facturar, se ejecuta en una transacci√≥n
                    await db.runTransaction(async (transaction) => {
                        // 1. Lecturas
                        const counterRef = db.collection('contadores').doc('facturas');
                        const counterDoc = await transaction.get(counterRef);
                        const pedidoDoc = await transaction.get(docRef);

                        // Si es un pedido que se est√° facturando, verificamos el stock
                        if (pedidoDoc.exists) {
                            const stockPromises = items.map(item => {
                                const producto = todosLosProductosYServicios.find(p => p.nombre === item.descripcion && p.tipo === 'producto');
                                if (producto) {
                                    const productoRef = db.collection('productosYServicios').doc(producto.id);
                                    return transaction.get(productoRef);
                                }
                                return Promise.resolve(null);
                            });
                            const stockDocs = await Promise.all(stockPromises);

                            stockDocs.forEach((stockDoc, index) => {
                                if (stockDoc && stockDoc.exists) {
                                    const stockActual = stockDoc.data().stock || 0;
                                    const cantidadVendida = items[index].cantidad;
                                    const nuevoStock = stockActual - cantidadVendida;
                                    if (nuevoStock < 0) {
                                        throw new Error(`No hay suficiente stock para el producto "${items[index].descripcion}". Stock actual: ${stockActual}.`);
                                    }
                                    transaction.update(stockDoc.ref, { stock: nuevoStock });
                                }
                            });
                        }
                        
                        // 2. Escrituras despu√©s de todas las lecturas
                        let currentNumber = counterDoc.exists ? (counterDoc.data().ultimoNumero || 0) : 0;
                        const newNumber = currentNumber + 1;
                        const invoiceNumber = formatInvoiceNumber(newNumber);
                        
                        transaction.update(counterRef, { ultimoNumero: newNumber });
                        
                        const data = {
                            numeroFactura: invoiceNumber,
                            clienteCedula: clienteCedula || null,
                            clienteNombre: clienteNombre || null, 
                            telefono,
                            direccion,
                            fechaIngreso,
                            fechaEntrega,
                            estado,
                            items: items.map(item => ({ descripcion: item.descripcion, cantidad: item.cantidad, precio: item.precio, subtotal: item.subtotal })),
                            total: parseFloat(total.toFixed(2)),
                            timestamp: facturaEnEdicionId ? todaLaInformacionFacturaEnEdicion.timestamp : firebase.firestore.FieldValue.serverTimestamp()
                        };
                        transaction.set(docRef, data);
                    });

                    message = facturaEnEdicionId ? `‚úÖ Pedido facturado y stock actualizado con √©xito.` : `‚úÖ Factura guardada y stock actualizado con √©xito.`;

                } else {
                    // L√≥gica para guardar un pedido (sin transacci√≥n)
                    const data = {
                        numeroFactura: null,
                        clienteCedula: clienteCedula || null,
                        clienteNombre: clienteNombre || null, 
                        telefono,
                        direccion,
                        fechaIngreso,
                        fechaEntrega,
                        estado,
                        items: items.map(item => ({ descripcion: item.descripcion, cantidad: item.cantidad, precio: item.precio, subtotal: item.subtotal })),
                        total: parseFloat(total.toFixed(2)),
                        timestamp: facturaEnEdicionId ? todaLaInformacionFacturaEnEdicion.timestamp : firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await docRef.set(data);
                    message = facturaEnEdicionId ? `‚úÖ Pedido actualizado con √©xito.` : `‚úÖ Pedido de venta guardado con √©xito.`;
                }

                mostrarMensaje(message);
                limpiarFormulario();
                cargarFacturas(); 

            } catch (error) {
                console.error("Error al guardar/actualizar la venta: ", error);
                mostrarMensaje("‚ùå Hubo un error al guardar/actualizar la venta. Por favor, int√©ntalo de nuevo. Detalles: " + error.message, 'bg-red-500');
            }
        }
        
        // Nueva funci√≥n para cargar la factura en el formulario para edici√≥n/facturaci√≥n
        async function cargarFacturaParaEdicion(facturaId) {
            const factura = todasLasFacturas.find(f => f.id === facturaId);
            if (!factura) {
                mostrarMensaje('Venta no encontrada para editar.', 'bg-red-500');
                return;
            }

            facturaEnEdicionId = facturaId;
            todaLaInformacionFacturaEnEdicion = factura;

            document.getElementById('cedulaCliente').value = factura.clienteCedula || '';
            document.getElementById('nombreCliente').value = factura.clienteNombre || '';
            document.getElementById('telefono').value = factura.telefono || '';
            document.getElementById('direccion').value = factura.direccion || '';
            document.getElementById('fechaIngreso').value = factura.fechaIngreso;
            document.getElementById('fechaEntrega').value = factura.fechaEntrega;
            document.getElementById('estado').value = factura.estado;

            items = factura.items;
            actualizarTabla();

            document.getElementById('formFacturaTitle').textContent = `Editando Venta`;
            document.getElementById('guardarFacturaBtn').textContent = 'üíæ Actualizar Venta';

            mostrarSeccion('nuevaVentaSection');
        }

        async function cargarFacturas() {
            const tableBody = document.getElementById('listaFacturasTableBody');
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Cargando ventas...</td></tr>';
            todasLasFacturas = [];
            try {
                const querySnapshot = await db.collection('facturas').orderBy('timestamp', 'desc').get();
                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No hay ventas registradas.</td></tr>';
                    return;
                }
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    todasLasFacturas.push({ id: doc.id, ...data });
                });
                
                filtrarFacturas(); // Mostrar todas al inicio y aplicar filtros si hay
            } catch (error) {
                console.error("Error al cargar las facturas: ", error);
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Error al cargar las ventas.</td></tr>';
            }
        }

        function filtrarFacturas() {
            const filtroCliente = document.getElementById('filtroCliente').value.toLowerCase();
            const filtroNumeroFactura = document.getElementById('filtroNumeroFactura').value.toLowerCase();
            const tableBody = document.getElementById('listaFacturasTableBody');
            tableBody.innerHTML = '';

            const facturasFiltradas = todasLasFacturas.filter(factura => {
                const clienteMatch = (factura.clienteNombre && factura.clienteNombre.toLowerCase().includes(filtroCliente)) || 
                                     (factura.clienteCedula && factura.clienteCedula.toLowerCase().includes(filtroCliente));
                const numeroFacturaMatch = (factura.numeroFactura && factura.numeroFactura.toLowerCase().includes(filtroNumeroFactura)) ||
                                          (filtroNumeroFactura === '' && !factura.numeroFactura); // Muestra pedidos si el filtro est√° vac√≠o
                return clienteMatch && numeroFacturaMatch;
            });

            if (facturasFiltradas.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No se encontraron ventas con los filtros aplicados.</td></tr>';
                return;
            }

            facturasFiltradas.forEach(factura => {
                const fecha = factura.fechaIngreso ? new Date(factura.fechaIngreso + 'T00:00:00').toLocaleDateString() : 'N/A';
                const numeroFacturaDisplay = factura.numeroFactura || `<span class="bg-yellow-100 text-yellow-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">Pendiente</span>`;
                const accionesHTML = factura.numeroFactura 
                    ? `<button onclick="verDetalleFactura('${factura.id}')" class="text-blue-600 hover:text-blue-800 transition duration-150 ease-in-out mr-2" title="Ver Detalle">üëÅÔ∏è</button>
                       <button onclick="cargarFacturaParaEdicion('${factura.id}')" class="text-green-600 hover:text-green-800 transition duration-150 ease-in-out mr-2" title="Editar">‚úèÔ∏è</button>`
                    : `<button onclick="verDetalleFactura('${factura.id}')" class="text-blue-600 hover:text-blue-800 transition duration-150 ease-in-out mr-2" title="Ver Detalle">üëÅÔ∏è</button>
                       <button onclick="cargarFacturaParaEdicion('${factura.id}')" class="bg-green-500 text-white hover:bg-green-600 text-xs font-medium py-1 px-2 rounded transition duration-150 ease-in-out" title="Facturar este Pedido">Facturar</button>`;

                tableBody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 border-b border-gray-200">${numeroFacturaDisplay}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${factura.clienteNombre || factura.clienteCedula || 'N/A'}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-right">$${factura.total.toFixed(2)}</td>
                        <td class="px-3 py-2 border-b border-gray-200">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                factura.estado === 'Facturado' ? 'bg-green-100 text-green-800' :
                                factura.estado === 'En espera' ? 'bg-yellow-100 text-yellow-800' :
                                factura.estado === 'Entregado' ? 'bg-blue-100 text-blue-800' :
                                'bg-gray-100 text-gray-800'
                            }">
                                ${factura.estado}
                            </span>
                        </td>
                        <td class="px-3 py-2 border-b border-gray-200">${fecha}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-center">
                            ${accionesHTML}
                        </td>
                    </tr>
                `;
            });
        }
        
        async function verDetalleFactura(facturaId) {
            const facturaDoc = await db.collection('facturas').doc(facturaId).get();
            if (!facturaDoc.exists) {
                mostrarMensaje('Venta no encontrada.', 'bg-red-500');
                return;
            }
            const data = facturaDoc.data();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const title = data.numeroFactura ? `Factura N¬∞ ${data.numeroFactura}` : `Pedido N¬∞ ${facturaId.substring(0, 8)}`;
            doc.text(title, 15, 15);
            
            let y = 25;
            doc.setFontSize(10);
            doc.text(`Cliente: ${data.clienteNombre || 'N/A'}`, 15, y);
            doc.text(`C√©dula: ${data.clienteCedula || 'N/A'}`, 15, y + 5);
            doc.text(`Fecha de Ingreso: ${data.fechaIngreso}`, 100, y);
            doc.text(`Fecha de Entrega: ${data.fechaEntrega}`, 100, y + 5);
            
            y += 15;
            doc.autoTable({
                startY: y,
                head: [['Descripci√≥n', 'Cantidad', 'Precio Unitario', 'Subtotal']],
                body: data.items.map(item => [item.descripcion, item.cantidad, `$${item.precio.toFixed(2)}`, `$${item.subtotal.toFixed(2)}`]),
                foot: [['', '', 'Total:', `$${data.total.toFixed(2)}`]],
                theme: 'striped'
            });

            const popup = window.open('', '_blank', 'width=800,height=600');
            const pdfUrl = doc.output('datauristring');
            popup.document.write(`
                <iframe width='100%' height='100%' src='${pdfUrl}'></iframe>
            `);
        }

        async function guardarClienteDesdeFactura() {
            const cedula = document.getElementById('cedulaCliente').value.trim();
            const nombre = document.getElementById('nombreCliente').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const direccion = document.getElementById('direccion').value.trim();

            if (!cedula || !nombre) {
                mostrarMensaje('Por favor, ingresa la c√©dula y el nombre del cliente para registrar.', 'bg-red-500');
                return;
            }

            try {
                const clienteExistente = await db.collection('clientes').doc(cedula).get();
                const clienteData = {
                    nombre,
                    telefono,
                    direccion,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('clientes').doc(cedula).set(clienteData, { merge: true });
                if (clienteExistente.exists) {
                    mostrarMensaje('Cliente actualizado con √©xito.');
                } else {
                    mostrarMensaje('Cliente registrado con √©xito.');
                }
            } catch (error) {
                console.error("Error al registrar/actualizar el cliente: ", error);
                mostrarMensaje("Error al registrar/actualizar el cliente. Por favor, int√©ntalo de nuevo.", 'bg-red-500');
            }
        }

        async function buscarClientePorCedulaONombre() {
            const cedulaInput = document.getElementById('cedulaCliente').value.trim();
            const nombreInput = document.getElementById('nombreCliente').value.trim().toLowerCase();
            const telefonoInput = document.getElementById('telefono');
            const direccionInput = document.getElementById('direccion');

            if (cedulaInput.length > 0) {
                 const clienteDoc = await db.collection('clientes').doc(cedulaInput).get();
                 if (clienteDoc.exists) {
                     const data = clienteDoc.data();
                     document.getElementById('nombreCliente').value = data.nombre || '';
                     telefonoInput.value = data.telefono || '';
                     direccionInput.value = data.direccion || '';
                     mostrarMensaje('Cliente encontrado.', 'bg-green-500');
                     return;
                 }
            }

            // Si no se encontr√≥ por c√©dula o la c√©dula est√° vac√≠a, buscamos por nombre
            if (nombreInput.length > 0) {
                 const querySnapshot = await db.collection('clientes').where('nombre', '==', nombreInput).limit(1).get();
                 if (!querySnapshot.empty) {
                      const clienteDoc = querySnapshot.docs[0];
                      const data = clienteDoc.data();
                      document.getElementById('cedulaCliente').value = clienteDoc.id || '';
                      telefonoInput.value = data.telefono || '';
                      direccionInput.value = data.direccion || '';
                      mostrarMensaje('Cliente encontrado.', 'bg-green-500');
                      return;
                 }
            }
            
            // Si no se encuentra, limpiar campos
            if (cedulaInput.length > 0) {
                 document.getElementById('nombreCliente').value = '';
                 telefonoInput.value = '';
                 direccionInput.value = '';
            }
        }

        async function cargarClientes() {
            const tableBody = document.getElementById('listaClientesTableBody');
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Cargando clientes...</td></tr>';
            todosLosClientes = [];
            try {
                const querySnapshot = await db.collection('clientes').get();
                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No hay clientes registrados.</td></tr>';
                    return;
                }
                
                querySnapshot.forEach(doc => {
                    todosLosClientes.push({ id: doc.id, ...doc.data() });
                });
                
                filtrarClientes();
            } catch (error) {
                console.error("Error al cargar los clientes: ", error);
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Error al cargar los clientes.</td></tr>';
            }
        }

        function filtrarClientes() {
            const filtroNombre = document.getElementById('filtroClienteNombre').value.toLowerCase();
            const tableBody = document.getElementById('listaClientesTableBody');
            tableBody.innerHTML = '';
            
            const clientesFiltrados = todosLosClientes.filter(cliente => 
                (cliente.nombre && cliente.nombre.toLowerCase().includes(filtroNombre)) ||
                (cliente.id && cliente.id.toLowerCase().includes(filtroNombre))
            );

            if (clientesFiltrados.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No se encontraron clientes con los filtros aplicados.</td></tr>';
                 return;
            }

            clientesFiltrados.forEach(cliente => {
                tableBody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 border-b border-gray-200">${cliente.id}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${cliente.nombre || 'N/A'}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${cliente.telefono || 'N/A'}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${cliente.direccion || 'N/A'}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-center">
                            <button onclick="editarCliente('${cliente.id}')" class="text-green-600 hover:text-green-800 transition duration-150 ease-in-out" title="Editar">‚úèÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
        }

        async function editarCliente(clienteId) {
            mostrarMensaje('Esta funci√≥n est√° pendiente de implementar.', 'bg-gray-500');
            // Aqu√≠ puedes implementar la l√≥gica para cargar el cliente en un formulario de edici√≥n
        }

        function toggleStockInput() {
            const tipo = document.getElementById('tipoProducto').value;
            const stockInputDiv = document.getElementById('stockInputDiv');
            if (tipo === 'servicio') {
                stockInputDiv.classList.add('hidden');
                document.getElementById('stockProducto').value = 0;
            } else {
                stockInputDiv.classList.remove('hidden');
            }
        }

        async function guardarProductoServicio() {
            const nombre = document.getElementById('nombreProducto').value.trim();
            const tipo = document.getElementById('tipoProducto').value;
            const precio = parseFloat(document.getElementById('precioProducto').value);
            const stock = tipo === 'producto' ? parseInt(document.getElementById('stockProducto').value) : 0;

            if (!nombre || isNaN(precio) || precio < 0 || (tipo === 'producto' && (isNaN(stock) || stock < 0))) {
                mostrarMensaje('Por favor, completa todos los campos correctamente.', 'bg-red-500');
                return;
            }

            try {
                const data = {
                    nombre,
                    tipo,
                    precio,
                    stock: stock,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (productoServicioEnEdicionId) {
                    await db.collection('productosYServicios').doc(productoServicioEnEdicionId).set(data, { merge: true });
                    mostrarMensaje('Producto/Servicio actualizado con √©xito.');
                } else {
                    await db.collection('productosYServicios').add(data);
                    mostrarMensaje('Producto/Servicio guardado con √©xito.');
                }

                limpiarFormularioProductoServicio();
                cargarProductosServicios();
            } catch (error) {
                console.error("Error al guardar/actualizar el producto/servicio: ", error);
                mostrarMensaje("Error al guardar/actualizar el producto/servicio. " + error.message, 'bg-red-500');
            }
        }

        async function cargarProductosServicios() {
            const tableBody = document.getElementById('listaProductosTableBody');
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Cargando productos y servicios...</td></tr>';
            todosLosProductosYServicios = [];
            try {
                const querySnapshot = await db.collection('productosYServicios').get();
                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No hay productos ni servicios registrados.</td></tr>';
                    return;
                }
                
                querySnapshot.forEach(doc => {
                    todosLosProductosYServicios.push({ id: doc.id, ...doc.data() });
                });
                
                tableBody.innerHTML = '';
                todosLosProductosYServicios.forEach(item => {
                    const stockDisplay = item.tipo === 'producto' ? item.stock : 'N/A';
                    tableBody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-3 py-2 border-b border-gray-200">${item.nombre}</td>
                            <td class="px-3 py-2 border-b border-gray-200">${item.tipo}</td>
                            <td class="px-3 py-2 border-b border-gray-200 text-right">$${item.precio.toFixed(2)}</td>
                            <td class="px-3 py-2 border-b border-gray-200 text-center">${stockDisplay}</td>
                            <td class="px-3 py-2 border-b border-gray-200 text-center">
                                <button onclick="editarProductoServicio('${item.id}')" class="text-green-600 hover:text-green-800 transition duration-150 ease-in-out" title="Editar">‚úèÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Error al cargar los productos y servicios: ", error);
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Error al cargar los datos.</td></tr>';
            }
        }

        function editarProductoServicio(itemId) {
            const item = todosLosProductosYServicios.find(p => p.id === itemId);
            if (!item) {
                mostrarMensaje('√çtem no encontrado para editar.', 'bg-red-500');
                return;
            }

            productoServicioEnEdicionId = itemId;

            document.getElementById('nombreProducto').value = item.nombre;
            document.getElementById('tipoProducto').value = item.tipo;
            document.getElementById('precioProducto').value = item.precio;
            document.getElementById('stockProducto').value = item.stock;
            toggleStockInput();

            document.getElementById('formProductoServicioTitle').textContent = `Editando: ${item.nombre}`;
            document.getElementById('guardarProductoBtn').textContent = 'üíæ Actualizar';

            mostrarSeccion('gestionProductosSection');
        }

        function generarPDF(data, facturaNum) { 
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 15;
            const margin = 15;
            const lineHeight = 7;
            doc.setFontSize(18);
            doc.setTextColor(52, 152, 219);
            const title = data.numeroFactura ? `Factura N¬∞ ${data.numeroFactura}` : `Pedido`;
            doc.text(title, margin, y);
            y += lineHeight * 2;
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0); 
            doc.text(`Cliente: ${data.clienteNombre || 'N/A'}`, margin, y);
            doc.text(`C√©dula: ${data.clienteCedula || 'N/A'}`, margin + 80, y);
            y += lineHeight;
            doc.text(`Tel√©fono: ${data.telefono || 'N/A'}`, margin, y);
            doc.text(`Direcci√≥n: ${data.direccion || 'N/A'}`, margin + 80, y);
            y += lineHeight * 2;

            doc.autoTable({
                startY: y,
                head: [['Descripci√≥n', 'Cantidad', 'Precio Unitario', 'Subtotal']],
                body: data.items.map(item => [item.descripcion, item.cantidad, `$${item.precio.toFixed(2)}`, `$${item.subtotal.toFixed(2)}`]),
                foot: [['', '', 'Total:', `$${data.total.toFixed(2)}`]],
                theme: 'striped',
                margin: { left: margin, right: margin }
            });

            doc.save(`factura_${facturaNum || data.id}.pdf`);
        }

        async function mostrarFactura() {
            const clienteCedula = document.getElementById('cedulaCliente').value.trim();
            const clienteNombre = document.getElementById('nombreCliente').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const direccion = document.getElementById('direccion').value.trim();
            const fechaIngreso = document.getElementById('fechaIngreso').value;
            const fechaEntrega = document.getElementById('fechaEntrega').value;
            const estado = document.getElementById('estado').value;
            const total = items.reduce((sum, item) => sum + item.subtotal, 0);

            if (!clienteCedula && !clienteNombre) {
                mostrarMensaje('Por favor, ingresa al menos la C√©dula o el Nombre del cliente.', 'bg-red-500');
                return;
            }
            if (!telefono || !direccion || !fechaIngreso || !fechaEntrega) {
                mostrarMensaje('Por favor, completa el Tel√©fono, Direcci√≥n y las Fechas.', 'bg-red-500');
                return;
            }
            if (items.length === 0) {
                mostrarMensaje('La venta debe contener al menos un √≠tem.', 'bg-red-500');
                return;
            }
            
            const data = {
                clienteCedula, clienteNombre, telefono, direccion, fechaIngreso, fechaEntrega, estado, items, total
            };

            const popup = window.open('', '_blank', 'width=800,height=600');
            popup.document.write(`
                <html>
                <head>
                    <title>Previsualizaci√≥n</title>
                    <style>${document.querySelector('style').innerHTML}</style>
                </head>
                <body>
                    <div class="popup-invoice-container">
                        <h2>Previsualizaci√≥n de ${data.estado === 'Facturado' ? 'Factura' : 'Pedido'}</h2>
                        <div class="info-section">
                            <div>
                                <p><strong>Cliente:</strong> ${data.clienteNombre || 'N/A'}</p>
                                <p><strong>C√©dula:</strong> ${data.clienteCedula || 'N/A'}</p>
                                <p><strong>Tel√©fono:</strong> ${data.telefono || 'N/A'}</p>
                            </div>
                            <div>
                                <p><strong>Estado:</strong> ${data.estado}</p>
                                <p><strong>Fecha Ingreso:</strong> ${data.fechaIngreso}</p>
                                <p><strong>Fecha Entrega:</strong> ${data.fechaEntrega}</p>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Descripci√≥n</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-right">Precio Unitario</th>
                                    <th class="text-right">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.items.map(item => `
                                    <tr>
                                        <td>${item.descripcion}</td>
                                        <td class="text-center">${item.cantidad}</td>
                                        <td class="text-right">$${item.precio.toFixed(2)}</td>
                                        <td class="text-right">$${item.subtotal.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <td colspan="3" class="text-right">Total:</td>
                                    <td class="text-right">$${data.total.toFixed(2)}</td>
                                </tr>
                            </tfoot>
                        </table>
                        <div class="btn-actions">
                            <button class="btn-print" onclick="window.print()">Imprimir</button>
                            <button class="btn-close" onclick="window.close()">Cerrar</button>
                        </div>
                    </div>
                </body>
                </html>
            `);
        }
        
        async function guardarCompra() {
            const fechaCompra = document.getElementById('fechaCompra').value;
            const productoId = document.getElementById('productoCompra').value;
            const cantidad = parseInt(document.getElementById('cantidadCompra').value);
            const costo = parseFloat(document.getElementById('costoCompra').value);
            const numeroFactura = document.getElementById('facturaCompra').value.trim();
            const usuario = document.getElementById('usuarioCompra').value.trim();
            
            if (!fechaCompra || !productoId || isNaN(cantidad) || cantidad <= 0 || isNaN(costo) || costo < 0 || !numeroFactura || !usuario) {
                mostrarMensaje('Por favor, completa todos los campos del formulario de compra correctamente.', 'bg-red-500');
                return;
            }

            try {
                const comprasRef = db.collection('compras');
                // 1. Verificar si el n√∫mero de factura ya existe
                const facturaExistente = await comprasRef.where('numeroFactura', '==', numeroFactura).limit(1).get();
                if (!facturaExistente.empty) {
                    mostrarMensaje(`El n√∫mero de factura "${numeroFactura}" ya ha sido registrado.`, 'bg-red-500');
                    return;
                }

                // Obtener una referencia para el nuevo documento *antes* de la transacci√≥n
                const newCompraRef = comprasRef.doc(); 

                // Usamos una transacci√≥n para garantizar que la actualizaci√≥n del stock sea at√≥mica
                await db.runTransaction(async (transaction) => {
                    // 2. Obtener el producto para actualizar el stock
                    const productoRef = db.collection('productosYServicios').doc(productoId);
                    const productoDoc = await transaction.get(productoRef);
                    if (!productoDoc.exists) {
                        throw new Error("El producto seleccionado no existe.");
                    }
                    const stockActual = productoDoc.data().stock || 0;
                    const nuevoStock = stockActual + cantidad;
                    
                    // 3. Actualizar el stock del producto
                    transaction.update(productoRef, { stock: nuevoStock });
                    
                    // 4. Guardar la nueva compra usando la referencia creada
                    const nombreProducto = productoDoc.data().nombre;
                    const compraData = {
                        fecha: fechaCompra,
                        productoId,
                        nombreProducto,
                        cantidad,
                        costo,
                        totalCompra: cantidad * costo,
                        numeroFactura,
                        usuario,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    transaction.set(newCompraRef, compraData); 
                });

                mostrarMensaje('‚úÖ Compra registrada y stock actualizado con √©xito.');
                limpiarFormularioCompra();
                cargarCompras(); 
                
            } catch (error) {
                console.error("Error al registrar la compra: ", error);
                mostrarMensaje("‚ùå Error al registrar la compra. " + error.message, 'bg-red-500');
            }
        }
        
        async function cargarProductosParaCompras() {
            const select = document.getElementById('productoCompra');
            select.innerHTML = '<option value="">Cargando...</option>';
            try {
                const querySnapshot = await db.collection('productosYServicios').where('tipo', '==', 'producto').get();
                select.innerHTML = '<option value="">Selecciona un producto</option>';
                querySnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = data.nombre;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Error al cargar productos para el formulario de compras: ", error);
                select.innerHTML = '<option value="">Error al cargar</option>';
            }
        }
        
        async function cargarCompras() {
            const tableBody = document.getElementById('listaComprasTableBody');
            const summaryFooter = document.getElementById('comprasSummaryFooter');
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Cargando compras...</td></tr>';
            summaryFooter.innerHTML = '';
            todasLasCompras = [];

            try {
                const querySnapshot = await db.collection('compras').orderBy('timestamp', 'desc').get();
                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No hay compras registradas.</td></td>';
                    return;
                }
                
                querySnapshot.forEach(doc => {
                    todasLasCompras.push({ id: doc.id, ...doc.data() });
                });
                
                filtrarCompras();
            } catch (error) {
                console.error("Error al cargar las compras: ", error);
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-500">Error al cargar las compras.</td></tr>';
            }
        }

        function filtrarCompras() {
            const filtroAno = document.getElementById('filtroAno').value;
            const filtroMes = document.getElementById('filtroMes').value;
            const filtroDia = document.getElementById('filtroDia').value;
            const tableBody = document.getElementById('listaComprasTableBody');
            const summaryFooter = document.getElementById('comprasSummaryFooter');
            
            tableBody.innerHTML = '';
            summaryFooter.innerHTML = '';
            
            let totalGeneral = 0;
            let totalUnidades = 0;

            const comprasFiltradas = todasLasCompras.filter(compra => {
                const fecha = new Date(compra.fecha);
                const ano = fecha.getFullYear().toString();
                const mes = (fecha.getMonth() + 1).toString();
                const dia = fecha.getDate().toString();
                
                const anoMatch = filtroAno === '' || ano === filtroAno;
                const mesMatch = filtroMes === '' || mes === filtroMes;
                const diaMatch = filtroDia === '' || dia === filtroDia;
                
                return anoMatch && mesMatch && diaMatch;
            });
            
            if (comprasFiltradas.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No se encontraron compras con los filtros aplicados.</td></tr>';
                 return;
            }

            comprasFiltradas.forEach(compra => {
                totalGeneral += compra.totalCompra;
                totalUnidades += compra.cantidad;
                tableBody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 border-b border-gray-200">${compra.fecha}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${compra.nombreProducto}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-center">${compra.cantidad}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-right">$${compra.costo.toFixed(2)}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-right">$${compra.totalCompra.toFixed(2)}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${compra.numeroFactura}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${compra.usuario}</td>
                    </tr>
                `;
            });
            
            // Llenar el pie de tabla
            summaryFooter.innerHTML = `
                <tr class="bg-gray-50 font-semibold">
                    <td colspan="2" class="text-right px-3 py-2 border-t border-gray-200 text-gray-800">Totales:</td>
                    <td class="px-3 py-2 border-t border-gray-200 text-center text-gray-800">${totalUnidades}</td>
                    <td class="border-t border-gray-200"></td>
                    <td class="px-3 py-2 border-t border-gray-200 text-right text-gray-800">$${totalGeneral.toFixed(2)}</td>
                    <td colspan="2" class="border-t border-gray-200"></td>
                </tr>
            `;

            // Cargar los a√±os √∫nicos para el filtro
            const anosUnicos = [...new Set(todasLasCompras.map(c => new Date(c.fecha).getFullYear().toString()))].sort().reverse();
            const filtroAnoSelect = document.getElementById('filtroAno');
            filtroAnoSelect.innerHTML = '<option value="">Todos</option>';
            anosUnicos.forEach(ano => {
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                filtroAnoSelect.appendChild(option);
            });
            
            // Seleccionar el a√±o actual si ya est√° cargado
            if (filtroAno) {
                 filtroAnoSelect.value = filtroAno;
            }
            if (filtroMes) {
                 document.getElementById('filtroMes').value = filtroMes;
            }
            if (filtroDia) {
                 document.getElementById('filtroDia').value = filtroDia;
            }
        }
    </script>
</body>
</html>
