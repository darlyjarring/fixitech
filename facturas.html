<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Facturaci√≥n y Compras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
    <style>
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        .sidebar {
            width: 250px;
        }
        .main-content {
            margin-left: 250px;
        }
        .menu-item.active {
            background-color: #3f83f8;
            color: white;
        }
        .expiring-soon {
            background-color: #fbd38d;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-content, .printable-content * {
                visibility: visible;
            }
            .printable-content {
                position: absolute;
                left: 0;
                top: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex min-h-screen">

    <div id="loginSection" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-3xl font-bold text-center text-teal-600 mb-6">Iniciar Sesi√≥n Fixitech</h2>
            <p id="error" class="text-red-600 mt-4 text-center hidden">Credenciales incorrectas</p>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="usuario" class="block text-gray-700 font-medium mb-2">Usuario:</label>
                    <input type="text" id="usuario" name="usuario" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Ej: admin" required>
                </div>
                 <div class="mb-4">
                    <label for="password" class="block text-gray-700 font-medium mb-2">Contrase√±a:</label>
                    <input type="password" id="password" name="password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Contrase√±a" required>
                </div>
               
                <button type="button" id="loginButton" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition duration-300">Ingresar</button>

            </form>
        </div>
    </div>


    <div id="sidebar" class="sidebar bg-gray-800 text-white flex-shrink-0 fixed h-full p-4 flex flex-col hidden">
        <h1 class="text-2xl font-bold mb-6 text-center text-teal-400">Sistema de Venta</h1>
        <nav class="flex-grow">
            <ul>
                <li id="menu-dashboard" class="mb-2 hidden">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" id="menu-dashboard">
                        <span class="mr-2">üìä</span> Dashboard                 </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 active" id="menu-nueva-venta">
                        <span class="mr-2">üí∞</span> Nueva Venta
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" id="menu-facturas">
                        <span class="mr-2">üìã</span> Gesti√≥n de Ventas
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" id="menu-clientes">
                        <span class="mr-2">üßë‚Äçü§ù‚Äçüßë</span> Gesti√≥n de Clientes
                    </a>
                </li>
                <li id="menu-productos" class="mb-2 hidden">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" id="menu-productos">
                        <span class="mr-2">üì¶</span> Productos y Servicios
                    </a>
                </li>
                <li id="menu-compras" class="mb-2 hidden">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" id="menu-compras">
                        <span class="mr-2">üõí</span> Gesti√≥n de Compras
                    </a>
                </li>
                 <li id="menu-consulta-productos" class="mb-2 hidden">
                <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" id="menu-consulta-productos">
                    <span class="mr-2">üîç</span> Consulta de Productos
                </a>
                </li>
            </ul>
        </nav>
        <div class="mt-auto text-center text-gray-400 text-sm">
            <p>Bienvenido, <span id="userNameDisplay" class="font-bold"></span></p>
            <p>Rol: <span id="userRoleDisplay" class="font-bold"></span></p>
            <button class="mt-2 text-red-400 hover:text-red-300" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <div id="main-content" class="main-content flex-grow p-8 hidden">
        
        <div id="dashboardSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-3xl font-semibold mb-6 text-gray-800">Dashboard de Gerencia üìä</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-blue-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-blue-800 mb-4">Productos con Mayor Stock üì¶</h3>
                    <ul id="topStockProductsList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
                <div class="bg-yellow-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-yellow-800 mb-4">Productos por Vencer ‚è≥</h3>
                    <ul id="expiringProductsList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
                <div class="bg-green-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-green-800 mb-4">Productos M√°s Vendidos üìà</h3>
                    <ul id="topSellingProductsList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
                <div class="bg-purple-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-purple-800 mb-4">Vendedores con M√°s Ventas üèÜ</h3>
                    <ul id="topSellingUsersList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="nuevaVentaSection" class="bg-white rounded-lg shadow-md p-6">
            <h2 id="formFacturaTitle" class="text-2xl font-semibold mb-6 text-gray-800">Datos del Cliente y Nueva Venta</h2>
            
            <form id="formFactura" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-4 mb-4">
                    <div class="relative">
                        <label for="cedulaCliente" class="block text-sm font-medium text-gray-700">C√©dula</label>
                        <input type="text" id="cedulaCliente" placeholder="C√©dula del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" onblur="buscarClientePorCedula()">
                    </div>
                    <div class="relative">
                        <label for="nombreCliente" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="nombreCliente" placeholder="Nombre Completo del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                        <button type="button" onclick="guardarClienteDesdeFactura()" class="absolute right-2 top-8 text-sm bg-gray-200 hover:bg-gray-300 p-1 rounded-md" title="Guardar este cliente">üíæ</button>
                    </div>
                    <div>
                        <label for="telefono" class="block text-sm font-medium text-gray-700">Tel√©fono</label>
                        <input type="text" id="telefono" placeholder="N√∫mero de Tel√©fono" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="direccion" class="block text-sm font-medium text-gray-700">Direcci√≥n</label>
                        <input type="text" id="direccion" placeholder="Direcci√≥n del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-1 relative">
                        <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripci√≥n</label>
                        <input type="text" id="descripcion" placeholder="Descripci√≥n del Art√≠culo/Servicio" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" />
                        <ul id="sugerencias" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-48 overflow-y-auto hidden"></ul>
                    </div>
                    <div class="md:col-span-1">
                        <label for="cantidad" class="block text-sm font-medium text-gray-700">Cantidad</label>
                        <input type="number" id="cantidad" value="1" min="1" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div class="md:col-span-1">
                        <label for="precio" class="block text-sm font-medium text-gray-700">Precio Unitario</label>
                        <input type="number" id="precio" placeholder="Precio" step="0.01" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div class="md:col-span-1 flex items-end">
                        <button type="button" onclick="agregarItem()" class="w-full bg-teal-500 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-600 transition duration-200">
                            + Agregar √çtem
                        </button>
                    </div>
                    
                </div>
            </form>

            <div class="mt-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">√çtems de la Venta</h3>
                <div class="bg-gray-50 rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripci√≥n</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unitario</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="tablaItems" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        <tfoot>
                            <tr class="bg-gray-100">
                                <td colspan="3" class="px-3 py-2 text-right font-bold text-lg text-gray-800">Total:</td>
                                <td colspan="2" class="px-3 py-2 text-right font-bold text-lg text-gray-800" id="total">$0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
            <div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="fechaIngreso" class="block text-sm font-medium text-gray-700">Fecha de Ingreso</label>
                    <input type="date" id="fechaIngreso" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="fechaEntrega" class="block text-sm font-medium text-gray-700">Fecha de Entrega</label>
                    <input type="date" id="fechaEntrega" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="estado" class="block text-sm font-medium text-gray-700">Estado</label>
                    <select id="estado" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                        <option value="En espera">En espera</option>
                        <option value="Facturado">Facturado</option>
                        <option value="Entregado">Entregado</option>
                    </select>
                </div>
                <div>
                    <label for="vendedor" class="block text-sm font-medium text-gray-700">Vendedor</label>
                    <input type="text" id="vendedor" class="mt-1 p-2 block w-full border border-gray-300 rounded-md bg-gray-200" readonly>
                </div>
            </div>
            
            <div class="flex justify-end space-x-4 mt-8">
                <button type="button" onclick="mostrarFactura()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                    üîç Previsualizar
                </button>
                <button type="button" id="guardarFacturaBtn" onclick="guardarFactura()" class="bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition duration-200">
                    üíæ Guardar Venta
                </button>
            </div>
        </div>

        <div id="gestionFacturasSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Ventas</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div>
                    <label for="filtroVentasAnio" class="block text-sm font-medium text-gray-700">A√±o</label>
                    <select id="filtroVentasAnio" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div>
                    <label for="filtroVentasMes" class="block text-sm font-medium text-gray-700">Mes</label>
                    <select id="filtroVentasMes" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                        <option value="">Todos</option>
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div>
                    <label for="filtroVentasHoraInicial" class="block text-sm font-medium text-gray-700">Hora Inicial</label>
                    <input type="time" id="filtroVentasHoraInicial" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="filtroVentasHoraFinal" class="block text-sm font-medium text-gray-700">Hora Final</label>
                    <input type="time" id="filtroVentasHoraFinal" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N¬∞ Factura</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendedor</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaFacturasTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="gestionClientesSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Clientes</h2>


            <form id="formCliente" class="space-y-4 mb-6 hidden">
                <h3 id="formClienteTitle" class="text-xl font-semibold">Editar Cliente</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label for="editCedula" class="block text-sm font-medium text-gray-700">C√©dula</label>
                        <input type="text" id="editCedula" placeholder="C√©dula del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md bg-gray-200" readonly>
                    </div>
                    <div>
                        <label for="editNombre" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="editNombre" placeholder="Nombre Completo del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="editTelefono" class="block text-sm font-medium text-gray-700">Tel√©fono</label>
                        <input type="text" id="editTelefono" placeholder="N√∫mero de Tel√©fono" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="editDireccion" class="block text-sm font-medium text-gray-700">Direcci√≥n</label>
                        <input type="text" id="editDireccion" placeholder="Direcci√≥n del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="limpiarFormularioCliente()" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-600 transition duration-200">
                        Cancelar
                    </button>
                    <button type="button" onclick="guardarCliente()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                        üíæ Guardar Cambios
                    </button>
                </div>
            </form>

            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="filtroClienteNombre" class="block text-sm font-medium text-gray-700">Buscar por Nombre o C√©dula</label>
                    <input type="text" id="filtroClienteNombre" oninput="filtrarClientes()" placeholder="Ej: Ana L√≥pez" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√©dula</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tel√©fono</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Direcci√≥n</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaClientesTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div id="gestionProductosSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 id="formProductoServicioTitle" class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Productos y Servicios</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div>
        <label for="filtroNombreProducto" class="block text-sm font-medium text-gray-700">Buscar por Nombre</label>
        <input type="text" id="filtroNombreProducto" oninput="filtrarProductos()" placeholder="Ej: Memoria RAM" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
    </div>
    <div>
        <label for="filtroTipoProducto" class="block text-sm font-medium text-gray-700">Filtrar por Tipo</label>
        <select id="filtroTipoProducto" onchange="filtrarProductos()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
            <option value="">Todos</option>
            <option value="producto">Producto</option>
            <option value="servicio">Servicio</option>
        </select>
    </div>
    <div>
        <label for="filtroVencimientoProducto" class="block text-sm font-medium text-gray-700">Vencimiento antes de</label>
        <input type="date" id="filtroVencimientoProducto" onchange="filtrarProductos()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
    </div>
</div>
            <form id="formProductoServicio" class="space-y-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label for="nombreProducto" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="nombreProducto" placeholder="Nombre del Producto/Servicio" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="tipoProducto" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="tipoProducto" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" onchange="toggleStockInput()">
                            <option value="producto">Producto</option>
                            <option value="servicio">Servicio</option>
                        </select>
                    </div>
                    <div>
                        <label for="precioProducto" class="block text-sm font-medium text-gray-700">Precio de Venta</label>
                        <input type="number" id="precioProducto" placeholder="Precio" step="0.01" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div id="stockInputDiv">
                        <label for="stockProducto" class="block text-sm font-medium text-gray-700">Stock Inicial</label>
                        <input type="number" id="stockProducto" value="0" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="fechaVencimientoProducto" class="block text-sm font-medium text-gray-700">Fecha de Vencimiento</label>
                        <input type="date" id="fechaVencimientoProducto" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                <div class="flex justify-end">
                    <button type="button" id="guardarProductoBtn" onclick="guardarProductoServicio()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                        üíæ Guardar Producto/Servicio
                    </button>
                </div>
            </form>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vencimiento</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaProductosTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>


    <div id="gestionComprasSection" class="hidden bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Compras</h2>
        <form id="formCompra" class="space-y-4 mb-6">
            <h3 class="text-xl font-semibold mb-2">Registrar Nueva Compra</h3>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label for="numeroFacturaCompra" class="block text-sm font-medium text-gray-700">N√∫mero de Factura</label>
                    <input type="text" id="numeroFacturaCompra" placeholder="Ej: 001-002-12345" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="fechaCompra" class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="date" id="fechaCompra" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="productoCompra" class="block text-sm font-medium text-gray-700">Producto</label>
                    <select id="productoCompra" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </select>
                </div>
                <div>
                    <label for="cantidadCompra" class="block text-sm font-medium text-gray-700">Cantidad</label>
                    <input type="number" id="cantidadCompra" value="1" min="1" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="costoCompra" class="block text-sm font-medium text-gray-700">Costo Unitario</label>
                    <input type="number" id="costoCompra" placeholder="Costo" step="0.01" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="fechaVencimientoCompra" class="block text-sm font-medium text-gray-700">Fecha de Vencimiento del Lote</label>
                    <input type="date" id="fechaVencimientoCompra" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
            </div>
            <div class="flex justify-end">
                <button type="button" onclick="guardarCompra()" class="bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition duration-200">
                    üíæ Guardar Compra
                </button>
            </div>
        </form>
        <div class="bg-gray-50 rounded-lg overflow-hidden mt-6">
            <h3 class="text-xl font-semibold p-4">Historial de Compras</h3>
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N¬∞ Factura</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Costo Unitario</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Costo Total</th>
                    </tr>
                </thead>
                <tbody id="listaComprasTableBody" class="bg-white divide-y divide-gray-200">
                </tbody>
            </table>
        </div>
    </div>
        
    </div>
    
    <div id="modalFactura" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-8 printable-content">
            <div class="flex justify-between items-center border-b pb-4 mb-4">
                <h2 class="text-2xl font-bold text-teal-600">Factura de Venta</h2>
                <div class="text-right">
                    <p class="text-sm">N¬∞ Factura: <span id="numFacturaModal"></span></p>
                    <p class="text-sm">Fecha: <span id="fechaFacturaModal"></span></p>
                </div>
            </div>
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800">Datos del Cliente</h3>
                <p class="text-sm">Cliente: <span id="nombreClienteModal"></span></p>
                <p class="text-sm">C√©dula: <span id="cedulaClienteModal"></span></p>
                <p class="text-sm">Tel√©fono: <span id="telefonoClienteModal"></span></p>
                <p class="text-sm">Direcci√≥n: <span id="direccionClienteModal"></span></p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left text-sm font-medium text-gray-600">Descripci√≥n</th>
                            <th class="px-4 py-2 text-center text-sm font-medium text-gray-600">Cantidad</th>
                            <th class="px-4 py-2 text-right text-sm font-medium text-gray-600">Precio Unitario</th>
                            <th class="px-4 py-2 text-right text-sm font-medium text-gray-600">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody id="itemsFacturaModal" class="bg-white divide-y divide-gray-200">
                    </tbody>
                    <tfoot>
                        <tr class="bg-gray-100">
                            <td colspan="3" class="px-4 py-2 text-right font-bold text-lg text-gray-800">Total:</td>
                            <td class="px-4 py-2 text-right font-bold text-lg text-gray-800" id="totalFacturaModal">$0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="flex justify-end space-x-4 mt-8">
                <button type="button" onclick="window.print()" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-600 transition duration-200">
                    üñ®Ô∏è Imprimir Factura
                </button>
                <button type="button" onclick="document.getElementById('modalFactura').classList.add('hidden')" class="bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600 transition duration-200">
                    Cerrar
                </button>
            </div>
        </div>
    </div>


    <script>

        <script src="firebase.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

        const db = firebase.firestore();
        let items = [];
        let todasLasFacturas = [];
        let facturaEnEdicionId = null;
        let todaLaInformacionFacturaEnEdicion = null;
        let todosLosClientes = [];
        let todosLosProductosYServicios = [];
        let productoServicioEnEdicionId = null;
        let todasLasCompras = [];
        let currentLoggedInUser = null;

        window.onload = async () => {
            // Se puede llamar a login() si ya se han guardado las credenciales
        };

        // Variables globales
        let todosLosClientes = [];
        let todosLosProductosYServicios = [];
        let todosLosItemsVenta = [];
        let facturaAEditar = null;

        // --- Funciones de Autenticaci√≥n y Carga Inicial ---
        const usuariosCollection = db.collection('usuarios');

        document.getElementById('loginButton').addEventListener('click', async () => {
            const usuario = document.getElementById('usuario').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('error');
            
            try {
                const querySnapshot = await usuariosCollection.where('usuario', '==', usuario).where('password', '==', password).get();
                if (!querySnapshot.empty) {
                    const user = querySnapshot.docs[0].data();
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    showMainContent(user);
                    errorElement.classList.add('hidden');
                } else {
                    errorElement.classList.remove('hidden');
                }
            } catch (e) {
                console.error("Error al iniciar sesi√≥n:", e);
                errorElement.classList.remove('hidden');
            }
        });

        function showMainContent(user) {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');

            document.getElementById('userNameDisplay').textContent = user.nombre;
            document.getElementById('userRoleDisplay').textContent = user.rol;
            document.getElementById('vendedor').value = user.nombre;

            // Mostrar/ocultar men√∫s seg√∫n el rol
            if (user.rol === 'admin') {
                document.getElementById('menu-dashboard').classList.remove('hidden');
                document.getElementById('menu-productos').classList.remove('hidden');
                document.getElementById('menu-compras').classList.remove('hidden');
                document.getElementById('menu-consulta-productos').classList.remove('hidden');
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            location.reload();
        }

        function mostrarSeccion(seccionId) {
            const secciones = ['dashboardSection', 'nuevaVentaSection', 'gestionFacturasSection', 'gestionClientesSection', 'gestionProductosSection', 'gestionComprasSection', 'consultaProductosSection'];
            secciones.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(seccionId).classList.remove('hidden');

            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(`menu-${seccionId.replace('Section', '')}`).classList.add('active');

            // Cargar datos al cambiar de secci√≥n
            if (seccionId === 'gestionClientesSection') cargarClientes();
            if (seccionId === 'gestionFacturasSection') cargarFacturas();
            if (seccionId === 'gestionProductosSection') cargarProductosYServicios();
            if (seccionId === 'gestionComprasSection') cargarCompras();
            if (seccionId === 'dashboardSection') cargarDashboard();
        }

        // --- Funciones de Gesti√≥n de Clientes ---
        async function cargarClientes() {
            try {
                const clientesSnapshot = await db.collection('clientes').get();
                todosLosClientes = clientesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderizarClientes();
            } catch (e) {
                console.error("Error al cargar clientes: ", e);
            }
        }

        function renderizarClientes(clientes = todosLosClientes) {
            const tableBody = document.getElementById('listaClientesTableBody');
            tableBody.innerHTML = '';
            clientes.forEach(cliente => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap">${cliente.cedula}</td>
                    <td class="px-3 py-2 whitespace-nowrap">${cliente.nombre}</td>
                    <td class="px-3 py-2 whitespace-nowrap">${cliente.telefono}</td>
                    <td class="px-3 py-2 whitespace-nowrap">${cliente.direccion}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-center text-sm font-medium">
                        <button onclick="editarCliente('${cliente.cedula}')" class="text-indigo-600 hover:text-indigo-900 mr-2">Editar</button>
                        <button onclick="eliminarCliente('${cliente.cedula}')" class="text-red-600 hover:text-red-900">Eliminar</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function filtrarClientes() {
            const filtro = document.getElementById('filtroClienteNombre').value.toLowerCase();
            const clientesFiltrados = todosLosClientes.filter(cliente =>
                cliente.nombre.toLowerCase().includes(filtro) || cliente.cedula.includes(filtro)
            );
            renderizarClientes(clientesFiltrados);
        }

        async function guardarCliente() {
            const cedula = document.getElementById('editCedula').value;
            const nombre = document.getElementById('editNombre').value;
            const telefono = document.getElementById('editTelefono').value;
            const direccion = document.getElementById('editDireccion').value;

            if (!cedula || !nombre) {
                alert("La c√©dula y el nombre son campos obligatorios.");
                return;
            }

            try {
                const clienteRef = db.collection('clientes').doc(cedula);
                const doc = await clienteRef.get();

                if (doc.exists) {
                    await clienteRef.update({ nombre, telefono, direccion });
                    alert("Cliente actualizado exitosamente.");
                } else {
                    await clienteRef.set({ cedula, nombre, telefono, direccion });
                    alert("Cliente agregado exitosamente.");
                }
                
                limpiarFormularioCliente();
                cargarClientes();
            } catch (e) {
                console.error("Error al guardar cliente: ", e);
                alert("Error al guardar el cliente.");
            }
        }

        async function editarCliente(cedula) {
            const cliente = todosLosClientes.find(c => c.cedula === cedula);
            if (cliente) {
                document.getElementById('formClienteTitle').textContent = 'Editar Cliente';
                document.getElementById('editCedula').value = cliente.cedula;
                document.getElementById('editNombre').value = cliente.nombre;
                document.getElementById('editTelefono').value = cliente.telefono;
                document.getElementById('editDireccion').value = cliente.direccion;
                document.getElementById('formCliente').classList.remove('hidden');
            }
        }

        async function eliminarCliente(cedula) {
            if (confirm("¬øEst√° seguro de que desea eliminar este cliente?")) {
                try {
                    await db.collection('clientes').doc(cedula).delete();
                    alert("Cliente eliminado exitosamente.");
                    cargarClientes();
                } catch (e) {
                    console.error("Error al eliminar cliente: ", e);
                    alert("Error al eliminar el cliente.");
                }
            }
        }

        function limpiarFormularioCliente() {
            document.getElementById('formCliente').reset();
            document.getElementById('formCliente').classList.add('hidden');
            document.getElementById('editCedula').removeAttribute('readonly');
            document.getElementById('formClienteTitle').textContent = 'Agregar Cliente';
        }

        // --- Funciones de Nueva Venta ---
        async function buscarClientePorCedula() {
            const cedula = document.getElementById('cedulaCliente').value;
            if (cedula) {
                try {
                    const doc = await db.collection('clientes').doc(cedula).get();
                    if (doc.exists) {
                        const cliente = doc.data();
                        document.getElementById('nombreCliente').value = cliente.nombre;
                        document.getElementById('telefono').value = cliente.telefono;
                        document.getElementById('direccion').value = cliente.direccion;
                    } else {
                        alert("Cliente no encontrado. Puede registrarlo con el bot√≥n de guardar.");
                        document.getElementById('nombreCliente').value = "";
                        document.getElementById('telefono').value = "";
                        document.getElementById('direccion').value = "";
                    }
                } catch (e) {
                    console.error("Error al buscar cliente: ", e);
                }
            }
        }

        async function guardarClienteDesdeFactura() {
            const cedula = document.getElementById('cedulaCliente').value;
            const nombre = document.getElementById('nombreCliente').value;
            const telefono = document.getElementById('telefono').value;
            const direccion = document.getElementById('direccion').value;

            if (!cedula || !nombre) {
                alert("La c√©dula y el nombre del cliente son obligatorios.");
                return;
            }

            try {
                await db.collection('clientes').doc(cedula).set({
                    cedula,
                    nombre,
                    telefono,
                    direccion
                }, { merge: true });
                alert("Cliente guardado/actualizado exitosamente.");
            } catch (e) {
                console.error("Error al guardar cliente desde factura: ", e);
                alert("Error al guardar el cliente.");
            }
        }

        function agregarItem() {
            const descripcion = document.getElementById('descripcion').value;
            const cantidad = parseFloat(document.getElementById('cantidad').value);
            const precio = parseFloat(document.getElementById('precio').value);

            if (!descripcion || isNaN(cantidad) || isNaN(precio) || cantidad <= 0 || precio < 0) {
                alert("Por favor, ingrese una descripci√≥n, una cantidad v√°lida y un precio v√°lido.");
                return;
            }

            const subtotal = cantidad * precio;
            todosLosItemsVenta.push({
                descripcion,
                cantidad,
                precio,
                subtotal
            });

            renderizarItemsVenta();
            limpiarFormularioItems();
        }

        function limpiarFormularioItems() {
            document.getElementById('descripcion').value = '';
            document.getElementById('cantidad').value = '1';
            document.getElementById('precio').value = '';
        }

        function renderizarItemsVenta() {
            const tablaItems = document.getElementById('tablaItems');
            tablaItems.innerHTML = '';
            let total = 0;

            todosLosItemsVenta.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap">${item.descripcion}</td>
                    <td class="px-3 py-2 text-center">${item.cantidad}</td>
                    <td class="px-3 py-2 text-right">$${item.precio.toFixed(2)}</td>
                    <td class="px-3 py-2 text-right">$${item.subtotal.toFixed(2)}</td>
                    <td class="px-3 py-2 text-center">
                        <button onclick="eliminarItemVenta(${index})" class="text-red-600 hover:text-red-900">Eliminar</button>
                    </td>
                `;
                tablaItems.appendChild(row);
                total += item.subtotal;
            });

            document.getElementById('total').textContent = `$${total.toFixed(2)}`;
        }
        
        function eliminarItemVenta(index) {
            todosLosItemsVenta.splice(index, 1);
            renderizarItemsVenta();
        }
        
        async function guardarFactura() {
            const cedulaCliente = document.getElementById('cedulaCliente').value;
            const nombreCliente = document.getElementById('nombreCliente').value;
            const telefono = document.getElementById('telefono').value;
            const direccion = document.getElementById('direccion').value;
            const fechaIngreso = document.getElementById('fechaIngreso').value;
            const fechaEntrega = document.getElementById('fechaEntrega').value;
            const estado = document.getElementById('estado').value;
            const vendedor = document.getElementById('vendedor').value;
            const total = parseFloat(document.getElementById('total').textContent.replace('$', ''));

            if (!cedulaCliente || todosLosItemsVenta.length === 0 || !fechaIngreso || !fechaEntrega) {
                alert("Por favor, complete los datos del cliente, agregue al menos un √≠tem y seleccione las fechas.");
                return;
            }

            const facturaData = {
                cedulaCliente,
                nombreCliente,
                telefono,
                direccion,
                fechaIngreso,
                fechaEntrega,
                estado,
                vendedor,
                total,
                items: todosLosItemsVenta,
                fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('facturas').add(facturaData);
                alert("Venta guardada exitosamente.");
                resetearFormularioVenta();
            } catch (e) {
                console.error("Error al guardar la factura: ", e);
                alert("Error al guardar la venta.");
            }
        }

        function resetearFormularioVenta() {
            document.getElementById('formFactura').reset();
            document.getElementById('cedulaCliente').value = '';
            document.getElementById('nombreCliente').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('direccion').value = '';
            todosLosItemsVenta = [];
            renderizarItemsVenta();
        }

        // --- Event Listeners ---
        document.getElementById('menu-nueva-venta').addEventListener('click', () => {
            mostrarSeccion('nuevaVentaSection');
        });
        document.getElementById('menu-facturas').addEventListener('click', () => {
            mostrarSeccion('gestionFacturasSection');
        });
        document.getElementById('menu-clientes').addEventListener('click', () => {
            mostrarSeccion('gestionClientesSection');
        });
        document.getElementById('menu-productos').addEventListener('click', () => {
            mostrarSeccion('gestionProductosSection');
        });
        document.getElementById('menu-compras').addEventListener('click', () => {
            mostrarSeccion('gestionComprasSection');
        });

        document.addEventListener('DOMContentLoaded', () => {
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                showMainContent(JSON.parse(currentUser));
            }
        });
    </script>
</body>
</html>
