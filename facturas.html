<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Sistema de Facturaci√≥n y Compras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
    <style>
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        .sidebar {
            width: 250px;
        }
        .main-content {
            margin-left: 250px;
        }
        .menu-item.active {
            background-color: #3f83f8;
            color: white;
        }
        .expiring-soon {
            background-color: #fbd38d; /* yellow-200 */
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-content, .printable-content * {
                visibility: visible;
            }
            .printable-content {
                position: absolute;
                left: 0;
                top: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex min-h-screen">

    <div id="loginSection" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-3xl font-bold text-center text-teal-600 mb-6">Iniciar Sesi√≥n Fixitech</h2>
            <p id="error" class="text-red-600 mt-4 text-center hidden">Credenciales incorrectas</p>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="usuario" class="block text-gray-700 font-medium mb-2">Usuario:</label>
                    <input type="text" id="usuario" name="usuario" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Ej: admin" required>
                </div>
                 <div class="mb-4">
                    <label for="password" class="block text-gray-700 font-medium mb-2">Contrase√±a:</label>
                    <input type="password" id="password" name="password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Contrase√±a" required>
                </div>
                <button type="button" onclick="login()" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition duration-300">Ingresar</button>
            </form>
        </div>
    </div>

    <div id="sidebar" class="sidebar bg-gray-800 text-white flex-shrink-0 fixed h-full p-4 flex flex-col hidden">
        <h1 class="text-2xl font-bold mb-6 text-center text-teal-400">Sistema de Venta</h1>
        <nav class="flex-grow">
            <ul>
                <li id="menu-dashboard" class="mb-2 hidden">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('dashboardSection')">
                        <span class="mr-2">üìä</span> Dashboard
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 active" onclick="mostrarSeccion('nuevaVentaSection')">
                        <span class="mr-2">üí∞</span> Nueva Venta
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('gestionFacturasSection')">
                        <span class="mr-2">üìã</span> Gesti√≥n de Ventas
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('gestionClientesSection')">
                        <span class="mr-2">üßë‚Äçü§ù‚Äçüßë</span> Gesti√≥n de Clientes
                    </a>
                </li>
                <li id="menu-productos" class="mb-2 hidden">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('gestionProductosSection')">
                        <span class="mr-2">üì¶</span> Productos y Servicios
                    </a>
                </li>
                <li id="menu-compras" class="mb-2 hidden">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('gestionComprasSection')">
                        <span class="mr-2">üõí</span> Gesti√≥n de Compras
                    </a>
                </li>
            </ul>
        </nav>
        <div class="mt-auto text-center text-gray-400 text-sm">
            <p>Bienvenido, <span id="userNameDisplay" class="font-bold"></span></p>
            <p>Rol: <span id="userRoleDisplay" class="font-bold"></span></p>
            <button class="mt-2 text-red-400 hover:text-red-300" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <div id="main-content" class="main-content flex-grow p-8 hidden">
        
        <div id="dashboardSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-3xl font-semibold mb-6 text-gray-800">Dashboard de Gerencia üìä</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-blue-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-blue-800 mb-4">Productos con Mayor Stock üì¶</h3>
                    <ul id="topStockProductsList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
                <div class="bg-yellow-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-yellow-800 mb-4">Productos por Vencer ‚è≥</h3>
                    <ul id="expiringProductsList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
                <div class="bg-green-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-green-800 mb-4">Productos M√°s Vendidos üìà</h3>
                    <ul id="topSellingProductsList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
                <div class="bg-purple-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-purple-800 mb-4">Vendedores con M√°s Ventas üèÜ</h3>
                    <ul id="topSellingUsersList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="nuevaVentaSection" class="bg-white rounded-lg shadow-md p-6">
            <h2 id="formFacturaTitle" class="text-2xl font-semibold mb-6 text-gray-800">Datos del Cliente y Nueva Venta</h2>
            
            <form id="formFactura" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-4 mb-4">
                    <div class="relative">
                        <label for="cedulaCliente" class="block text-sm font-medium text-gray-700">C√©dula</label>
                        <input type="text" id="cedulaCliente" placeholder="C√©dula del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" onblur="buscarClientePorCedula()">
                    </div>
                    <div class="relative">
                        <label for="nombreCliente" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="nombreCliente" placeholder="Nombre Completo del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                        <button type="button" onclick="guardarClienteDesdeFactura()" class="absolute right-2 top-8 text-sm bg-gray-200 hover:bg-gray-300 p-1 rounded-md" title="Guardar este cliente">üíæ</button>
                    </div>
                    <div>
                        <label for="telefono" class="block text-sm font-medium text-gray-700">Tel√©fono</label>
                        <input type="text" id="telefono" placeholder="N√∫mero de Tel√©fono" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="direccion" class="block text-sm font-medium text-gray-700">Direcci√≥n</label>
                        <input type="text" id="direccion" placeholder="Direcci√≥n del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-1 relative">
                        <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripci√≥n</label>
                        <input type="text" id="descripcion" placeholder="Descripci√≥n del Art√≠culo/Servicio" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" />
                        <ul id="sugerencias" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-48 overflow-y-auto hidden"></ul>
                    </div>
                    <div class="md:col-span-1">
                        <label for="cantidad" class="block text-sm font-medium text-gray-700">Cantidad</label>
                        <input type="number" id="cantidad" value="1" min="1" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div class="md:col-span-1">
                        <label for="precio" class="block text-sm font-medium text-gray-700">Precio Unitario</label>
                        <input type="number" id="precio" placeholder="Precio" step="0.01" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div class="md:col-span-1 flex items-end">
                        <button type="button" onclick="agregarItem()" class="w-full bg-teal-500 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-600 transition duration-200">
                            + Agregar √çtem
                        </button>
                    </div>
                </div>
            </form>

            <div class="mt-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">√çtems de la Venta</h3>
                <div class="bg-gray-50 rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripci√≥n</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unitario</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="tablaItems" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        <tfoot>
                            <tr class="bg-gray-100">
                                <td colspan="3" class="px-3 py-2 text-right font-bold text-lg text-gray-800">Total:</td>
                                <td colspan="2" class="px-3 py-2 text-right font-bold text-lg text-gray-800" id="total">$0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
            <div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="fechaIngreso" class="block text-sm font-medium text-gray-700">Fecha de Ingreso</label>
                    <input type="date" id="fechaIngreso" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="fechaEntrega" class="block text-sm font-medium text-gray-700">Fecha de Entrega</label>
                    <input type="date" id="fechaEntrega" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="estado" class="block text-sm font-medium text-gray-700">Estado</label>
                    <select id="estado" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                        <option value="En espera">En espera</option>
                        <option value="Facturado">Facturado</option>
                        <option value="Entregado">Entregado</option>
                    </select>
                </div>
                <div>
                    <label for="vendedor" class="block text-sm font-medium text-gray-700">Vendedor</label>
                    <input type="text" id="vendedor" class="mt-1 p-2 block w-full border border-gray-300 rounded-md bg-gray-200" readonly>
                </div>
            </div>
            
            <div class="flex justify-end space-x-4 mt-8">
                <button type="button" onclick="mostrarFactura()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                    üîç Previsualizar
                </button>
                <button type="button" id="guardarFacturaBtn" onclick="guardarFactura()" class="bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition duration-200">
                    üíæ Guardar Venta
                </button>
            </div>
        </div>

        <div id="gestionFacturasSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Ventas</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div>
                    <label for="filtroVentasAnio" class="block text-sm font-medium text-gray-700">A√±o</label>
                    <select id="filtroVentasAnio" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div>
                    <label for="filtroVentasMes" class="block text-sm font-medium text-gray-700">Mes</label>
                    <select id="filtroVentasMes" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                        <option value="">Todos</option>
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div>
                    <label for="filtroVentasHoraInicial" class="block text-sm font-medium text-gray-700">Hora Inicial</label>
                    <input type="time" id="filtroVentasHoraInicial" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="filtroVentasHoraFinal" class="block text-sm font-medium text-gray-700">Hora Final</label>
                    <input type="time" id="filtroVentasHoraFinal" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N¬∞ Factura</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendedor</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaFacturasTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="gestionClientesSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Clientes</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="filtroClienteNombre" class="block text-sm font-medium text-gray-700">Buscar por Nombre o C√©dula</label>
                    <input type="text" id="filtroClienteNombre" oninput="filtrarClientes()" placeholder="Ej: Ana L√≥pez" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√©dula</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tel√©fono</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Direcci√≥n</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaClientesTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div id="gestionProductosSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 id="formProductoServicioTitle" class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Productos y Servicios</h2>
            
            <form id="formProductoServicio" class="space-y-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label for="nombreProducto" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="nombreProducto" placeholder="Nombre del Producto/Servicio" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="tipoProducto" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="tipoProducto" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" onchange="toggleStockInput()">
                            <option value="producto">Producto</option>
                            <option value="servicio">Servicio</option>
                        </select>
                    </div>
                    <div>
                        <label for="precioProducto" class="block text-sm font-medium text-gray-700">Precio de Venta</label>
                        <input type="number" id="precioProducto" placeholder="Precio" step="0.01" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div id="stockInputDiv">
                        <label for="stockProducto" class="block text-sm font-medium text-gray-700">Stock Inicial</label>
                        <input type="number" id="stockProducto" value="0" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="fechaVencimientoProducto" class="block text-sm font-medium text-gray-700">Fecha de Vencimiento</label>
                        <input type="date" id="fechaVencimientoProducto" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                <div class="flex justify-end">
                    <button type="button" id="guardarProductoBtn" onclick="guardarProductoServicio()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                        üíæ Guardar Producto/Servicio
                    </button>
                </div>
            </form>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vencimiento</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaProductosTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="gestionComprasSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Compras</h2>
            
            <form id="formCompra" class="space-y-4 mb-6">
                <h3 class="text-xl font-semibold mb-2">Registrar Nueva Compra</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label for="fechaCompra" class="block text-sm font-medium text-gray-700">Fecha</label>
                        <input type="date" id="fechaCompra" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="productoCompra" class="block text-sm font-medium text-gray-700">Producto</label>
                        <select id="productoCompra" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                            </select>
                    </div>
                    <div>
                        <label for="cantidadCompra" class="block text-sm font-medium text-gray-700">Cantidad</label>
                        <input type="number" id="cantidadCompra" value="1" min="1" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="costoCompra" class="block text-sm font-medium text-gray-700">Costo Unitario</label>
                        <input type="number" id="costoCompra" placeholder="Costo" step="0.01" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="facturaCompra" class="block text-sm font-medium text-gray-700">N¬∞ Factura Proveedor</label>
                        <input type="text" id="facturaCompra" placeholder="N¬∞ de Factura" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="usuarioCompra" class="block text-sm font-medium text-gray-700">Registrado por</label>
                        <input type="text" id="usuarioCompra" class="mt-1 p-2 block w-full border border-gray-300 rounded-md bg-gray-200" readonly>
                    </div>
                    <div class="flex items-end justify-end">
                        <button type="button" onclick="guardarCompra()" class="bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition duration-200">
                            üíæ Registrar Compra
                        </button>
                    </div>
                </div>
            </form>
            
            <h3 class="text-xl font-semibold mb-4">Historial de Compras</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                <div>
                    <label for="filtroComprasAnio" class="block text-sm font-medium text-gray-700">A√±o</label>
                    <select id="filtroComprasAnio" onchange="filtrarCompras()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div>
                    <label for="filtroComprasMes" class="block text-sm font-medium text-gray-700">Mes</label>
                    <select id="filtroComprasMes" onchange="filtrarCompras()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                        <option value="">Todos</option>
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div>
                    <label for="filtroComprasDia" class="block text-sm font-medium text-gray-700">D√≠a</label>
                    <input type="number" id="filtroComprasDia" onchange="filtrarCompras()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="filtroComprasHoraInicial" class="block text-sm font-medium text-gray-700">Hora Inicial</label>
                    <input type="time" id="filtroComprasHoraInicial" onchange="filtrarCompras()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="filtroComprasHoraFinal" class="block text-sm font-medium text-gray-700">Hora Final</label>
                    <input type="time" id="filtroComprasHoraFinal" onchange="filtrarCompras()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Costo Unit.</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Factura</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                        </tr>
                    </thead>
                    <tbody id="listaComprasTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    <tfoot id="comprasSummaryFooter">
                    </tfoot>
                </table>
            </div>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
    <script src="firebase.js"></script>
    <script>
        const db = firebase.firestore();
        let items = [];
        let todasLasFacturas = [];
        let facturaEnEdicionId = null;
        let todaLaInformacionFacturaEnEdicion = null;
        let todosLosClientes = [];
        let todosLosProductosYServicios = [];
        let productoServicioEnEdicionId = null;
        let todasLasCompras = [];
        let currentLoggedInUser = null;

        async function login() {
            const usuario = document.getElementById('usuario').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('error');
            const doc = await db.collection('usuarios').doc(usuario).get();
            if (doc.exists && doc.data().password === password) {
                errorElement.classList.add('hidden');
                currentLoggedInUser = {
                    username: usuario,
                    rol: doc.data().rol,
                    nombre: doc.data().nombre,
                };
                
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('userNameDisplay').textContent = currentLoggedInUser.nombre;
                document.getElementById('userRoleDisplay').textContent = currentLoggedInUser.rol.toUpperCase();

                if (currentLoggedInUser.rol === 'admin') {
                    document.getElementById('menu-dashboard').classList.remove('hidden');
                    document.getElementById('menu-productos').classList.remove('hidden');
                    document.getElementById('menu-compras').classList.remove('hidden');
                    mostrarSeccion('dashboardSection');
                } else {
                    document.getElementById('menu-dashboard').classList.add('hidden');
                    document.getElementById('menu-productos').classList.add('hidden');
                    document.getElementById('menu-compras').classList.add('hidden');
                    mostrarSeccion('nuevaVentaSection');
                }
                document.getElementById('vendedor').value = currentLoggedInUser.nombre;
                document.getElementById('usuarioCompra').value = currentLoggedInUser.nombre;
            } else {
                errorElement.classList.remove('hidden');
            }
        }

        function logout() {
            currentLoggedInUser = null;
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('loginForm').reset();
            items = [];
            actualizarTablaItems();
        }

        function mostrarSeccion(seccionId) {
            document.querySelectorAll('#main-content > div').forEach(div => {
                div.classList.add('hidden');
            });
            document.getElementById(seccionId).classList.remove('hidden');

            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[onclick="mostrarSeccion('${seccionId}')"]`).classList.add('active');

            if (seccionId === 'nuevaVentaSection') {
                resetFormFactura();
            } else if (seccionId === 'gestionFacturasSection') {
                cargarFacturas();
            } else if (seccionId === 'gestionClientesSection') {
                cargarClientes();
            } else if (seccionId === 'gestionProductosSection') {
                cargarProductosYServicios();
            } else if (seccionId === 'gestionComprasSection') {
                cargarProductosCompra();
                cargarCompras();
            } else if (seccionId === 'dashboardSection') {
                cargarDashboardData();
            }
        }

        function resetFormFactura() {
            document.getElementById('formFactura').reset();
            document.getElementById('cedulaCliente').value = '';
            document.getElementById('nombreCliente').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('direccion').value = '';
            document.getElementById('descripcion').value = '';
            document.getElementById('cantidad').value = '1';
            document.getElementById('precio').value = '';
            document.getElementById('fechaIngreso').valueAsDate = new Date();
            document.getElementById('fechaEntrega').valueAsDate = new Date();
            document.getElementById('vendedor').value = currentLoggedInUser.nombre;
            facturaEnEdicionId = null;
            todaLaInformacionFacturaEnEdicion = null;
            document.getElementById('formFacturaTitle').textContent = 'Datos del Cliente y Nueva Venta';
            document.getElementById('guardarFacturaBtn').textContent = 'üíæ Guardar Venta';
            items = [];
            actualizarTablaItems();
        }

        function agregarItem() {
            const descripcion = document.getElementById('descripcion').value.trim();
            const cantidad = parseFloat(document.getElementById('cantidad').value);
            const precio = parseFloat(document.getElementById('precio').value);
            const stockSugerencia = document.querySelector('#sugerencias li.selected')?.dataset.stock || null;

            if (descripcion === '' || isNaN(cantidad) || cantidad <= 0 || isNaN(precio) || precio < 0) {
                alert('Por favor, ingresa una descripci√≥n, cantidad y precio v√°lidos.');
                return;
            }

            // Validar stock solo para productos
            const productoSeleccionado = todosLosProductosYServicios.find(p => p.nombre.toLowerCase() === descripcion.toLowerCase());
            if (productoSeleccionado && productoSeleccionado.tipo === 'producto') {
                const stockTotal = productoSeleccionado.stock;
                const cantidadEnCarrito = items.filter(item => item.descripcion.toLowerCase() === descripcion.toLowerCase()).reduce((acc, item) => acc + item.cantidad, 0);
                if ((cantidad + cantidadEnCarrito) > stockTotal) {
                    alert(`No hay suficiente stock para el producto "${descripcion}". Stock disponible: ${stockTotal}`);
                    return;
                }
            }

            const itemExistente = items.find(item => item.descripcion.toLowerCase() === descripcion.toLowerCase());
            if (itemExistente) {
                itemExistente.cantidad += cantidad;
                itemExistente.subtotal = itemExistente.cantidad * itemExistente.precio;
            } else {
                items.push({
                    descripcion,
                    cantidad,
                    precio,
                    subtotal: cantidad * precio,
                });
            }

            actualizarTablaItems();
            document.getElementById('descripcion').value = '';
            document.getElementById('cantidad').value = '1';
            document.getElementById('precio').value = '';
            document.getElementById('descripcion').focus();
        }

        function actualizarTablaItems() {
            const tabla = document.getElementById('tablaItems');
            const totalElement = document.getElementById('total');
            tabla.innerHTML = '';
            let total = 0;

            items.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'text-gray-700';
                row.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap">${item.descripcion}</td>
                    <td class="px-3 py-2 text-center">${item.cantidad}</td>
                    <td class="px-3 py-2 text-right">$${item.precio.toFixed(2)}</td>
                    <td class="px-3 py-2 text-right">$${item.subtotal.toFixed(2)}</td>
                    <td class="px-3 py-2 text-center">
                        <button type="button" onclick="eliminarItem(${index})" class="text-red-500 hover:text-red-700">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
                tabla.appendChild(row);
                total += item.subtotal;
            });
            totalElement.textContent = `$${total.toFixed(2)}`;
        }

        function eliminarItem(index) {
            items.splice(index, 1);
            actualizarTablaItems();
        }

        async function guardarFactura() {
            if (items.length === 0) {
                alert('La venta no puede estar vac√≠a.');
                return;
            }

            const cedulaCliente = document.getElementById('cedulaCliente').value.trim();
            const nombreCliente = document.getElementById('nombreCliente').value.trim() || 'Consumidor Final';
            const telefono = document.getElementById('telefono').value.trim();
            const direccion = document.getElementById('direccion').value.trim();
            const fechaIngreso = document.getElementById('fechaIngreso').value;
            const fechaEntrega = document.getElementById('fechaEntrega').value;
            const estado = document.getElementById('estado').value;
            const vendedor = currentLoggedInUser.nombre;
            const total = parseFloat(document.getElementById('total').textContent.replace('$', ''));

            try {
                // Deducci√≥n de stock de productos con l√≥gica FEFO (First-Expiry, First-Out)
                for (const item of items) {
                    const productoRef = db.collection('productosYServicios').where('nombre', '==', item.descripcion).limit(1);
                    const snapshot = await productoRef.get();
                    if (!snapshot.empty && snapshot.docs[0].data().tipo === 'producto') {
                        const productoDoc = snapshot.docs[0];
                        const lotesRef = db.collection('productosYServicios').doc(productoDoc.id).collection('lotes');
                        const lotesSnapshot = await lotesRef.orderBy('fechaVencimiento').get();
                        
                        let cantidadPendiente = item.cantidad;
                        
                        for (const loteDoc of lotesSnapshot.docs) {
                            const loteData = loteDoc.data();
                            if (cantidadPendiente > 0 && loteData.cantidad > 0) {
                                const cantidadADeducir = Math.min(cantidadPendiente, loteData.cantidad);
                                const nuevoStockLote = loteData.cantidad - cantidadADeducir;

                                if (nuevoStockLote === 0) {
                                    await loteDoc.ref.delete();
                                } else {
                                    await loteDoc.ref.update({ cantidad: nuevoStockLote });
                                }
                                cantidadPendiente -= cantidadADeducir;
                            }
                        }
                        if (cantidadPendiente > 0) {
                            alert(`Error: No hay suficiente stock disponible para el producto "${item.descripcion}".`);
                            return;
                        }
                    }
                }

                // Guardar la factura
                const factura = {
                    cliente: {
                        cedula: cedulaCliente,
                        nombre: nombreCliente,
                        telefono: telefono,
                        direccion: direccion,
                    },
                    items: items,
                    total: total,
                    fechaIngreso: fechaIngreso,
                    fechaEntrega: fechaEntrega,
                    estado: estado,
                    vendedor: vendedor,
                    fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
                };

                let docId;
                if (facturaEnEdicionId) {
                    docId = facturaEnEdicionId;
                    await db.collection('facturas').doc(docId).update(factura);
                    alert('Factura actualizada exitosamente.');
                } else {
                    const docRef = await db.collection('facturas').add(factura);
                    docId = docRef.id;
                    alert('Factura guardada exitosamente.');
                }
                
                resetFormFactura();
                cargarFacturas();
                cargarProductosYServicios(); // Recargar la lista de productos para ver el stock actualizado
            } catch (e) {
                console.error("Error al guardar la factura: ", e);
                alert('Ocurri√≥ un error al guardar la factura. Por favor, intenta de nuevo.');
            }
        }

        async function cargarFacturas() {
            const tbody = document.getElementById('listaFacturasTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Cargando...</td></tr>';
            
            let facturasRef = db.collection('facturas').orderBy('fechaCreacion', 'desc');
            
            const snapshot = await facturasRef.get();
            todasLasFacturas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            filtrarFacturas();
        }

        function filtrarFacturas() {
            const anio = document.getElementById('filtroVentasAnio').value;
            const mes = document.getElementById('filtroVentasMes').value;
            const horaInicial = document.getElementById('filtroVentasHoraInicial').value;
            const horaFinal = document.getElementById('filtroVentasHoraFinal').value;
            
            const facturasFiltradas = todasLasFacturas.filter(factura => {
                const fecha = factura.fechaCreacion ? factura.fechaCreacion.toDate() : new Date();
                const facturaAnio = fecha.getFullYear().toString();
                const facturaMes = (fecha.getMonth() + 1).toString();
                const facturaHora = fecha.toTimeString().slice(0, 5);

                const anioMatch = !anio || facturaAnio === anio;
                const mesMatch = !mes || facturaMes === mes;
                const horaInicialMatch = !horaInicial || facturaHora >= horaInicial;
                const horaFinalMatch = !horaFinal || facturaHora <= horaFinal;
                
                return anioMatch && mesMatch && horaInicialMatch && horaFinalMatch;
            });

            const tbody = document.getElementById('listaFacturasTableBody');
            tbody.innerHTML = '';
            if (facturasFiltradas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No se encontraron facturas.</td></tr>';
                return;
            }

            facturasFiltradas.forEach(factura => {
                const fecha = factura.fechaCreacion ? factura.fechaCreacion.toDate().toLocaleDateString('es-ES') : 'N/A';
                const row = document.createElement('tr');
                row.className = 'text-gray-700';
                row.innerHTML = `
                    <td class="px-3 py-2">${factura.id.substring(0, 6)}...</td>
                    <td class="px-3 py-2">${factura.cliente.nombre}</td>
                    <td class="px-3 py-2 text-right">$${factura.total.toFixed(2)}</td>
                    <td class="px-3 py-2">${factura.vendedor}</td>
                    <td class="px-3 py-2">${factura.estado}</td>
                    <td class="px-3 py-2">${fecha}</td>
                    <td class="px-3 py-2 text-center">
                        <button onclick="editarFactura('${factura.id}')" class="text-blue-500 hover:text-blue-700 mx-1">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="eliminarFactura('${factura.id}')" class="text-red-500 hover:text-red-700 mx-1">
                            üóëÔ∏è
                        </button>
                        <button onclick="generarPDF('${factura.id}')" class="text-green-500 hover:text-green-700 mx-1">
                            üìÑ
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            cargarAniosFiltro(todasLasFacturas);
        }

        function cargarAniosFiltro(facturas) {
            const selectAnio = document.getElementById('filtroVentasAnio');
            const anios = [...new Set(facturas.map(f => (f.fechaCreacion ? f.fechaCreacion.toDate().getFullYear() : new Date().getFullYear())))].sort().reverse();
            selectAnio.innerHTML = '<option value="">Todos</option>';
            anios.forEach(anio => {
                const option = document.createElement('option');
                option.value = anio;
                option.textContent = anio;
                selectAnio.appendChild(option);
            });
        }

        async function editarFactura(id) {
            const factura = todasLasFacturas.find(f => f.id === id);
            if (!factura) {
                alert('Factura no encontrada.');
                return;
            }
            
            facturaEnEdicionId = id;
            todaLaInformacionFacturaEnEdicion = factura;

            document.getElementById('cedulaCliente').value = factura.cliente.cedula || '';
            document.getElementById('nombreCliente').value = factura.cliente.nombre || 'Consumidor Final';
            document.getElementById('telefono').value = factura.cliente.telefono || '';
            document.getElementById('direccion').value = factura.cliente.direccion || '';
            document.getElementById('fechaIngreso').value = factura.fechaIngreso || '';
            document.getElementById('fechaEntrega').value = factura.fechaEntrega || '';
            document.getElementById('estado').value = factura.estado || '';
            document.getElementById('vendedor').value = factura.vendedor || '';

            items = factura.items || [];
            actualizarTablaItems();

            document.getElementById('formFacturaTitle').textContent = `Editar Venta #${id.substring(0, 6)}...`;
            document.getElementById('guardarFacturaBtn').textContent = 'üîÑ Actualizar Venta';
            mostrarSeccion('nuevaVentaSection');
        }

        async function eliminarFactura(id) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta factura? Esta acci√≥n no se puede deshacer.')) {
                try {
                    const facturaRef = db.collection('facturas').doc(id);
                    const facturaDoc = await facturaRef.get();
                    const facturaData = facturaDoc.data();
                    
                    // Devolver stock a los lotes
                    for (const item of facturaData.items) {
                        const productoRef = db.collection('productosYServicios').where('nombre', '==', item.descripcion).limit(1);
                        const snapshot = await productoRef.get();
                        if (!snapshot.empty && snapshot.docs[0].data().tipo === 'producto') {
                            const productoDoc = snapshot.docs[0];
                            const lotesRef = db.collection('productosYServicios').doc(productoDoc.id).collection('lotes');
                            const lotesSnapshot = await lotesRef.get();
                            
                            let cantidadADevolver = item.cantidad;
                            
                            for (const loteDoc of lotesSnapshot.docs) {
                                if (cantidadADevolver > 0) {
                                    const loteData = loteDoc.data();
                                    const cantidadDevuelta = Math.min(cantidadADevolver, loteData.cantidad);
                                    await loteDoc.ref.update({ cantidad: loteData.cantidad + cantidadDevuelta });
                                    cantidadADevolver -= cantidadDevuelta;
                                }
                            }
                            if (cantidadADevolver > 0) {
                                await lotesRef.add({ cantidad: cantidadADevolver, fechaVencimiento: '2099-12-31' }); // Lote de emergencia
                            }
                        }
                    }

                    await facturaRef.delete();
                    alert('Factura eliminada correctamente.');
                    cargarFacturas();
                    cargarProductosYServicios(); // Recargar la lista de productos
                } catch (e) {
                    console.error("Error al eliminar la factura: ", e);
                    alert('Ocurri√≥ un error al eliminar la factura. Por favor, intenta de nuevo.');
                }
            }
        }

        function generarPDF(id) {
            const factura = todasLasFacturas.find(f => f.id === id);
            if (!factura) {
                alert('Factura no encontrada.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(22);
            doc.text("Factura", 105, 20, null, null, "center");

            doc.setFontSize(12);
            doc.text(`N¬∞ de Factura: ${id.substring(0, 6)}`, 14, 30);
            doc.text(`Fecha: ${factura.fechaCreacion.toDate().toLocaleDateString('es-ES')}`, 14, 37);
            doc.text(`Vendedor: ${factura.vendedor}`, 14, 44);

            doc.text(`Cliente: ${factura.cliente.nombre}`, 14, 58);
            if (factura.cliente.cedula) doc.text(`C√©dula: ${factura.cliente.cedula}`, 14, 65);
            if (factura.cliente.telefono) doc.text(`Tel√©fono: ${factura.cliente.telefono}`, 14, 72);
            if (factura.cliente.direccion) doc.text(`Direcci√≥n: ${factura.cliente.direccion}`, 14, 79);

            const tableColumn = ["Descripci√≥n", "Cantidad", "Precio Unitario", "Subtotal"];
            const tableRows = factura.items.map(item => [
                item.descripcion,
                item.cantidad,
                `$${item.precio.toFixed(2)}`,
                `$${item.subtotal.toFixed(2)}`
            ]);

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 90,
                styles: { cellPadding: 2, fontSize: 10, cellWidth: 'wrap' },
                headStyles: { fillColor: [20, 100, 160], textColor: 255 },
                columnStyles: {
                    0: { cellWidth: 80 },
                    1: { halign: 'center' },
                    2: { halign: 'right' },
                    3: { halign: 'right' },
                }
            });

            const finalY = doc.autoTable.previous.finalY;
            doc.setFontSize(14);
            doc.text(`Total: $${factura.total.toFixed(2)}`, 195, finalY + 10, null, null, "right");
            
            doc.save(`factura-${id.substring(0, 6)}.pdf`);
        }

        // --- Clientes ---
        async function cargarClientes() {
            const tbody = document.getElementById('listaClientesTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Cargando...</td></tr>';
            
            const snapshot = await db.collection('clientes').get();
            todosLosClientes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            filtrarClientes();
        }

        function filtrarClientes() {
            const filtro = document.getElementById('filtroClienteNombre').value.toLowerCase();
            const clientesFiltrados = todosLosClientes.filter(cliente => 
                (cliente.nombre && cliente.nombre.toLowerCase().includes(filtro)) ||
                (cliente.cedula && cliente.cedula.toLowerCase().includes(filtro))
            );
            
            const tbody = document.getElementById('listaClientesTableBody');
            tbody.innerHTML = '';
            if (clientesFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No se encontraron clientes.</td></tr>';
                return;
            }

            clientesFiltrados.forEach(cliente => {
                const row = document.createElement('tr');
                row.className = 'text-gray-700';
                row.innerHTML = `
                    <td class="px-3 py-2">${cliente.cedula}</td>
                    <td class="px-3 py-2">${cliente.nombre || 'N/A'}</td>
                    <td class="px-3 py-2">${cliente.telefono || 'N/A'}</td>
                    <td class="px-3 py-2">${cliente.direccion || 'N/A'}</td>
                    <td class="px-3 py-2 text-center">
                        <button onclick="editarCliente('${cliente.id}')" class="text-blue-500 hover:text-blue-700 mx-1">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="eliminarCliente('${cliente.id}')" class="text-red-500 hover:text-red-700 mx-1">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function buscarClientePorCedula() {
            const cedula = document.getElementById('cedulaCliente').value;
            if (cedula.length > 0) {
                const cliente = todosLosClientes.find(c => c.cedula === cedula);
                if (cliente) {
                    document.getElementById('nombreCliente').value = cliente.nombre || '';
                    document.getElementById('telefono').value = cliente.telefono || '';
                    document.getElementById('direccion').value = cliente.direccion || '';
                } else {
                    document.getElementById('nombreCliente').value = '';
                    document.getElementById('telefono').value = '';
                    document.getElementById('direccion').value = '';
                }
            }
        }

        async function guardarClienteDesdeFactura() {
            const cedula = document.getElementById('cedulaCliente').value;
            const nombre = document.getElementById('nombreCliente').value;
            const telefono = document.getElementById('telefono').value;
            const direccion = document.getElementById('direccion').value;

            if (!cedula || !nombre) {
                alert('La c√©dula y el nombre son campos requeridos.');
                return;
            }

            try {
                const clienteRef = db.collection('clientes').doc(cedula);
                await clienteRef.set({
                    nombre,
                    telefono,
                    direccion,
                    cedula,
                });
                alert('Cliente guardado exitosamente.');
            } catch (e) {
                console.error("Error al guardar cliente: ", e);
                alert('Ocurri√≥ un error al guardar el cliente.');
            }
        }
        
        // --- Productos y Servicios ---
        function toggleStockInput() {
            const tipo = document.getElementById('tipoProducto').value;
            const stockDiv = document.getElementById('stockInputDiv');
            const fechaDiv = document.getElementById('fechaVencimientoProducto').parentNode;
            if (tipo === 'producto') {
                stockDiv.classList.remove('hidden');
                fechaDiv.classList.remove('hidden');
            } else {
                stockDiv.classList.add('hidden');
                fechaDiv.classList.add('hidden');
            }
        }
        
        async function guardarProductoServicio() {
            const nombre = document.getElementById('nombreProducto').value.trim();
            const tipo = document.getElementById('tipoProducto').value;
            const precio = parseFloat(document.getElementById('precioProducto').value);
            const stock = parseFloat(document.getElementById('stockProducto').value);
            const fechaVencimiento = document.getElementById('fechaVencimientoProducto').value;
            const esNuevo = !productoServicioEnEdicionId;
        
            if (!nombre || isNaN(precio) || precio < 0) {
                alert('Por favor, ingresa un nombre y un precio de venta v√°lidos.');
                return;
            }
        
            if (tipo === 'producto') {
                if (isNaN(stock) || stock < 0 || !fechaVencimiento) {
                    alert('Para los productos, el stock inicial y la fecha de vencimiento son obligatorios.');
                    return;
                }
            }
        
            try {
                const productoRef = esNuevo ? db.collection('productosYServicios').doc() : db.collection('productosYServicios').doc(productoServicioEnEdicionId);
                const productoId = esNuevo ? productoRef.id : productoServicioEnEdicionId;
        
                if (esNuevo) {
                    const nuevoProducto = {
                        nombre: nombre.toLowerCase(),
                        nombreOriginal: nombre,
                        tipo: tipo,
                        precio: precio,
                        fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
                    };
                    await productoRef.set(nuevoProducto);
                    
                    if (tipo === 'producto' && stock > 0) {
                        await productoRef.collection('lotes').add({
                            cantidad: stock,
                            fechaVencimiento: fechaVencimiento,
                            fechaEntrada: firebase.firestore.FieldValue.serverTimestamp(),
                        });
                    }
                } else {
                    const productoData = {
                        nombre: nombre.toLowerCase(),
                        nombreOriginal: nombre,
                        tipo: tipo,
                        precio: precio,
                    };
                    await productoRef.update(productoData);
                }
        
                alert(`Producto/Servicio ${esNuevo ? 'guardado' : 'actualizado'} exitosamente.`);
                document.getElementById('formProductoServicio').reset();
                document.getElementById('guardarProductoBtn').textContent = 'üíæ Guardar Producto/Servicio';
                document.getElementById('formProductoServicioTitle').textContent = 'Gesti√≥n de Productos y Servicios';
                productoServicioEnEdicionId = null;
                cargarProductosYServicios();
            } catch (e) {
                console.error("Error al guardar el producto/servicio: ", e);
                alert('Ocurri√≥ un error al guardar el producto/servicio.');
            }
        }
        
        async function cargarProductosYServicios() {
            const tbody = document.getElementById('listaProductosTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Cargando...</td></tr>';
            
            const snapshot = await db.collection('productosYServicios').get();
            const productosConStock = [];

            for (const doc of snapshot.docs) {
                const producto = { id: doc.id, ...doc.data() };
                let stockTotal = 0;
                let fechaVencimientoCercana = 'N/A';

                if (producto.tipo === 'producto') {
                    const lotesSnapshot = await doc.ref.collection('lotes').orderBy('fechaVencimiento').get();
                    if (!lotesSnapshot.empty) {
                        lotesSnapshot.docs.forEach(loteDoc => {
                            stockTotal += loteDoc.data().cantidad;
                        });
                        fechaVencimientoCercana = lotesSnapshot.docs[0].data().fechaVencimiento;
                    }
                }
                productosConStock.push({ ...producto, stock: stockTotal, fechaVencimiento: fechaVencimientoCercana });
            }

            todosLosProductosYServicios = productosConStock;
            mostrarProductosEnTabla(productosConStock);
        }

        function mostrarProductosEnTabla(productos) {
            const tbody = document.getElementById('listaProductosTableBody');
            tbody.innerHTML = '';
            if (productos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">No se encontraron productos o servicios.</td></tr>';
                return;
            }

            productos.forEach(producto => {
                const hoy = new Date();
                const fechaVencimiento = producto.fechaVencimiento !== 'N/A' ? new Date(producto.fechaVencimiento) : null;
                const diferenciaDias = fechaVencimiento ? Math.ceil((fechaVencimiento - hoy) / (1000 * 60 * 60 * 24)) : null;
                
                let rowClass = 'text-gray-700';
                let vencimientoTexto = producto.fechaVencimiento !== 'N/A' ? producto.fechaVencimiento : 'N/A';
                
                if (diferenciaDias !== null && diferenciaDias <= 30 && diferenciaDias > 0) {
                    rowClass = 'expiring-soon';
                }
                if (diferenciaDias !== null && diferenciaDias <= 0) {
                    vencimientoTexto = `VENCIDO (${producto.fechaVencimiento})`;
                    rowClass = 'bg-red-200';
                }

                const row = document.createElement('tr');
                row.className = rowClass;
                row.innerHTML = `
                    <td class="px-3 py-2">${producto.nombreOriginal}</td>
                    <td class="px-3 py-2">${producto.tipo}</td>
                    <td class="px-3 py-2 text-right">$${producto.precio.toFixed(2)}</td>
                    <td class="px-3 py-2 text-center">${producto.tipo === 'producto' ? producto.stock : 'N/A'}</td>
                    <td class="px-3 py-2">${producto.tipo === 'producto' ? vencimientoTexto : 'N/A'}</td>
                    <td class="px-3 py-2 text-center">
                        <button onclick="editarProductoServicio('${producto.id}')" class="text-blue-500 hover:text-blue-700 mx-1">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="eliminarProductoServicio('${producto.id}')" class="text-red-500 hover:text-red-700 mx-1">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function editarProductoServicio(id) {
            const producto = todosLosProductosYServicios.find(p => p.id === id);
            if (!producto) {
                alert('Producto/Servicio no encontrado.');
                return;
            }
            
            productoServicioEnEdicionId = id;
            document.getElementById('nombreProducto').value = producto.nombreOriginal;
            document.getElementById('tipoProducto').value = producto.tipo;
            document.getElementById('precioProducto').value = producto.precio;
            
            if (producto.tipo === 'producto') {
                document.getElementById('stockInputDiv').classList.remove('hidden');
                document.getElementById('fechaVencimientoProducto').parentNode.classList.remove('hidden');
            } else {
                document.getElementById('stockInputDiv').classList.add('hidden');
                document.getElementById('fechaVencimientoProducto').parentNode.classList.add('hidden');
            }

            document.getElementById('stockProducto').value = producto.stock || 0;
            document.getElementById('fechaVencimientoProducto').value = producto.fechaVencimiento === 'N/A' ? '' : producto.fechaVencimiento;
            document.getElementById('guardarProductoBtn').textContent = 'üîÑ Actualizar Producto/Servicio';
            document.getElementById('formProductoServicioTitle').textContent = `Editar ${producto.nombreOriginal}`;
        }
        
        async function eliminarProductoServicio(id) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este producto/servicio? Esta acci√≥n es irreversible.')) {
                try {
                    const productoRef = db.collection('productosYServicios').doc(id);
                    await productoRef.delete();
                    alert('Producto/Servicio eliminado correctamente.');
                    cargarProductosYServicios();
                } catch (e) {
                    console.error("Error al eliminar el producto/servicio: ", e);
                    alert('Ocurri√≥ un error al eliminar el producto/servicio.');
                }
            }
        }

        // --- Sugerencias de Productos en Venta ---
        document.getElementById('descripcion').addEventListener('input', (e) => {
            const input = e.target.value.toLowerCase();
            const sugerenciasUl = document.getElementById('sugerencias');
            sugerenciasUl.innerHTML = '';
            
            if (input.length > 0) {
                const sugerencias = todosLosProductosYServicios.filter(p => p.nombre.includes(input));
                if (sugerencias.length > 0) {
                    sugerenciasUl.classList.remove('hidden');
                    sugerencias.forEach(p => {
                        const li = document.createElement('li');
                        li.textContent = p.nombreOriginal;
                        li.className = 'p-2 cursor-pointer hover:bg-gray-200';
                        li.dataset.precio = p.precio;
                        li.dataset.stock = p.stock;
                        li.dataset.tipo = p.tipo;
                        li.onclick = () => {
                            document.getElementById('descripcion').value = p.nombreOriginal;
                            document.getElementById('precio').value = p.precio;
                            sugerenciasUl.classList.add('hidden');
                        };
                        sugerenciasUl.appendChild(li);
                    });
                } else {
                    sugerenciasUl.classList.add('hidden');
                }
            } else {
                sugerenciasUl.classList.add('hidden');
            }
        });

        // --- Compras ---
        async function cargarProductosCompra() {
            const select = document.getElementById('productoCompra');
            select.innerHTML = '<option value="">Seleccione un producto</option>';

            const productos = todosLosProductosYServicios.filter(p => p.tipo === 'producto');
            productos.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.nombreOriginal;
                select.appendChild(option);
            });
        }
        
        async function guardarCompra() {
            const fechaCompra = document.getElementById('fechaCompra').value;
            const productoId = document.getElementById('productoCompra').value;
            const cantidad = parseFloat(document.getElementById('cantidadCompra').value);
            const costo = parseFloat(document.getElementById('costoCompra').value);
            const facturaProveedor = document.getElementById('facturaCompra').value;
            const usuario = currentLoggedInUser.nombre;

            if (!fechaCompra || !productoId || isNaN(cantidad) || cantidad <= 0 || isNaN(costo) || costo < 0) {
                alert('Por favor, completa todos los campos de la compra.');
                return;
            }

            try {
                // Registrar la compra en la colecci√≥n 'compras'
                const compra = {
                    productoId: productoId,
                    cantidad: cantidad,
                    costo: costo,
                    facturaProveedor: facturaProveedor,
                    usuario: usuario,
                    fecha: firebase.firestore.Timestamp.fromDate(new Date(fechaCompra)),
                    fechaRegistro: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('compras').add(compra);

                // Agregar nuevo lote al producto en la colecci√≥n 'productosYServicios'
                const productoRef = db.collection('productosYServicios').doc(productoId);
                const fechaVencimiento = document.getElementById('fechaVencimientoProducto').value;
                if (!fechaVencimiento) {
                    alert("Por favor, ingresa la fecha de vencimiento del nuevo lote.");
                    return;
                }
                
                await productoRef.collection('lotes').add({
                    cantidad: cantidad,
                    fechaVencimiento: fechaVencimiento,
                    fechaEntrada: firebase.firestore.FieldValue.serverTimestamp(),
                });

                alert('Compra registrada y stock actualizado exitosamente.');
                document.getElementById('formCompra').reset();
                document.getElementById('usuarioCompra').value = currentLoggedInUser.nombre;
                cargarCompras();
                cargarProductosYServicios();
            } catch (e) {
                console.error("Error al registrar la compra: ", e);
                alert('Ocurri√≥ un error al registrar la compra. Por favor, intenta de nuevo.');
            }
        }
        
        async function cargarCompras() {
            const tbody = document.getElementById('listaComprasTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Cargando...</td></tr>';
            
            let comprasRef = db.collection('compras').orderBy('fecha', 'desc');
            
            const snapshot = await comprasRef.get();
            todasLasCompras = await Promise.all(snapshot.docs.map(async doc => {
                const data = doc.data();
                const productoDoc = await db.collection('productosYServicios').doc(data.productoId).get();
                return {
                    id: doc.id,
                    ...data,
                    productoNombre: productoDoc.exists ? productoDoc.data().nombreOriginal : 'N/A',
                };
            }));
            
            filtrarCompras();
        }

        function filtrarCompras() {
            const anio = document.getElementById('filtroComprasAnio').value;
            const mes = document.getElementById('filtroComprasMes').value;
            const dia = document.getElementById('filtroComprasDia').value;
            const horaInicial = document.getElementById('filtroComprasHoraInicial').value;
            const horaFinal = document.getElementById('filtroComprasHoraFinal').value;
            
            const comprasFiltradas = todasLasCompras.filter(compra => {
                const fecha = compra.fecha ? compra.fecha.toDate() : new Date();
                const compraAnio = fecha.getFullYear().toString();
                const compraMes = (fecha.getMonth() + 1).toString();
                const compraDia = fecha.getDate().toString();
                const compraHora = fecha.toTimeString().slice(0, 5);

                const anioMatch = !anio || compraAnio === anio;
                const mesMatch = !mes || compraMes === mes;
                const diaMatch = !dia || compraDia === dia;
                const horaInicialMatch = !horaInicial || compraHora >= horaInicial;
                const horaFinalMatch = !horaFinal || compraHora <= horaFinal;
                
                return anioMatch && mesMatch && diaMatch && horaInicialMatch && horaFinalMatch;
            });
            
            const tbody = document.getElementById('listaComprasTableBody');
            tbody.innerHTML = '';
            if (comprasFiltradas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No se encontraron compras.</td></tr>';
                return;
            }

            let totalCompra = 0;
            comprasFiltradas.forEach(compra => {
                const totalItem = compra.cantidad * compra.costo;
                totalCompra += totalItem;
                const fecha = compra.fecha ? compra.fecha.toDate().toLocaleDateString('es-ES') : 'N/A';
                const row = document.createElement('tr');
                row.className = 'text-gray-700';
                row.innerHTML = `
                    <td class="px-3 py-2">${fecha}</td>
                    <td class="px-3 py-2">${compra.productoNombre}</td>
                    <td class="px-3 py-2 text-center">${compra.cantidad}</td>
                    <td class="px-3 py-2 text-right">$${compra.costo.toFixed(2)}</td>
                    <td class="px-3 py-2 text-right">$${totalItem.toFixed(2)}</td>
                    <td class="px-3 py-2">${compra.facturaProveedor}</td>
                    <td class="px-3 py-2">${compra.usuario}</td>
                `;
                tbody.appendChild(row);
            });
            document.getElementById('comprasSummaryFooter').innerHTML = `
                <tr class="bg-gray-200 font-bold">
                    <td colspan="4" class="px-3 py-2 text-right">Total Compras:</td>
                    <td class="px-3 py-2 text-right">$${totalCompra.toFixed(2)}</td>
                    <td colspan="2"></td>
                </tr>
            `;
            cargarAniosFiltroCompras(todasLasCompras);
        }

        function cargarAniosFiltroCompras(compras) {
            const selectAnio = document.getElementById('filtroComprasAnio');
            const anios = [...new Set(compras.map(c => (c.fecha ? c.fecha.toDate().getFullYear() : new Date().getFullYear())))].sort().reverse();
            selectAnio.innerHTML = '<option value="">Todos</option>';
            anios.forEach(anio => {
                const option = document.createElement('option');
                option.value = anio;
                option.textContent = anio;
                selectAnio.appendChild(option);
            });
        }
        
        // --- Dashboard ---
        async function cargarDashboardData() {
            await cargarProductosYServicios();
            await cargarFacturas();
            
            // Productos por Vencer
            const expiringProductsList = document.getElementById('expiringProductsList');
            const expiringProducts = todosLosProductosYServicios
                .filter(p => p.tipo === 'producto' && p.fechaVencimiento !== 'N/A')
                .sort((a, b) => new Date(a.fechaVencimiento) - new Date(b.fechaVencimiento))
                .slice(0, 5);
                
            if (expiringProducts.length > 0) {
                expiringProductsList.innerHTML = expiringProducts.map(p => {
                    const hoy = new Date();
                    const fechaVencimiento = new Date(p.fechaVencimiento);
                    const diasRestantes = Math.ceil((fechaVencimiento - hoy) / (1000 * 60 * 60 * 24));
                    return `<li>${p.nombreOriginal} - ${p.stock} unid. (Vence en ${diasRestantes} d√≠as)</li>`;
                }).join('');
            } else {
                expiringProductsList.innerHTML = '<li>No hay productos pr√≥ximos a vencer.</li>';
            }

            // Productos con Mayor Stock
            const topStockProductsList = document.getElementById('topStockProductsList');
            const topStockProducts = todosLosProductosYServicios
                .filter(p => p.tipo === 'producto')
                .sort((a, b) => b.stock - a.stock)
                .slice(0, 5);
            
            if (topStockProducts.length > 0) {
                topStockProductsList.innerHTML = topStockProducts.map(p => `<li>${p.nombreOriginal} - ${p.stock} unidades</li>`).join('');
            } else {
                topStockProductsList.innerHTML = '<li>No hay productos registrados.</li>';
            }

            // Productos M√°s Vendidos y Vendedores con M√°s Ventas
            const ventasPorProducto = {};
            const ventasPorVendedor = {};

            todasLasFacturas.forEach(factura => {
                factura.items.forEach(item => {
                    ventasPorProducto[item.descripcion] = (ventasPorProducto[item.descripcion] || 0) + item.cantidad;
                });
                ventasPorVendedor[factura.vendedor] = (ventasPorVendedor[factura.vendedor] || 0) + factura.total;
            });

            // Productos M√°s Vendidos
            const topSellingProductsList = document.getElementById('topSellingProductsList');
            const sortedProducts = Object.entries(ventasPorProducto).sort(([, a], [, b]) => b - a).slice(0, 5);
            if (sortedProducts.length > 0) {
                topSellingProductsList.innerHTML = sortedProducts.map(([nombre, cantidad]) => `<li>${nombre} - ${cantidad} unid.</li>`).join('');
            } else {
                topSellingProductsList.innerHTML = '<li>No hay ventas registradas.</li>';
            }

            // Vendedores con M√°s Ventas
            const topSellingUsersList = document.getElementById('topSellingUsersList');
            const sortedUsers = Object.entries(ventasPorVendedor).sort(([, a], [, b]) => b - a).slice(0, 5);
            if (sortedUsers.length > 0) {
                topSellingUsersList.innerHTML = sortedUsers.map(([nombre, totalVendido]) => `<li>${nombre} - $${totalVendido.toFixed(2)}</li>`).join('');
            } else {
                topSellingUsersList.innerHTML = '<li>No hay ventas registradas.</li>';
            }
        }

    </script>
</body>
</html>
