<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Sistema de Facturaci√≥n y Compras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
    <style>
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        .sidebar {
            width: 250px;
        }
        .main-content {
            margin-left: 250px;
        }
        .menu-item.active {
            background-color: #3f83f8;
            color: white;
        }
        .expiring-soon {
            background-color: #fbd38d; /* yellow-200 */
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-content, .printable-content * {
                visibility: visible;
            }
            .printable-content {
                position: absolute;
                left: 0;
                top: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex min-h-screen">

    <div id="loginSection" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-3xl font-bold text-center text-teal-600 mb-6">Iniciar Sesi√≥n Fixitech</h2>
            <p id="error" class="text-red-600 mt-4 text-center hidden">Credenciales incorrectas</p>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="usuario" class="block text-gray-700 font-medium mb-2">Usuario:</label>
                    <input type="text" id="usuario" name="usuario" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Ej: admin" required>
                </div>
                 <div class="mb-4">
                    <label for="password" class="block text-gray-700 font-medium mb-2">Contrase√±a:</label>
                    <input type="password" id="password" name="password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Contrase√±a" required>
                </div>
                <button type="button" onclick="login()" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition duration-300">Ingresar</button>
            </form>
        </div>
    </div>

    <div id="sidebar" class="sidebar bg-gray-800 text-white flex-shrink-0 fixed h-full p-4 flex flex-col hidden">
        <h1 class="text-2xl font-bold mb-6 text-center text-teal-400">Sistema de Venta</h1>
        <nav class="flex-grow">
            <ul>
                <li id="menu-dashboard" class="mb-2 hidden">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('dashboardSection')">
                        <span class="mr-2">üìä</span> Dashboard
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 active" onclick="iniciarNuevaVenta()">
                        <span class="mr-2">üí∞</span> Nueva Venta
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('gestionFacturasSection')">
                        <span class="mr-2">üìã</span> Gesti√≥n de Ventas
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('gestionClientesSection')">
                        <span class="mr-2">üßë‚Äçü§ù‚Äçüßë</span> Gesti√≥n de Clientes
                    </a>
                </li>
                <li id="menu-productos" class="mb-2 hidden">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('gestionProductosSection')">
                        <span class="mr-2">üì¶</span> Productos y Servicios
                    </a>
                </li>
                <li id="menu-compras" class="mb-2 hidden">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('gestionComprasSection')">
                        <span class="mr-2">üõí</span> Gesti√≥n de Compras
                    </a>
                </li>
            </ul>
        </nav>
        <div class="mt-auto text-center text-gray-400 text-sm">
            <p>Bienvenido, <span id="userNameDisplay" class="font-bold"></span></p>
            <p>Rol: <span id="userRoleDisplay" class="font-bold"></span></p>
            <button class="mt-2 text-red-400 hover:text-red-300" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <div id="main-content" class="main-content flex-grow p-8 hidden">
        
        <div id="dashboardSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-3xl font-semibold mb-6 text-gray-800">Dashboard de Gerencia üìä</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-blue-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-blue-800 mb-4">Productos con Mayor Stock üì¶</h3>
                    <ul id="topStockProductsList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
                <div class="bg-yellow-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-yellow-800 mb-4">Productos por Vencer ‚è≥</h3>
                    <ul id="expiringProductsList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
                <div class="bg-green-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-green-800 mb-4">Productos M√°s Vendidos üìà</h3>
                    <ul id="topSellingProductsList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
                <div class="bg-purple-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-purple-800 mb-4">Vendedores con M√°s Ventas üèÜ</h3>
                    <ul id="topSellingUsersList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="nuevaVentaSection" class="bg-white rounded-lg shadow-md p-6">
            <h2 id="formFacturaTitle" class="text-2xl font-semibold mb-6 text-gray-800">Datos del Cliente y Nueva Venta</h2>
            
            <form id="formFactura" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-4 mb-4">
                    <div class="relative">
                        <label for="cedulaCliente" class="block text-sm font-medium text-gray-700">C√©dula</label>
                        <input type="text" id="cedulaCliente" placeholder="C√©dula del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" onblur="buscarClientePorCedula()">
                    </div>
                    <div class="relative">
                        <label for="nombreCliente" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="nombreCliente" placeholder="Nombre Completo del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                        <button type="button" onclick="guardarClienteDesdeFactura()" class="absolute right-2 top-8 text-sm bg-gray-200 hover:bg-gray-300 p-1 rounded-md" title="Guardar este cliente">üíæ</button>
                    </div>
                    <div>
                        <label for="telefono" class="block text-sm font-medium text-gray-700">Tel√©fono</label>
                        <input type="text" id="telefono" placeholder="N√∫mero de Tel√©fono" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="direccion" class="block text-sm font-medium text-gray-700">Direcci√≥n</label>
                        <input type="text" id="direccion" placeholder="Direcci√≥n del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-1 relative">
                        <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripci√≥n</label>
                        <input type="text" id="descripcion" placeholder="Descripci√≥n del Art√≠culo/Servicio" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" />
                        <ul id="sugerencias" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-48 overflow-y-auto hidden"></ul>
                    </div>
                    <div class="md:col-span-1">
                        <label for="cantidad" class="block text-sm font-medium text-gray-700">Cantidad</label>
                        <input type="number" id="cantidad" value="1" min="1" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div class="md:col-span-1">
                        <label for="precio" class="block text-sm font-medium text-gray-700">Precio Unitario</label>
                        <input type="number" id="precio" placeholder="Precio" step="0.01" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div class="md:col-span-1 flex items-end">
                        <button type="button" onclick="agregarItem()" class="w-full bg-teal-500 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-600 transition duration-200">
                            + Agregar √çtem
                        </button>
                    </div>
                </div>
            </form>

            <div class="mt-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">√çtems de la Venta</h3>
                <div class="bg-gray-50 rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripci√≥n</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unitario</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="tablaItems" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        <tfoot>
                            <tr class="bg-gray-100">
                                <td colspan="3" class="px-3 py-2 text-right font-bold text-lg text-gray-800">Total:</td>
                                <td colspan="2" class="px-3 py-2 text-right font-bold text-lg text-gray-800" id="total">$0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
            <div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="fechaIngreso" class="block text-sm font-medium text-gray-700">Fecha de Ingreso</label>
                    <input type="date" id="fechaIngreso" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="fechaEntrega" class="block text-sm font-medium text-gray-700">Fecha de Entrega</label>
                    <input type="date" id="fechaEntrega" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="estado" class="block text-sm font-medium text-gray-700">Estado</label>
                    <select id="estado" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                        <option value="En espera">En espera</option>
                        <option value="Facturado">Facturado</option>
                        <option value="Entregado">Entregado</option>
                    </select>
                </div>
                <div>
                    <label for="vendedor" class="block text-sm font-medium text-gray-700">Vendedor</label>
                    <input type="text" id="vendedor" class="mt-1 p-2 block w-full border border-gray-300 rounded-md bg-gray-200" readonly>
                </div>
            </div>
            
            <div class="flex justify-end space-x-4 mt-8">
                <button type="button" onclick="mostrarFactura()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                    üîç Previsualizar
                </button>
                <button type="button" id="guardarFacturaBtn" onclick="guardarFactura()" class="bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition duration-200">
                    üíæ Guardar Venta
                </button>
            </div>
        </div>

        <div id="gestionFacturasSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Ventas</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div>
                    <label for="filtroVentasAnio" class="block text-sm font-medium text-gray-700">A√±o</label>
                    <select id="filtroVentasAnio" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div>
                    <label for="filtroVentasMes" class="block text-sm font-medium text-gray-700">Mes</label>
                    <select id="filtroVentasMes" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                        <option value="">Todos</option>
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div>
                    <label for="filtroVentasHoraInicial" class="block text-sm font-medium text-gray-700">Hora Inicial</label>
                    <input type="time" id="filtroVentasHoraInicial" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="filtroVentasHoraFinal" class="block text-sm font-medium text-gray-700">Hora Final</label>
                    <input type="time" id="filtroVentasHoraFinal" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N¬∞ Factura</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendedor</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaFacturasTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="gestionClientesSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Clientes</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="filtroClienteNombre" class="block text-sm font-medium text-gray-700">Buscar por Nombre o C√©dula</label>
                    <input type="text" id="filtroClienteNombre" oninput="filtrarClientes()" placeholder="Ej: Ana L√≥pez" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√©dula</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tel√©fono</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Direcci√≥n</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaClientesTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div id="gestionProductosSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 id="formProductoServicioTitle" class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Productos y Servicios</h2>
            
            <form id="formProductoServicio" class="space-y-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label for="nombreProducto" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="nombreProducto" placeholder="Nombre del Producto/Servicio" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="tipoProducto" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="tipoProducto" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" onchange="toggleStockInput()">
                            <option value="producto">Producto</option>
                            <option value="servicio">Servicio</option>
                        </select>
                    </div>
                    <div>
                        <label for="precioProducto" class="block text-sm font-medium text-gray-700">Precio de Venta</label>
                        <input type="number" id="precioProducto" placeholder="Precio" step="0.01" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div id="stockInputDiv">
                        <label for="stockProducto" class="block text-sm font-medium text-gray-700">Stock Inicial</label>
                        <input type="number" id="stockProducto" value="0" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="fechaVencimientoProducto" class="block text-sm font-medium text-gray-700">Fecha de Vencimiento</label>
                        <input type="date" id="fechaVencimientoProducto" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                <div class="flex justify-end">
                    <button type="button" id="guardarProductoBtn" onclick="guardarProductoServicio()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                        üíæ Guardar Producto/Servicio
                    </button>
                </div>
            </form>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vencimiento</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaProductosTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="gestionComprasSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Compras</h2>
            
            <form id="formCompra" class="space-y-4 mb-6">
                <h3 class="text-xl font-semibold mb-2">Registrar Nueva Compra</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label for="fechaCompra" class="block text-sm font-medium text-gray-700">Fecha</label>
                        <input type="date" id="fechaCompra" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="productoCompra" class="block text-sm font-medium text-gray-700">Producto</label>
                        <select id="productoCompra" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                            </select>
                    </div>
                    <div>
                        <label for="cantidadCompra" class="block text-sm font-medium text-gray-700">Cantidad</label>
                        <input type="number" id="cantidadCompra" value="1" min="1" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="costoCompra" class="block text-sm font-medium text-gray-700">Costo Unitario</label>
                        <input type="number" id="costoCompra" placeholder="Costo" step="0.01" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="fechaVencimientoCompra" class="block text-sm font-medium text-gray-700">Fecha de Vencimiento del Lote</label>
                        <input type="date" id="fechaVencimientoCompra" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="usuarioCompra" class="block text-sm font-medium text-gray-700">Registrado por</label>
                        <input type="text" id="usuarioCompra" class="mt-1 p-2 block w-full border border-gray-300 rounded-md bg-gray-200" readonly>
                    </div>
                    <div class="flex items-end justify-end">
                        <button type="button" onclick="guardarCompra()" class="bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition duration-200">
                            üíæ Registrar Compra
                        </button>
                    </div>
                </div>
            </form>
            
            <h3 class="text-xl font-semibold mb-4">Historial de Compras</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                <div>
                    <label for="filtroComprasAnio" class="block text-sm font-medium text-gray-700">A√±o</label>
                    <select id="filtroComprasAnio" onchange="filtrarCompras()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div>
                    <label for="filtroComprasMes" class="block text-sm font-medium text-gray-700">Mes</label>
                    <select id="filtroComprasMes" onchange="filtrarCompras()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                        <option value="">Todos</option>
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div>
                    <label for="filtroComprasDia" class="block text-sm font-medium text-gray-700">D√≠a</label>
                    <input type="number" id="filtroComprasDia" onchange="filtrarCompras()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="filtroComprasHoraInicial" class="block text-sm font-medium text-gray-700">Hora Inicial</label>
                    <input type="time" id="filtroComprasHoraInicial" onchange="filtrarCompras()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="filtroComprasHoraFinal" class="block text-sm font-medium text-gray-700">Hora Final</label>
                    <input type="time" id="filtroComprasHoraFinal" onchange="filtrarCompras()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Costo Unit.</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Factura</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                        </tr>
                    </thead>
                    <tbody id="listaComprasTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    <tfoot id="comprasSummaryFooter">
                    </tfoot>
                </table>
            </div>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
    <script src="firebase.js"></script>
    <script>
        const db = firebase.firestore();
        let items = [];
        let todasLasFacturas = [];
        let facturaEnEdicionId = null;
        let todaLaInformacionFacturaEnEdicion = null;
        let todosLosClientes = [];
        let todosLosProductosYServicios = [];
        let productoServicioEnEdicionId = null;
        let todasLasCompras = [];
        let currentLoggedInUser = null;
        
        window.onload = async () => {
            // Este bloque se mantiene, pero las llamadas importantes se movieron a login()
        };

        async function login() {
            const usuario = document.getElementById('usuario').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('error');
            const doc = await db.collection('usuarios').doc(usuario).get();
            if (doc.exists && doc.data().password === password) {
                errorElement.classList.add('hidden');
                currentLoggedInUser = {
                    username: usuario,
                    rol: doc.data().rol,
                    nombre: doc.data().nombre,
                };
                
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('userNameDisplay').textContent = currentLoggedInUser.nombre;
                document.getElementById('userRoleDisplay').textContent = currentLoggedInUser.rol.toUpperCase();

                if (currentLoggedInUser.rol === 'admin') {
                    document.getElementById('menu-dashboard').classList.remove('hidden');
                    document.getElementById('menu-productos').classList.remove('hidden');
                    document.getElementById('menu-compras').classList.remove('hidden');
                    mostrarSeccion('dashboardSection');
                } else {
                    document.getElementById('menu-dashboard').classList.add('hidden');
                    document.getElementById('menu-productos').classList.add('hidden');
                    document.getElementById('menu-compras').classList.add('hidden');
                    iniciarNuevaVenta();
                }
                document.getElementById('vendedor').value = currentLoggedInUser.nombre;
                document.getElementById('usuarioCompra').value = currentLoggedInUser.nombre;
                
                await cargarClientes();
                await cargarProductosYServicios();
            } else {
                errorElement.classList.remove('hidden');
            }
        }

        function logout() {
            currentLoggedInUser = null;
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('loginForm').reset();
            items = [];
            actualizarTablaItems();
        }

        // [INICIO DE MODIFICACI√ìN]
        // Se a√±ade una nueva funci√≥n para iniciar una venta desde cero.
        function iniciarNuevaVenta() {
            resetFormFactura();
            mostrarSeccion('nuevaVentaSection');
        }

        // Se elimina la llamada a resetFormFactura() para que el formulario no se borre al editar.
        function mostrarSeccion(seccionId) {
            document.querySelectorAll('#main-content > div').forEach(div => {
                div.classList.add('hidden');
            });
            document.getElementById(seccionId).classList.remove('hidden');

            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[onclick*="mostrarSeccion('${seccionId}')"]`).classList.add('active');

            if (seccionId === 'gestionFacturasSection') {
                cargarFacturas();
            } else if (seccionId === 'gestionClientesSection') {
                cargarClientes();
            } else if (seccionId === 'gestionProductosSection') {
                cargarProductosYServicios();
            } else if (seccionId === 'gestionComprasSection') {
                cargarProductosCompra();
                cargarCompras();
            } else if (seccionId === 'dashboardSection') {
                cargarDashboardData();
            }
        }
        // [FIN DE MODIFICACI√ìN]

        function resetFormFactura() {
            document.getElementById('formFactura').reset();
            document.getElementById('cedulaCliente').value = '';
            document.getElementById('nombreCliente').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('direccion').value = '';
            document.getElementById('descripcion').value = '';
            document.getElementById('cantidad').value = '1';
            document.getElementById('precio').value = '';
            document.getElementById('fechaIngreso').valueAsDate = new Date();
            document.getElementById('fechaEntrega').valueAsDate = new Date();
            document.getElementById('vendedor').value = currentLoggedInUser.nombre;
            facturaEnEdicionId = null;
            todaLaInformacionFacturaEnEdicion = null;
            document.getElementById('formFacturaTitle').textContent = 'Datos del Cliente y Nueva Venta';
            document.getElementById('guardarFacturaBtn').textContent = 'üíæ Guardar Venta';
            items = []; // Se asegura de que la lista de √≠tems est√© vac√≠a
            actualizarTablaItems();
        }

        function agregarItem() {
            const descripcion = document.getElementById('descripcion').value.trim();
            const cantidad = parseFloat(document.getElementById('cantidad').value);
            const precio = parseFloat(document.getElementById('precio').value);
            const stockSugerencia = document.querySelector('#sugerencias li.selected')?.dataset.stock || null;

            if (descripcion === '' || isNaN(cantidad) || cantidad <= 0 || isNaN(precio) || precio < 0) {
                alert('Por favor, ingresa una descripci√≥n, cantidad y precio v√°lidos.');
                return;
            }

            // [INICIO DE MODIFICACI√ìN]
            // Se elimina la verificaci√≥n de stock para permitir vender productos incluso con stock bajo o agotado.
            // La l√≥gica de decremento de stock se mantiene en la funci√≥n guardarFactura().
            // const productoSeleccionado = todosLosProductosYServicios.find(p => p.nombre.toLowerCase() === descripcion.toLowerCase());
            // if (productoSeleccionado && productoSeleccionado.tipo === 'producto' && !facturaEnEdicionId) {
            //     const stockTotal = productoSeleccionado.stock;
            //     const cantidadEnCarrito = items.filter(item => item.descripcion.toLowerCase() === descripcion.toLowerCase()).reduce((acc, item) => acc + item.cantidad, 0);
            //     if ((cantidad + cantidadEnCarrito) > stockTotal) {
            //         alert(`No hay suficiente stock para el producto "${descripcion}". Stock disponible: ${stockTotal}`);
            //         return;
            //     }
            // }
            // [FIN DE MODIFICACI√ìN]

            const itemExistente = items.find(item => item.descripcion.toLowerCase() === descripcion.toLowerCase());
            if (itemExistente) {
                itemExistente.cantidad += cantidad;
                itemExistente.subtotal = itemExistente.cantidad * itemExistente.precio;
            } else {
                items.push({
                    descripcion,
                    cantidad,
                    precio,
                    subtotal: cantidad * precio,
                });
            }

            actualizarTablaItems();
            document.getElementById('descripcion').value = '';
            document.getElementById('cantidad').value = '1';
            document.getElementById('precio').value = '';
            document.getElementById('descripcion').focus();
        }

        function actualizarTablaItems() {
            const tabla = document.getElementById('tablaItems');
            const totalElement = document.getElementById('total');
            tabla.innerHTML = '';
            let total = 0;

            items.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'text-gray-700';
                row.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap">${item.descripcion}</td>
                    <td class="px-3 py-2 text-center">${item.cantidad}</td>
                    <td class="px-3 py-2 text-right">$${item.precio.toFixed(2)}</td>
                    <td class="px-3 py-2 text-right">$${item.subtotal.toFixed(2)}</td>
                    <td class="px-3 py-2 text-center">
                        <button type="button" onclick="eliminarItem(${index})" class="text-red-500 hover:text-red-700">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
                tabla.appendChild(row);
                total += item.subtotal;
            });
            totalElement.textContent = `$${total.toFixed(2)}`;
        }

        function eliminarItem(index) {
            items.splice(index, 1);
            actualizarTablaItems();
        }

        async function guardarFactura() {
            if (items.length === 0) {
                alert('La venta no puede estar vac√≠a.');
                return;
            }

            const cedulaCliente = document.getElementById('cedulaCliente').value.trim();
            const nombreCliente = document.getElementById('nombreCliente').value.trim() || 'Consumidor Final';
            const telefono = document.getElementById('telefono').value.trim();
            const direccion = document.getElementById('direccion').value.trim();
            const fechaIngreso = document.getElementById('fechaIngreso').value;
            const fechaEntrega = document.getElementById('fechaEntrega').value;
            const estado = document.getElementById('estado').value;
            const vendedor = currentLoggedInUser.nombre;
            const total = parseFloat(document.getElementById('total').textContent.replace('$', ''));

            try {
                let docId;
                let numeroFactura;
                let facturaData;

                if (facturaEnEdicionId) {
                    if (todaLaInformacionFacturaEnEdicion.estado !== 'En espera' && todaLaInformacionFacturaEnEdicion.estado !== 'Entregado') {
                        alert('No se puede editar una factura con estado "Facturado".');
                        return;
                    }
                    docId = facturaEnEdicionId;
                    numeroFactura = todaLaInformacionFacturaEnEdicion.numeroFactura;
                    
                    const oldItems = todaLaInformacionFacturaEnEdicion.items;
                    const newItems = items;
                    
                    for (const oldItem of oldItems) {
                        const productoRef = db.collection('productosYServicios').where('nombreOriginal', '==', oldItem.descripcion).limit(1);
                        const snapshot = await productoRef.get();
                        if (!snapshot.empty && snapshot.docs[0].data().tipo === 'producto') {
                            const productoDoc = snapshot.docs[0];
                            const productoId = productoDoc.id;
                            const lotesRef = db.collection('productosYServicios').doc(productoId).collection('lotes');
                            const ultimoLoteSnapshot = await lotesRef.orderBy('fechaEntrada', 'desc').limit(1).get();
                            if (!ultimoLoteSnapshot.empty) {
                                const ultimoLoteDoc = ultimoLoteSnapshot.docs[0];
                                await ultimoLoteDoc.ref.update({ cantidad: firebase.firestore.FieldValue.increment(oldItem.cantidad) });
                            }
                        }
                    }

                    for (const newItem of newItems) {
                        const productoRef = db.collection('productosYServicios').where('nombreOriginal', '==', newItem.descripcion).limit(1);
                        const snapshot = await productoRef.get();
                        if (!snapshot.empty && snapshot.docs[0].data().tipo === 'producto') {
                            const productoDoc = snapshot.docs[0];
                            const productoId = productoDoc.id;
                            const lotesRef = db.collection('productosYServicios').doc(productoId).collection('lotes');
                            const lotesSnapshot = await lotesRef.orderBy('fechaVencimiento').get();
                            let cantidadPendiente = newItem.cantidad;
                            
                            for (const loteDoc of lotesSnapshot.docs) {
                                const loteData = loteDoc.data();
                                if (cantidadPendiente > 0 && loteData.cantidad > 0) {
                                    const cantidadADeducir = Math.min(cantidadPendiente, loteData.cantidad);
                                    await loteDoc.ref.update({ cantidad: loteData.cantidad - cantidadADeducir });
                                    cantidadPendiente -= cantidadADeducir;
                                }
                            }
                        }
                    }

                    facturaData = {
                        cliente: {
                            cedula: cedulaCliente,
                            nombre: nombreCliente,
                            telefono: telefono,
                            direccion: direccion,
                        },
                        items: items,
                        total: total,
                        fechaIngreso: fechaIngreso,
                        fechaEntrega: fechaEntrega,
                        estado: estado,
                        vendedor: vendedor,
                        ultimaActualizacion: firebase.firestore.FieldValue.serverTimestamp(),
                        numeroFactura: numeroFactura
                    };
                    await db.collection('facturas').doc(docId).update(facturaData);
                    alert('Factura actualizada exitosamente.');
                } else {
                    const counterRef = db.collection('config').doc('factura_counter');
                    await db.runTransaction(async (transaction) => {
                        const counterDoc = await transaction.get(counterRef);
                        const newCounter = counterDoc.data().currentValue + 1;
                        transaction.update(counterRef, { currentValue: newCounter });
                        numeroFactura = newCounter;
                        
                        for (const item of items) {
                            const productoSeleccionado = todosLosProductosYServicios.find(p => p.nombreOriginal.toLowerCase() === item.descripcion.toLowerCase());
                            if (productoSeleccionado && productoSeleccionado.tipo === 'producto') {
                                const lotesRef = db.collection('productosYServicios').doc(productoSeleccionado.id).collection('lotes');
                                const lotesSnapshot = await lotesRef.orderBy('fechaVencimiento').get();
                                let cantidadPendiente = item.cantidad;
                                
                                for (const loteDoc of lotesSnapshot.docs) {
                                    const loteData = loteDoc.data();
                                    if (cantidadPendiente > 0 && loteData.cantidad > 0) {
                                        const cantidadADeducir = Math.min(cantidadPendiente, loteData.cantidad);
                                        const nuevoStockLote = loteData.cantidad - cantidadADeducir;
                                        if (nuevoStockLote === 0) {
                                            transaction.delete(loteDoc.ref);
                                        } else {
                                            transaction.update(loteDoc.ref, { cantidad: nuevoStockLote });
                                        }
                                        cantidadPendiente -= cantidadADeducir;
                                    }
                                }
                                // [INICIO DE MODIFICACI√ìN]
                                // Se elimina la validaci√≥n que imped√≠a vender si no hab√≠a suficiente stock.
                                // if (cantidadPendiente > 0) {
                                //     throw new Error(`No hay suficiente stock disponible para el producto "${item.descripcion}".`);
                                // }
                                // [FIN DE MODIFICACI√ìN]
                                await db.collection('productosYServicios').doc(productoSeleccionado.id).update({ stock: firebase.firestore.FieldValue.increment(-item.cantidad) });
                            }
                        }

                        facturaData = {
                            numeroFactura: numeroFactura,
                            cliente: {
                                cedula: cedulaCliente,
                                nombre: nombreCliente,
                                telefono: telefono,
                                direccion: direccion,
                            },
                            items: items,
                            total: total,
                            fechaIngreso: fechaIngreso,
                            fechaEntrega: fechaEntrega,
                            estado: estado,
                            vendedor: vendedor,
                            fechaCreacion: firebase.firestore.FieldValue.serverTimestamp(),
                        };
                        const docRef = db.collection('facturas').doc();
                        transaction.set(docRef, facturaData);
                        docId = docRef.id;
                    });
                    alert('Factura guardada exitosamente.');
                    generarPDF(docId, false, facturaData);
                }
                
                resetFormFactura();
                cargarFacturas();
                cargarProductosYServicios();
            } catch (e) {
                console.error("Error al guardar la factura: ", e);
                alert('Ocurri√≥ un error al guardar la factura. Por favor, intenta de nuevo.');
            }
        }

        async function cargarFacturas() {
            const tbody = document.getElementById('listaFacturasTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Cargando...</td></tr>';
            
            let facturasRef = db.collection('facturas').orderBy('fechaCreacion', 'desc');
            
            const snapshot = await facturasRef.get();
            todasLasFacturas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            filtrarFacturas();
        }

        function filtrarFacturas() {
            const anio = document.getElementById('filtroVentasAnio').value;
            const mes = document.getElementById('filtroVentasMes').value;
            const horaInicial = document.getElementById('filtroVentasHoraInicial').value;
            const horaFinal = document.getElementById('filtroVentasHoraFinal').value;
            
            const facturasFiltradas = todasLasFacturas.filter(factura => {
                const fecha = factura.fechaCreacion ? factura.fechaCreacion.toDate() : new Date();
                const facturaAnio = fecha.getFullYear().toString();
                const facturaMes = (fecha.getMonth() + 1).toString();
                const facturaHora = fecha.toTimeString().slice(0, 5);

                const anioMatch = !anio || facturaAnio === anio;
                const mesMatch = !mes || facturaMes === mes;
                const horaInicialMatch = !horaInicial || facturaHora >= horaInicial;
                const horaFinalMatch = !horaFinal || facturaHora <= horaFinal;
                
                return anioMatch && mesMatch && horaInicialMatch && horaFinalMatch;
            });

            const tbody = document.getElementById('listaFacturasTableBody');
            tbody.innerHTML = '';
            if (facturasFiltradas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No se encontraron facturas.</td></tr>';
                return;
            }

            facturasFiltradas.forEach(factura => {
                const fecha = factura.fechaCreacion ? factura.fechaCreacion.toDate().toLocaleDateString('es-ES') : 'N/A';
                const row = document.createElement('tr');
                row.className = 'text-gray-700';
                row.innerHTML = `
                    <td class="px-3 py-2">${(factura.numeroFactura || factura.id).toString().padStart(8, '0')}</td>
                    <td class="px-3 py-2">${factura.cliente.nombre}</td>
                    <td class="px-3 py-2 text-right">$${factura.total.toFixed(2)}</td>
                    <td class="px-3 py-2">${factura.vendedor}</td>
                    <td class="px-3 py-2">${factura.estado}</td>
                    <td class="px-3 py-2">${fecha}</td>
                    <td class="px-3 py-2 text-center">
                        <button onclick="editarFactura('${factura.id}')" class="text-blue-500 hover:text-blue-700 mx-1">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="eliminarFactura('${factura.id}')" class="text-red-500 hover:text-red-700 mx-1">
                            üóëÔ∏è
                        </button>
                        <button onclick="generarPDF('${factura.id}')" class="text-green-500 hover:text-green-700 mx-1">
                            üìÑ
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            cargarAniosFiltro(todasLasFacturas);
        }

        function cargarAniosFiltro(facturas) {
            const selectAnio = document.getElementById('filtroVentasAnio');
            const anios = [...new Set(facturas.map(f => (f.fechaCreacion ? f.fechaCreacion.toDate().getFullYear() : new Date().getFullYear())))].sort().reverse();
            selectAnio.innerHTML = '<option value="">Todos</option>';
            anios.forEach(anio => {
                const option = document.createElement('option');
                option.value = anio;
                option.textContent = anio;
                selectAnio.appendChild(option);
            });
        }

        async function editarFactura(id) {
            const factura = todasLasFacturas.find(f => f.id === id);
            if (!factura) {
                alert('Factura no encontrada.');
                return;
            }
            if (factura.estado !== 'En espera' && factura.estado !== 'Entregado') {
                alert('Solo se pueden editar facturas con estado "En espera" o "Entregado".');
                return;
            }
            
            facturaEnEdicionId = id;
            todaLaInformacionFacturaEnEdicion = factura;

            document.getElementById('cedulaCliente').value = factura.cliente.cedula || '';
            document.getElementById('nombreCliente').value = factura.cliente.nombre || 'Consumidor Final';
            document.getElementById('telefono').value = factura.cliente.telefono || '';
            document.getElementById('direccion').value = factura.cliente.direccion || '';
            document.getElementById('fechaIngreso').value = factura.fechaIngreso || '';
            document.getElementById('fechaEntrega').value = factura.fechaEntrega || '';
            document.getElementById('estado').value = factura.estado || '';
            document.getElementById('vendedor').value = factura.vendedor || '';

            items = factura.items || [];
            actualizarTablaItems();

            document.getElementById('formFacturaTitle').textContent = `Editar Venta #${(factura.numeroFactura || factura.id).toString().padStart(8, '0')}...`;
            document.getElementById('guardarFacturaBtn').textContent = 'üîÑ Actualizar Venta';
            mostrarSeccion('nuevaVentaSection');
        }

        async function eliminarFactura(id) {
            const factura = todasLasFacturas.find(f => f.id === id);
            if (!factura) {
                alert('Factura no encontrada.');
                return;
            }
            if (factura.estado !== 'En espera' && factura.estado !== 'Entregado') {
                alert('Solo se pueden eliminar facturas con estado "En espera" o "Entregado".');
                return;
            }
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta factura? Esta acci√≥n no se puede deshacer.')) {
                try {
                    const facturaRef = db.collection('facturas').doc(id);
                    const facturaDoc = await facturaRef.get();
                    const facturaData = facturaDoc.data();
                    
                    for (const item of facturaData.items) {
                        const productoRef = db.collection('productosYServicios').where('nombreOriginal', '==', item.descripcion).limit(1);
                        const snapshot = await productoRef.get();
                        if (!snapshot.empty && snapshot.docs[0].data().tipo === 'producto') {
                            const productoDoc = snapshot.docs[0];
                            const lotesRef = db.collection('productosYServicios').doc(productoDoc.id).collection('lotes');
                            const lotesSnapshot = await lotesRef.get();
                            
                            let cantidadADevolver = item.cantidad;
                            
                            const ultimoLoteSnapshot = await lotesRef.orderBy('fechaEntrada', 'desc').limit(1).get();
                            if (!ultimoLoteSnapshot.empty) {
                                const ultimoLoteDoc = ultimoLoteSnapshot.docs[0];
                                const ultimoLoteData = ultimoLoteDoc.data();
                                await ultimoLoteDoc.ref.update({ cantidad: ultimoLoteData.cantidad + cantidadADevolver });
                            } else {
                                await lotesRef.add({ cantidad: cantidadADevolver, fechaVencimiento: '2099-12-31', fechaEntrada: firebase.firestore.FieldValue.serverTimestamp() });
                            }
                            await db.collection('productosYServicios').doc(productoDoc.id).update({ stock: firebase.firestore.FieldValue.increment(item.cantidad) });
                        }
                    }

                    await facturaRef.delete();
                    alert('Factura eliminada correctamente.');
                    cargarFacturas();
                    cargarProductosYServicios();
                } catch (e) {
                    console.error("Error al eliminar la factura: ", e);
                    alert('Ocurri√≥ un error al eliminar la factura. Por favor, intenta de nuevo.');
                }
            }
        }

        async function mostrarFactura() {
            const factura = {
                numeroFactura: "PREVIEW",
                cliente: {
                    cedula: document.getElementById('cedulaCliente').value.trim(),
                    nombre: document.getElementById('nombreCliente').value.trim() || 'Consumidor Final',
                    telefono: document.getElementById('telefono').value.trim(),
                    direccion: document.getElementById('direccion').value.trim(),
                },
                items: items,
                total: parseFloat(document.getElementById('total').textContent.replace('$', '')),
                fechaCreacion: new Date(),
                estado: document.getElementById('estado').value,
                vendedor: document.getElementById('vendedor').value,
            };
            generarPDF(null, true, factura);
        }

        async function generarPDF(id, isPreview = false, facturaData = null) {
            let factura;
            if (isPreview) {
                factura = facturaData;
            } else {
                const doc = await db.collection('facturas').doc(id).get();
                if (!doc.exists) {
                    alert('Factura no encontrada.');
                    return;
                }
                factura = { id: doc.id, ...doc.data() };
                factura.fechaCreacion = factura.fechaCreacion.toDate();
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(22);
            doc.text("Factura de Venta", 105, 20, null, null, "center");

            doc.setFontSize(12);
            doc.text(`N¬∞ Factura: ${ (factura.numeroFactura || factura.id).toString().padStart(8, '0')}`, 14, 35);
            doc.text(`Fecha: ${factura.fechaCreacion.toLocaleDateString('es-ES')}`, 14, 42);
            doc.text(`Vendedor: ${factura.vendedor}`, 14, 49);

            doc.setFontSize(14);
            doc.text("Datos del Cliente", 14, 60);
            doc.line(14, 61, 196, 61);
            doc.setFontSize(12);
            doc.text(`Nombre: ${factura.cliente.nombre}`, 14, 68);
            if (factura.cliente.cedula) doc.text(`C√©dula: ${factura.cliente.cedula}`, 14, 75);
            if (factura.cliente.telefono) doc.text(`Tel√©fono: ${factura.cliente.telefono}`, 14, 82);
            if (factura.cliente.direccion) doc.text(`Direcci√≥n: ${factura.cliente.direccion}`, 14, 89);
            
            const tableColumn = ["Descripci√≥n", "Cantidad", "Precio Unitario", "Subtotal"];
            const tableRows = factura.items.map(item => [
                item.descripcion,
                item.cantidad,
                `$${item.precio.toFixed(2)}`,
                `$${item.subtotal.toFixed(2)}`
            ]);

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 100,
                theme: 'grid',
                styles: {
                    font: 'helvetica',
                    fontSize: 10,
                    cellPadding: 3
                },
                headStyles: {
                    fillColor: [44, 62, 80]
                },
                didDrawPage: function(data) {
                    doc.setFontSize(10);
                    doc.text("Fixitech | Sistema de Facturaci√≥n", data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

            const finalY = doc.autoTable.previous.finalY;
            doc.setFontSize(14);
            doc.text(`Total: $${factura.total.toFixed(2)}`, 196, finalY + 15, null, null, "right");

            window.open(doc.output('dataurlnewwindow'));
        }
        
        async function guardarCompra() {
            const fechaCompra = document.getElementById('fechaCompra').value;
            const productoCompra = document.getElementById('productoCompra').value;
            const cantidadCompra = parseFloat(document.getElementById('cantidadCompra').value);
            const costoCompra = parseFloat(document.getElementById('costoCompra').value);
            const facturaCompra = document.getElementById('facturaCompra').value.trim();
            const usuarioCompra = document.getElementById('usuarioCompra').value;
            
            const fechaVencimientoCompra = document.getElementById('fechaVencimientoCompra').value;

            if (!fechaCompra || !productoCompra || isNaN(cantidadCompra) || cantidadCompra <= 0 || isNaN(costoCompra) || costoCompra < 0 || !facturaCompra) {
                alert('Por favor, completa todos los campos requeridos para la compra.');
                return;
            }

            try {
                await db.collection('compras').add({
                    fecha: fechaCompra,
                    producto: productoCompra,
                    cantidad: cantidadCompra,
                    costoUnitario: costoCompra,
                    total: cantidadCompra * costoCompra,
                    facturaProveedor: facturaCompra,
                    usuario: usuarioCompra,
                    fechaRegistro: firebase.firestore.FieldValue.serverTimestamp()
                });

                const productoRef = db.collection('productosYServicios').doc(productoCompra);
                const productoDoc = await productoRef.get();
                if (productoDoc.exists) {
                    const productoData = productoDoc.data();
                    const nuevoStock = (productoData.stock || 0) + cantidadCompra;
                    await productoRef.update({ stock: nuevoStock });
                    
                    if (productoData.tipo === 'producto' && fechaVencimientoCompra) {
                        const lotesRef = productoRef.collection('lotes');
                        await lotesRef.add({
                            cantidad: cantidadCompra,
                            fechaVencimiento: fechaVencimientoCompra,
                            fechaEntrada: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
                
                alert('Compra registrada exitosamente.');
                document.getElementById('formCompra').reset();
                document.getElementById('usuarioCompra').value = currentLoggedInUser.nombre;
                cargarProductosCompra();
                cargarCompras();
            } catch (e) {
                console.error("Error al registrar la compra: ", e);
                alert('Ocurri√≥ un error al registrar la compra. Por favor, intenta de nuevo.');
            }
        }

        async function cargarClientes() {
            const tbody = document.getElementById('listaClientesTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Cargando...</td></tr>';
            
            const snapshot = await db.collection('clientes').get();
            todosLosClientes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            filtrarClientes();
        }

        function buscarClientePorCedula() {
            const cedula = document.getElementById('cedulaCliente').value.trim();
            const cliente = todosLosClientes.find(c => c.cedula === cedula);
            if (cliente) {
                document.getElementById('nombreCliente').value = cliente.nombre;
                document.getElementById('telefono').value = cliente.telefono;
                document.getElementById('direccion').value = cliente.direccion;
            } else {
                document.getElementById('nombreCliente').value = '';
                document.getElementById('telefono').value = '';
                document.getElementById('direccion').value = '';
            }
        }
        
        async function guardarClienteDesdeFactura() {
            const cedula = document.getElementById('cedulaCliente').value.trim();
            const nombre = document.getElementById('nombreCliente').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const direccion = document.getElementById('direccion').value.trim();

            if (!cedula || !nombre) {
                alert('C√©dula y Nombre son campos obligatorios para guardar un cliente.');
                return;
            }
            try {
                await db.collection('clientes').doc(cedula).set({
                    nombre,
                    telefono,
                    direccion,
                    ultimaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('Cliente guardado exitosamente.');
                await cargarClientes();
            } catch (e) {
                console.error("Error al guardar cliente: ", e);
                alert('Ocurri√≥ un error al guardar el cliente.');
            }
        }

        function filtrarClientes() {
            const filtro = document.getElementById('filtroClienteNombre').value.toLowerCase();
            const clientesFiltrados = todosLosClientes.filter(c =>
                c.nombre.toLowerCase().includes(filtro) || (c.cedula && c.cedula.toLowerCase().includes(filtro))
            );

            const tbody = document.getElementById('listaClientesTableBody');
            tbody.innerHTML = '';
            if (clientesFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No se encontraron clientes.</td></tr>';
                return;
            }
            clientesFiltrados.forEach(cliente => {
                const row = document.createElement('tr');
                row.className = 'text-gray-700';
                row.innerHTML = `
                    <td class="px-3 py-2">${cliente.cedula || 'N/A'}</td>
                    <td class="px-3 py-2">${cliente.nombre || 'N/A'}</td>
                    <td class="px-3 py-2">${cliente.telefono || 'N/A'}</td>
                    <td class="px-3 py-2">${cliente.direccion || 'N/A'}</td>
                    <td class="px-3 py-2 text-center">
                        <button onclick="editarCliente('${cliente.id}')" class="text-blue-500 hover:text-blue-700 mx-1">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="eliminarCliente('${cliente.id}')" class="text-red-500 hover:text-red-700 mx-1">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function editarCliente(id) {
            const cliente = todosLosClientes.find(c => c.id === id);
            if (cliente) {
                document.getElementById('cedulaCliente').value = cliente.cedula;
                document.getElementById('nombreCliente').value = cliente.nombre;
                document.getElementById('telefono').value = cliente.telefono;
                document.getElementById('direccion').value = cliente.direccion;
                mostrarSeccion('nuevaVentaSection');
                alert('Cliente cargado en el formulario de Nueva Venta. Puedes editarlo y guardarlo.');
            }
        }
        
        async function eliminarCliente(id) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este cliente?')) {
                try {
                    await db.collection('clientes').doc(id).delete();
                    alert('Cliente eliminado correctamente.');
                    cargarClientes();
                } catch (e) {
                    console.error("Error al eliminar cliente: ", e);
                    alert('Ocurri√≥ un error al eliminar el cliente.');
                }
            }
        }

        function toggleStockInput() {
            const tipo = document.getElementById('tipoProducto').value;
            const stockDiv = document.getElementById('stockInputDiv');
            if (tipo === 'producto') {
                stockDiv.classList.remove('hidden');
            } else {
                stockDiv.classList.add('hidden');
            }
        }

        async function guardarProductoServicio() {
            const nombre = document.getElementById('nombreProducto').value.trim();
            const tipo = document.getElementById('tipoProducto').value;
            const precio = parseFloat(document.getElementById('precioProducto').value);
            let stock = tipo === 'producto' ? parseFloat(document.getElementById('stockProducto').value) : 0;
            const fechaVencimiento = document.getElementById('fechaVencimientoProducto').value;

            if (!nombre || isNaN(precio) || precio < 0 || (tipo === 'producto' && isNaN(stock) || stock < 0)) {
                alert('Por favor, completa todos los campos v√°lidos.');
                return;
            }

            try {
                let docId = productoServicioEnEdicionId;
                if (!docId) {
                    const docRef = await db.collection('productosYServicios').add({
                        nombreOriginal: nombre,
                        nombre: nombre.toLowerCase(),
                        tipo,
                        precio,
                        stock,
                        fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    docId = docRef.id;
                    alert('Producto/Servicio guardado exitosamente.');
                } else {
                    await db.collection('productosYServicios').doc(docId).update({
                        nombreOriginal: nombre,
                        nombre: nombre.toLowerCase(),
                        tipo,
                        precio,
                        stock,
                        ultimaActualizacion: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert('Producto/Servicio actualizado exitosamente.');
                }

                if (tipo === 'producto' && stock > 0 && !productoServicioEnEdicionId) {
                    const lotesRef = db.collection('productosYServicios').doc(docId).collection('lotes');
                    await lotesRef.add({
                        cantidad: stock,
                        fechaVencimiento: fechaVencimiento || '2099-12-31',
                        fechaEntrada: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                resetFormProductoServicio();
                await cargarProductosYServicios();
            } catch (e) {
                console.error("Error al guardar producto/servicio: ", e);
                alert('Ocurri√≥ un error al guardar el producto/servicio.');
            }
        }
        
        function resetFormProductoServicio() {
            document.getElementById('formProductoServicio').reset();
            document.getElementById('formProductoServicioTitle').textContent = 'Gesti√≥n de Productos y Servicios';
            document.getElementById('guardarProductoBtn').textContent = 'üíæ Guardar Producto/Servicio';
            productoServicioEnEdicionId = null;
        }

        async function cargarProductosYServicios() {
            const tbody = document.getElementById('listaProductosTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Cargando...</td></tr>';
            
            const snapshot = await db.collection('productosYServicios').get();
            todosLosProductosYServicios = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const productosPromises = todosLosProductosYServicios.map(async p => {
                if (p.tipo === 'producto') {
                    const lotesSnapshot = await db.collection('productosYServicios').doc(p.id).collection('lotes').orderBy('fechaVencimiento').limit(1).get();
                    if (!lotesSnapshot.empty) {
                        p.proximoVencimiento = lotesSnapshot.docs[0].data().fechaVencimiento;
                    } else {
                        p.proximoVencimiento = 'N/A';
                    }
                } else {
                    p.proximoVencimiento = 'N/A';
                }
                return p;
            });
            todosLosProductosYServicios = await Promise.all(productosPromises);

            tbody.innerHTML = '';
            if (todosLosProductosYServicios.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">No se encontraron productos o servicios.</td></tr>';
                return;
            }

            todosLosProductosYServicios.forEach(producto => {
                const row = document.createElement('tr');
                let rowClass = 'text-gray-700';
                if (producto.proximoVencimiento && producto.proximoVencimiento !== 'N/A') {
                    const hoy = new Date();
                    const fechaVencimiento = new Date(producto.proximoVencimiento);
                    const diferenciaDias = (fechaVencimiento - hoy) / (1000 * 60 * 60 * 24);
                    if (diferenciaDias <= 30 && diferenciaDias >= 0) {
                        rowClass = 'expiring-soon';
                    }
                }
                row.className = rowClass;
                row.innerHTML = `
                    <td class="px-3 py-2">${producto.nombreOriginal}</td>
                    <td class="px-3 py-2">${producto.tipo.charAt(0).toUpperCase() + producto.tipo.slice(1)}</td>
                    <td class="px-3 py-2 text-right">$${producto.precio.toFixed(2)}</td>
                    <td class="px-3 py-2 text-center">${producto.tipo === 'producto' ? producto.stock : 'N/A'}</td>
                    <td class="px-3 py-2">${producto.proximoVencimiento}</td>
                    <td class="px-3 py-2 text-center">
                        <button onclick="editarProductoServicio('${producto.id}')" class="text-blue-500 hover:text-blue-700 mx-1">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="eliminarProductoServicio('${producto.id}')" class="text-red-500 hover:text-red-700 mx-1">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            cargarSugerenciasProductos();
        }

        async function editarProductoServicio(id) {
            const producto = todosLosProductosYServicios.find(p => p.id === id);
            if (!producto) {
                alert('Producto/Servicio no encontrado.');
                return;
            }

            productoServicioEnEdicionId = id;
            document.getElementById('formProductoServicioTitle').textContent = `Editar ${producto.nombreOriginal}`;
            document.getElementById('guardarProductoBtn').textContent = 'üîÑ Actualizar';
            
            document.getElementById('nombreProducto').value = producto.nombreOriginal;
            document.getElementById('tipoProducto').value = producto.tipo;
            document.getElementById('precioProducto').value = producto.precio;
            document.getElementById('stockProducto').value = producto.stock;
            if (producto.proximoVencimiento && producto.proximoVencimiento !== 'N/A') {
                document.getElementById('fechaVencimientoProducto').value = producto.proximoVencimiento;
            }
            toggleStockInput();
        }
        
        async function eliminarProductoServicio(id) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este producto/servicio?')) {
                try {
                    await db.collection('productosYServicios').doc(id).delete();
                    alert('Producto/Servicio eliminado correctamente.');
                    cargarProductosYServicios();
                } catch (e) {
                    console.error("Error al eliminar producto/servicio: ", e);
                    alert('Ocurri√≥ un error al eliminar el producto/servicio.');
                }
            }
        }
        
        function cargarSugerenciasProductos() {
            const input = document.getElementById('descripcion');
            const sugerenciasUl = document.getElementById('sugerencias');

            input.oninput = () => {
                const valor = input.value.toLowerCase();
                sugerenciasUl.innerHTML = '';
                if (valor.length > 0) {
                    const sugerencias = todosLosProductosYServicios.filter(p => p.nombre.includes(valor));
                    sugerencias.forEach(p => {
                        const li = document.createElement('li');
                        li.textContent = p.nombreOriginal;
                        li.className = 'p-2 hover:bg-gray-200 cursor-pointer';
                        li.dataset.precio = p.precio;
                        li.dataset.stock = p.stock;
                        li.onclick = () => {
                            input.value = p.nombreOriginal;
                            document.getElementById('precio').value = p.precio;
                            sugerenciasUl.classList.add('hidden');
                        };
                        sugerenciasUl.appendChild(li);
                    });
                    if (sugerencias.length > 0) {
                        sugerenciasUl.classList.remove('hidden');
                    } else {
                        sugerenciasUl.classList.add('hidden');
                    }
                } else {
                    sugerenciasUl.classList.add('hidden');
                }
            };

            document.addEventListener('click', (event) => {
                if (!sugerenciasUl.contains(event.target) && event.target !== input) {
                    sugerenciasUl.classList.add('hidden');
                }
            });
        }
        
        async function cargarProductosCompra() {
            const select = document.getElementById('productoCompra');
            select.innerHTML = '';
            todosLosProductosYServicios.filter(p => p.tipo === 'producto').forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.nombreOriginal;
                select.appendChild(option);
            });
        }
        
        async function cargarCompras() {
            const tbody = document.getElementById('listaComprasTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Cargando...</td></tr>';
            
            const snapshot = await db.collection('compras').orderBy('fechaRegistro', 'desc').get();
            todasLasCompras = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            filtrarCompras();
        }

        function filtrarCompras() {
            const anio = document.getElementById('filtroComprasAnio').value;
            const mes = document.getElementById('filtroComprasMes').value;
            const dia = document.getElementById('filtroComprasDia').value;
            const horaInicial = document.getElementById('filtroComprasHoraInicial').value;
            const horaFinal = document.getElementById('filtroComprasHoraFinal').value;
            
            const comprasFiltradas = todasLasCompras.filter(compra => {
                const fecha = compra.fechaRegistro ? compra.fechaRegistro.toDate() : new Date();
                const compraAnio = fecha.getFullYear().toString();
                const compraMes = (fecha.getMonth() + 1).toString();
                const compraDia = fecha.getDate().toString();
                const compraHora = fecha.toTimeString().slice(0, 5);
                
                const anioMatch = !anio || compraAnio === anio;
                const mesMatch = !mes || compraMes === mes;
                const diaMatch = !dia || compraDia === dia;
                const horaInicialMatch = !horaInicial || compraHora >= horaInicial;
                const horaFinalMatch = !horaFinal || compraHora <= horaFinal;
                
                return anioMatch && mesMatch && diaMatch && horaInicialMatch && horaFinalMatch;
            });
            
            const tbody = document.getElementById('listaComprasTableBody');
            tbody.innerHTML = '';
            if (comprasFiltradas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No se encontraron compras.</td></tr>';
                return;
            }

            let totalInversion = 0;
            comprasFiltradas.forEach(compra => {
                const fecha = new Date(compra.fecha).toLocaleDateString('es-ES');
                const producto = todosLosProductosYServicios.find(p => p.id === compra.producto)?.nombreOriginal || 'Desconocido';
                const row = document.createElement('tr');
                row.className = 'text-gray-700';
                row.innerHTML = `
                    <td class="px-3 py-2">${fecha}</td>
                    <td class="px-3 py-2">${producto}</td>
                    <td class="px-3 py-2 text-center">${compra.cantidad}</td>
                    <td class="px-3 py-2 text-right">$${compra.costoUnitario.toFixed(2)}</td>
                    <td class="px-3 py-2 text-right">$${compra.total.toFixed(2)}</td>
                    <td class="px-3 py-2">${compra.facturaProveedor}</td>
                    <td class="px-3 py-2">${compra.usuario}</td>
                `;
                tbody.appendChild(row);
                totalInversion += compra.total;
            });
            
            const tfoot = document.getElementById('comprasSummaryFooter');
            tfoot.innerHTML = `
                <tr class="bg-gray-100 font-bold text-lg text-gray-800">
                    <td colspan="4" class="px-3 py-2 text-right">Total Inversi√≥n:</td>
                    <td colspan="3" class="px-3 py-2 text-right">$${totalInversion.toFixed(2)}</td>
                </tr>
            `;
            cargarAniosFiltroCompras(todasLasCompras);
        }

        function cargarAniosFiltroCompras(compras) {
            const selectAnio = document.getElementById('filtroComprasAnio');
            const anios = [...new Set(compras.map(c => (c.fechaRegistro ? c.fechaRegistro.toDate().getFullYear() : new Date().getFullYear())))].sort().reverse();
            selectAnio.innerHTML = '<option value="">Todos</option>';
            anios.forEach(anio => {
                const option = document.createElement('option');
                option.value = anio;
                option.textContent = anio;
                selectAnio.appendChild(option);
            });
        }
        
        async function cargarDashboardData() {
            const topStockList = document.getElementById('topStockProductsList');
            const expiringList = document.getElementById('expiringProductsList');
            const topSellingList = document.getElementById('topSellingProductsList');
            const topSellingUsersList = document.getElementById('topSellingUsersList');

            topStockList.innerHTML = '<li>Cargando...</li>';
            expiringList.innerHTML = '<li>Cargando...</li>';
            topSellingList.innerHTML = '<li>Cargando...</li>';
            topSellingUsersList.innerHTML = '<li>Cargando...</li>';

            const productosSnapshot = await db.collection('productosYServicios').where('tipo', '==', 'producto').orderBy('stock', 'desc').limit(5).get();
            const topStockProducts = productosSnapshot.docs.map(doc => doc.data());
            
            topStockList.innerHTML = '';
            if (topStockProducts.length > 0) {
                topStockProducts.forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = `${p.nombreOriginal}: ${p.stock} unidades`;
                    topStockList.appendChild(li);
                });
            } else {
                topStockList.innerHTML = '<li>No hay productos con stock.</li>';
            }

            const expiringProducts = todosLosProductosYServicios.filter(p => {
                if (p.proximoVencimiento && p.proximoVencimiento !== 'N/A') {
                    const hoy = new Date();
                    const fechaVencimiento = new Date(p.proximoVencimiento);
                    const diferenciaDias = (fechaVencimiento - hoy) / (1000 * 60 * 60 * 24);
                    return diferenciaDias <= 30 && diferenciaDias >= 0;
                }
                return false;
            }).sort((a, b) => new Date(a.proximoVencimiento) - new Date(b.proximoVencimiento));

            expiringList.innerHTML = '';
            if (expiringProducts.length > 0) {
                expiringProducts.forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = `${p.nombreOriginal} (${p.stock} uds): Vence el ${p.proximoVencimiento}`;
                    expiringList.appendChild(li);
                });
            } else {
                expiringList.innerHTML = '<li>No hay productos por vencer pronto.</li>';
            }

            const ventasSnapshot = await db.collection('facturas').get();
            const ventas = ventasSnapshot.docs.map(doc => doc.data());

            const ventasPorProducto = {};
            const ventasPorVendedor = {};

            ventas.forEach(venta => {
                venta.items.forEach(item => {
                    ventasPorProducto[item.descripcion] = (ventasPorProducto[item.descripcion] || 0) + item.cantidad;
                });
                ventasPorVendedor[venta.vendedor] = (ventasPorVendedor[venta.vendedor] || 0) + venta.total;
            });

            const sortedProducts = Object.entries(ventasPorProducto).sort(([, a], [, b]) => b - a).slice(0, 5);
            topSellingList.innerHTML = '';
            if (sortedProducts.length > 0) {
                sortedProducts.forEach(([producto, cantidad]) => {
                    const li = document.createElement('li');
                    li.textContent = `${producto}: ${cantidad} unidades`;
                    topSellingList.appendChild(li);
                });
            } else {
                topSellingList.innerHTML = '<li>No hay ventas registradas.</li>';
            }

            const sortedUsers = Object.entries(ventasPorVendedor).sort(([, a], [, b]) => b - a).slice(0, 5);
            topSellingUsersList.innerHTML = '';
            if (sortedUsers.length > 0) {
                sortedUsers.forEach(([usuario, total]) => {
                    const li = document.createElement('li');
                    li.textContent = `${usuario}: $${total.toFixed(2)}`;
                    topSellingUsersList.appendChild(li);
                });
            } else {
                topSellingUsersList.innerHTML = '<li>No hay ventas registradas.</li>';
            }
        }

    </script>
</body>
</html>
