<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Facturaci√≥n - M√∫ltiples √çtems</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 p-4">
  <h1 class="text-2xl font-bold mb-4">üìã Caja Facturadora - Fixitech</h1>
  <div class="grid md:grid-cols-2 gap-6">
    <!-- Caja de √≠tems -->
    <div class="bg-white p-4 rounded shadow">
      <h2 class="font-semibold mb-2">Agregar √çtems</h2>
      <input type="text" id="descripcion" placeholder="Descripci√≥n" class="w-full mb-2 p-2 border rounded" />
      <input type="number" id="cantidad" placeholder="Cantidad" class="w-full mb-2 p-2 border rounded" />
      <input type="number" id="precio" placeholder="Precio Unitario" class="w-full mb-2 p-2 border rounded" />
      <button onclick="agregarItem()" class="bg-teal-600 text-white px-4 py-2 rounded w-full mb-4">+ Agregar</button>
      <ul id="listaItems" class="space-y-2"></ul>
      <p class="font-bold mt-4">Total: $<span id="total">0</span></p>
    </div>

    <!-- Datos de la factura -->
    <div class="bg-white p-4 rounded shadow">
      <h2 class="font-semibold mb-2">Datos del Cliente</h2>
      <input type="text" id="cliente" placeholder="Nombre del Cliente" class="w-full mb-2 p-2 border rounded" />
      <input type="date" id="fechaIngreso" class="w-full mb-2 p-2 border rounded" />
      <input type="date" id="fechaEntrega" class="w-full mb-2 p-2 border rounded" />
      <select id="estado" class="w-full mb-2 p-2 border rounded">
        <option value="En espera">En espera</option>
        <option value="Entregado">Entregado</option>
        <option value="Facturado">Facturado</option>
      </select>
      <button onclick="guardarFactura()" class="bg-blue-600 text-white px-4 py-2 rounded w-full mb-2">üíæ Guardar Factura</button>
    </div>
  </div>

  <!-- Lista de facturas -->
  <div id="facturas" class="mt-8 grid gap-4"></div>

  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
  <script src="firebase.js"></script>
  <script>
    const db = firebase.firestore();
    let items = [];

    function agregarItem() {
      const descripcion = document.getElementById('descripcion').value;
      const cantidad = parseInt(document.getElementById('cantidad').value);
      const precio = parseFloat(document.getElementById('precio').value);
      if (!descripcion || !cantidad || !precio) return alert('Campos incompletos');

      const subtotal = cantidad * precio;
      items.push({ descripcion, cantidad, precio, subtotal });
      document.getElementById('descripcion').value = '';
      document.getElementById('cantidad').value = '';
      document.getElementById('precio').value = '';
      actualizarListaItems();
    }

    function actualizarListaItems() {
      const lista = document.getElementById('listaItems');
      const totalEl = document.getElementById('total');
      lista.innerHTML = '';
      let total = 0;
      items.forEach((item, index) => {
        total += item.subtotal;
        const li = document.createElement('li');
        li.innerHTML = `${item.cantidad} x ${item.descripcion} @ $${item.precio} = $${item.subtotal.toFixed(2)}
          <button onclick="eliminarItem(${index})" class="text-red-600 ml-2">‚úñ</button>`;
        lista.appendChild(li);
      });
      totalEl.textContent = total.toFixed(2);
    }

    function eliminarItem(index) {
      items.splice(index, 1);
      actualizarListaItems();
    }

    async function guardarFactura() {
      const cliente = document.getElementById('cliente').value;
      const fechaIngreso = document.getElementById('fechaIngreso').value;
      const fechaEntrega = document.getElementById('fechaEntrega').value;
      const estado = document.getElementById('estado').value;
      const total = items.reduce((sum, item) => sum + item.subtotal, 0);
      if (!cliente || items.length === 0) return alert('Faltan datos del cliente o √≠tems');

      const data = {
        cliente, fechaIngreso, fechaEntrega, estado, items, total, timestamp: new Date()
      };
      await db.collection('facturas').add(data);
      alert('Factura guardada');
      items = [];
      actualizarListaItems();
      cargarFacturas();
    }

    async function cargarFacturas() {
      const contenedor = document.getElementById('facturas');
      contenedor.innerHTML = '';
      const snap = await db.collection('facturas').orderBy('timestamp', 'desc').get();
      snap.forEach(doc => {
        const f = doc.data();
        const div = document.createElement('div');
        div.className = 'bg-white p-4 rounded shadow';
        let html = `<h3 class="font-bold">${f.cliente}</h3><ul class="mb-2">`;
        f.items.forEach(i => {
          html += `<li>${i.cantidad} x ${i.descripcion} = $${i.subtotal.toFixed(2)}</li>`;
        });
        html += `</ul><p><strong>Total:</strong> $${f.total}</p><p>Estado: ${f.estado}</p>
        <button onclick='generarPDF(${JSON.stringify(f).replace(/"/g, "&quot;")})' class="mt-2 bg-gray-700 text-white px-2 py-1 rounded">üìÑ PDF</button>`;
        div.innerHTML = html;
        contenedor.appendChild(div);
      });
    }

    function generarPDF(f) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text(`Factura - Fixitech`, 10, 10);
      doc.text(`Cliente: ${f.cliente}`, 10, 20);
      let y = 30;
      f.items.forEach(i => {
        doc.text(`${i.cantidad} x ${i.descripcion} @ $${i.precio} = $${i.subtotal.toFixed(2)}`, 10, y);
        y += 10;
      });
      doc.text(`Total: $${f.total}`, 10, y);
      y += 10;
      doc.text(`Ingreso: ${f.fechaIngreso}`, 10, y);
      y += 10;
      doc.text(`Entrega: ${f.fechaEntrega}`, 10, y);
      y += 10;
      doc.text(`Estado: ${f.estado}`, 10, y);
      doc.save(`Factura_${f.cliente}.pdf`);
    }

    cargarFacturas();
  </script>
</body>
</html>
