<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Facturaci√≥n y Compras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
    <style>
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        .sidebar {
            width: 250px;
        }
        .main-content {
            margin-left: 250px;
        }
        .menu-item.active {
            background-color: #3f83f8;
            color: white;
        }
        .expiring-soon {
            background-color: #fbd38d;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-content, .printable-content * {
                visibility: visible;
            }
            .printable-content {
                position: absolute;
                left: 0;
                top: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex min-h-screen">

    <div id="loginSection" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-3xl font-bold text-center text-teal-600 mb-6">Iniciar Sesi√≥n Fixitech</h2>
            <p id="error" class="text-red-600 mt-4 text-center hidden">Credenciales incorrectas</p>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="usuario" class="block text-gray-700 font-medium mb-2">Usuario:</label>
                    <input type="text" id="usuario" name="usuario" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Ej: admin" required>
                </div>
                 <div class="mb-4">
                    <label for="password" class="block text-gray-700 font-medium mb-2">Contrase√±a:</label>
                    <input type="password" id="password" name="password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Contrase√±a" required>
                </div>
                <button type="button" onclick="login()" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition duration-300">Ingresar</button>
            </form>
        </div>
    </div>


    <div id="sidebar" class="sidebar bg-gray-800 text-white flex-shrink-0 fixed h-full p-4 flex flex-col hidden">
        <h1 class="text-2xl font-bold mb-6 text-center text-teal-400">Sistema de Venta</h1>
        <nav class="flex-grow">
            <ul>
                <li id="menu-dashboard" class="mb-2 hidden">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('dashboardSection')">
                        <span class="mr-2">üìä</span> Dashboard
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 active" onclick="iniciarNuevaVenta()">
                        <span class="mr-2">üí∞</span> Nueva Venta
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('gestionFacturasSection')">
                        <span class="mr-2">üìã</span> Gesti√≥n de Ventas
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('gestionClientesSection')">
                        <span class="mr-2">üßë‚Äçü§ù‚Äçüßë</span> Gesti√≥n de Clientes
                    </a>
                </li>
                <li id="menu-productos" class="mb-2 hidden">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('gestionProductosSection')">
                        <span class="mr-2">üì¶</span> Productos y Servicios
                    </a>
                </li>
                <li id="menu-compras" class="mb-2 hidden">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('gestionComprasSection')">
                        <span class="mr-2">üõí</span> Gesti√≥n de Compras
                    </a>
                </li>
                 <li id="menu-consulta-productos" class="mb-2 hidden">
                <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('consultaProductosSection')">
                    <span class="mr-2">üîç</span> Consulta de Productos
                </a>
                </li>
            </ul>
        </nav>
        <div class="mt-auto text-center text-gray-400 text-sm">
            <p>Bienvenido, <span id="userNameDisplay" class="font-bold"></span></p>
            <p>Rol: <span id="userRoleDisplay" class="font-bold"></span></p>
            <button class="mt-2 text-red-400 hover:text-red-300" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <div id="main-content" class="main-content flex-grow p-8 hidden">
        
        <div id="dashboardSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-3xl font-semibold mb-6 text-gray-800">Dashboard de Gerencia üìä</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-blue-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-blue-800 mb-4">Productos con Mayor Stock üì¶</h3>
                    <ul id="topStockProductsList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
                <div class="bg-yellow-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-yellow-800 mb-4">Productos por Vencer ‚è≥</h3>
                    <ul id="expiringProductsList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
                <div class="bg-green-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-green-800 mb-4">Productos M√°s Vendidos üìà</h3>
                    <ul id="topSellingProductsList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
                <div class="bg-purple-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-purple-800 mb-4">Vendedores con M√°s Ventas üèÜ</h3>
                    <ul id="topSellingUsersList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="nuevaVentaSection" class="bg-white rounded-lg shadow-md p-6">
            <h2 id="formFacturaTitle" class="text-2xl font-semibold mb-6 text-gray-800">Datos del Cliente y Nueva Venta</h2>
            
            <form id="formFactura" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-4 mb-4">
                    <div class="relative">
                        <label for="cedulaCliente" class="block text-sm font-medium text-gray-700">C√©dula</label>
                        <input type="text" id="cedulaCliente" placeholder="C√©dula del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" onblur="buscarClientePorCedula()">
                    </div>
                    <div class="relative">
                        <label for="nombreCliente" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="nombreCliente" placeholder="Nombre Completo del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                        <button type="button" onclick="guardarClienteDesdeFactura()" class="absolute right-2 top-8 text-sm bg-gray-200 hover:bg-gray-300 p-1 rounded-md" title="Guardar este cliente">üíæ</button>
                    </div>
                    <div>
                        <label for="telefono" class="block text-sm font-medium text-gray-700">Tel√©fono</label>
                        <input type="text" id="telefono" placeholder="N√∫mero de Tel√©fono" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="direccion" class="block text-sm font-medium text-gray-700">Direcci√≥n</label>
                        <input type="text" id="direccion" placeholder="Direcci√≥n del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-1 relative">
                        <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripci√≥n</label>
                        <input type="text" id="descripcion" placeholder="Descripci√≥n del Art√≠culo/Servicio" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" />
                        <ul id="sugerencias" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-48 overflow-y-auto hidden"></ul>
                    </div>
                    <div class="md:col-span-1">
                        <label for="cantidad" class="block text-sm font-medium text-gray-700">Cantidad</label>
                        <input type="number" id="cantidad" value="1" min="1" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div class="md:col-span-1">
                        <label for="precio" class="block text-sm font-medium text-gray-700">Precio Unitario</label>
                        <input type="number" id="precio" placeholder="Precio" step="0.01" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div class="md:col-span-1 flex items-end">
                        <button type="button" onclick="agregarItem()" class="w-full bg-teal-500 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-600 transition duration-200">
                            + Agregar √çtem
                        </button>
                    </div>
                    
                </div>
            </form>

            <div class="mt-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">√çtems de la Venta</h3>
                <div class="bg-gray-50 rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripci√≥n</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unitario</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="tablaItems" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        <tfoot>
                            <tr class="bg-gray-100">
                                <td colspan="3" class="px-3 py-2 text-right font-bold text-lg text-gray-800">Total:</td>
                                <td colspan="2" class="px-3 py-2 text-right font-bold text-lg text-gray-800" id="total">$0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
            <div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="fechaIngreso" class="block text-sm font-medium text-gray-700">Fecha de Ingreso</label>
                    <input type="date" id="fechaIngreso" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="fechaEntrega" class="block text-sm font-medium text-gray-700">Fecha de Entrega</label>
                    <input type="date" id="fechaEntrega" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="estado" class="block text-sm font-medium text-gray-700">Estado</label>
                    <select id="estado" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                        <option value="En espera">En espera</option>
                        <option value="Facturado">Facturado</option>
                        <option value="Entregado">Entregado</option>
                    </select>
                </div>
                <div>
                    <label for="vendedor" class="block text-sm font-medium text-gray-700">Vendedor</label>
                    <input type="text" id="vendedor" class="mt-1 p-2 block w-full border border-gray-300 rounded-md bg-gray-200" readonly>
                </div>
            </div>
            
            <div class="flex justify-end space-x-4 mt-8">
                <button type="button" onclick="mostrarFactura()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                    üîç Previsualizar
                </button>
                <button type="button" id="guardarFacturaBtn" onclick="guardarFactura()" class="bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition duration-200">
                    üíæ Guardar Venta
                </button>
            </div>
        </div>

        <div id="gestionFacturasSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Ventas</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div>
                    <label for="filtroVentasAnio" class="block text-sm font-medium text-gray-700">A√±o</label>
                    <select id="filtroVentasAnio" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div>
                    <label for="filtroVentasMes" class="block text-sm font-medium text-gray-700">Mes</label>
                    <select id="filtroVentasMes" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                        <option value="">Todos</option>
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div>
                    <label for="filtroVentasHoraInicial" class="block text-sm font-medium text-gray-700">Hora Inicial</label>
                    <input type="time" id="filtroVentasHoraInicial" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="filtroVentasHoraFinal" class="block text-sm font-medium text-gray-700">Hora Final</label>
                    <input type="time" id="filtroVentasHoraFinal" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N¬∞ Factura</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendedor</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaFacturasTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="gestionClientesSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Clientes</h2>


            <form id="formCliente" class="space-y-4 mb-6 hidden">
                <h3 id="formClienteTitle" class="text-xl font-semibold">Editar Cliente</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label for="editCedula" class="block text-sm font-medium text-gray-700">C√©dula</label>
                        <input type="text" id="editCedula" placeholder="C√©dula del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md bg-gray-200" readonly>
                    </div>
                    <div>
                        <label for="editNombre" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="editNombre" placeholder="Nombre Completo del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="editTelefono" class="block text-sm font-medium text-gray-700">Tel√©fono</label>
                        <input type="text" id="editTelefono" placeholder="N√∫mero de Tel√©fono" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="editDireccion" class="block text-sm font-medium text-gray-700">Direcci√≥n</label>
                        <input type="text" id="editDireccion" placeholder="Direcci√≥n del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="limpiarFormularioCliente()" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-600 transition duration-200">
                        Cancelar
                    </button>
                    <button type="button" onclick="guardarCliente()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                        üíæ Guardar Cambios
                    </button>
                </div>
            </form>

            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="filtroClienteNombre" class="block text-sm font-medium text-gray-700">Buscar por Nombre o C√©dula</label>
                    <input type="text" id="filtroClienteNombre" oninput="filtrarClientes()" placeholder="Ej: Ana L√≥pez" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√©dula</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tel√©fono</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Direcci√≥n</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaClientesTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div id="gestionProductosSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 id="formProductoServicioTitle" class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Productos y Servicios</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div>
        <label for="filtroNombreProducto" class="block text-sm font-medium text-gray-700">Buscar por Nombre</label>
        <input type="text" id="filtroNombreProducto" oninput="filtrarProductos()" placeholder="Ej: Memoria RAM" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
    </div>
    <div>
        <label for="filtroTipoProducto" class="block text-sm font-medium text-gray-700">Filtrar por Tipo</label>
        <select id="filtroTipoProducto" onchange="filtrarProductos()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
            <option value="">Todos</option>
            <option value="producto">Producto</option>
            <option value="servicio">Servicio</option>
        </select>
    </div>
    <div>
        <label for="filtroVencimientoProducto" class="block text-sm font-medium text-gray-700">Vencimiento antes de</label>
        <input type="date" id="filtroVencimientoProducto" onchange="filtrarProductos()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
    </div>
</div>
            <form id="formProductoServicio" class="space-y-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label for="nombreProducto" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="nombreProducto" placeholder="Nombre del Producto/Servicio" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="tipoProducto" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="tipoProducto" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" onchange="toggleStockInput()">
                            <option value="producto">Producto</option>
                            <option value="servicio">Servicio</option>
                        </select>
                    </div>
                    <div>
                        <label for="precioProducto" class="block text-sm font-medium text-gray-700">Precio de Venta</label>
                        <input type="number" id="precioProducto" placeholder="Precio" step="0.01" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div id="stockInputDiv">
                        <label for="stockProducto" class="block text-sm font-medium text-gray-700">Stock Inicial</label>
                        <input type="number" id="stockProducto" value="0" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="fechaVencimientoProducto" class="block text-sm font-medium text-gray-700">Fecha de Vencimiento</label>
                        <input type="date" id="fechaVencimientoProducto" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                <div class="flex justify-end">
                    <button type="button" id="guardarProductoBtn" onclick="guardarProductoServicio()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                        üíæ Guardar Producto/Servicio
                    </button>
                </div>
            </form>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vencimiento</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaProductosTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="main-content" class="main-content flex-grow p-8 hidden">
        
    <div id="gestionComprasSection" class="hidden bg-white rounded-lg shadow-md p-6">
        </div>
    
            <div id="consultaProductosSection" class="hidden bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Consulta de Stock y Vencimiento</h2>
                <div class="mb-4">
                    <input type="text" id="filtroProducto" placeholder="Buscar producto por nombre..." class="w-full p-2 border rounded-md">
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Disponible</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">√öltima Fecha de Vencimiento</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="listaProductosConsultaTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div id="loteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
                </div>
            
        </div>

        <div id="gestionComprasSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Compras</h2>
            
            <form id="formCompra" class="space-y-4 mb-6">
                <h3 class="text-xl font-semibold mb-2">Registrar Nueva Compra</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label for="numeroFacturaCompra" class="block text-sm font-medium text-gray-700">N√∫mero de Factura</label>
                        <input type="text" id="numeroFacturaCompra" placeholder="Ej: 001-002-12345" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="fechaCompra" class="block text-sm font-medium text-gray-700">Fecha</label>
                        <input type="date" id="fechaCompra" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="productoCompra" class="block text-sm font-medium text-gray-700">Producto</label>
                        <select id="productoCompra" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                            </select>
                    </div>
                    <div>
                        <label for="cantidadCompra" class="block text-sm font-medium text-gray-700">Cantidad</label>
                        <input type="number" id="cantidadCompra" value="1" min="1" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="costoCompra" class="block text-sm font-medium text-gray-700">Costo Unitario</label>
                        <input type="number" id="costoCompra" placeholder="Costo" step="0.01" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="fechaVencimientoCompra" class="block text-sm font-medium text-gray-700">Fecha de Vencimiento del Lote</label>
                        <input type="date" id="fechaVencimientoCompra" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="usuarioCompra" class="block text-sm font-medium text-gray-700">Registrado por</label>
                        <input type="text" id="usuarioCompra" class="mt-1 p-2 block w-full border border-gray-300 rounded-md bg-gray-200" readonly>
                    </div>
                    <div class="flex items-end justify-end">
                        <button type="button"  id="btnGuardarCompra" onclick="guardarCompra()" class="bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition duration-200">
                            üíæ Registrar Compra
                        </button>
                    </div>
                </div>
            </form>
            
            <h3 class="text-xl font-semibold mb-4">Historial de Compras</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                <div>
                    <label for="filtroComprasAnio" class="block text-sm font-medium text-gray-700">A√±o</label>
                    <select id="filtroComprasAnio" onchange="filtrarCompras()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div>
                    <label for="filtroComprasMes" class="block text-sm font-medium text-gray-700">Mes</label>
                    <select id="filtroComprasMes" onchange="filtrarCompras()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                        <option value="">Todos</option>
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div>
                    <label for="filtroComprasDia" class="block text-sm font-medium text-gray-700">D√≠a</label>
                    <input type="number" id="filtroComprasDia" onchange="filtrarCompras()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="filtroComprasHoraInicial" class="block text-sm font-medium text-gray-700">Hora Inicial</label>
                    <input type="time" id="filtroComprasHoraInicial" onchange="filtrarCompras()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="filtroComprasHoraFinal" class="block text-sm font-medium text-gray-700">Hora Final</label>
                    <input type="time" id="filtroComprasHoraFinal" onchange="filtrarCompras()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Factura</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Costo Unit.</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaComprasTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    <tfoot id="comprasSummaryFooter">
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <div id="loteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-3/4 md:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Detalles del Lote y Vencimiento</h3>
            <div class="mt-2 px-7 py-3">
                <div id="loteProductoNombre" class="font-bold text-xl mb-4"></div>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N√∫mero de Factura (Lote)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad Comprada</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha de Vencimiento</th>
                        </tr>
                    </thead>
                    <tbody id="loteDetallesTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
            <div class="items-center px-4 py-3">
                <button id="cerrarLoteModal" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>
    <script src="firebase.js"></script>
    <script>
        const db = firebase.firestore();
        let items = [];
        let todasLasFacturas = [];
        let facturaEnEdicionId = null;
        let todaLaInformacionFacturaEnEdicion = null;
        let todosLosClientes = [];
        let todosLosProductosYServicios = [];
        let productoServicioEnEdicionId = null;
        let todasLasCompras = [];
        let currentLoggedInUser = null;

        window.onload = async () => {
            // Se puede llamar a login() si ya se han guardado las credenciales
        };




function mostrarSeccion(sectionId) {
            const secciones = ['dashboardSection', 'nuevaVentaSection', 'gestionFacturasSection', 'gestionClientesSection', 'gestionProductosSection', 'gestionComprasSection'];
            secciones.forEach(id => {
                const seccion = document.getElementById(id);
                if (seccion) { // <-- Aqu√≠ est√° la correcci√≥n principal
                    seccion.classList.add('hidden');
                }
            });
            const seccionAMostrar = document.getElementById(sectionId);
            if (seccionAMostrar) { // <-- Y aqu√≠ tambi√©n
                seccionAMostrar.classList.remove('hidden');
            }
        }

        function iniciarNuevaVenta() {
            mostrarSeccion('nuevaVentaSection');
            limpiarFormularioFactura();
        }

// Agrega esta l√≠nea al inicio de tu bloque de <script> para declarar la variable globalmente
///let usuarioActual; 

 let usuarioActual; 

        // 2. Coloca aqu√≠ tu funci√≥n de inicio de sesi√≥n corregida
        async function login() {
            const usuario = document.getElementById('usuario').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('error');
            try {
                const doc = await db.collection('usuarios').doc(usuario).get();
                if (doc.exists && doc.data().password === password) {
                    errorElement.classList.add('hidden');
                    usuarioActual = {
                        id: doc.id,
                        rol: doc.data().rol,
                        nombre: doc.data().nombre,
                    };
                    localStorage.setItem('usuarioActual', JSON.stringify(usuarioActual));
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('sidebar').classList.remove('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    document.getElementById('userNameDisplay').textContent = usuarioActual.nombre;
                    document.getElementById('userRoleDisplay').textContent = usuarioActual.rol.toUpperCase();
                    document.getElementById('vendedor').value = usuarioActual.nombre;
                    document.getElementById('usuarioCompra').value = usuarioActual.nombre;
                    controlarMenuPorRol();
                    if (usuarioActual.rol === 'admin' || usuarioActual.rol === 'superusuario') {
                        mostrarSeccion('dashboardSection');
                    } else {
                        mostrarSeccion('nuevaVentaSection');
                    }
                    await cargarDatosIniciales();
                } else {
                    errorElement.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error al iniciar sesi√≥n:", error);
                errorElement.textContent = "Error al conectar. Int√©ntalo de nuevo.";
                errorElement.classList.remove('hidden');
            }
        }

        

// NUEVA FUNCI√ìN PARA CONTROLAR EL MEN√ö SEG√öN EL ROL
function controlarMenuPorRol() {
     // La lista de todos los IDs del men√∫ que deben ser controlados
    const menuItemsAdmin = ['menu-dashboard', 'menu-facturas', 'menu-clientes', 'menu-productos', 'menu-compras', 'menu-usuarios'];
    
    // Si el rol es 'superusuario', muestra todas las opciones y termina la funci√≥n
    if (usuarioActual.rol === 'superusuario') {
        menuItemsAdmin.forEach(itemId => {
            const item = document.getElementById(itemId);
            if (item) {
                item.classList.remove('hidden');
            }
        });
        return; 
    }

    // Si el rol es 'admin', muestra las mismas opciones que antes
    if (usuarioActual.rol === 'admin') {
        menuItemsAdmin.forEach(itemId => {
            const item = document.getElementById(itemId);
            if (item) {
                item.classList.remove('hidden');
            }
        });
    } else { // Para el rol 'vendedor' u otros
        menuItemsAdmin.forEach(itemId => {
            const item = document.getElementById(itemId);
            if (item) {
                item.classList.add('hidden');
            }
        });
    }
}

      
        
            function logout() {
            currentLoggedInUser = null;
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('main-content').classList.add('hidden');
            
            document.getElementById('formFactura').reset();
            document.getElementById('formCompra').reset();
            document.getElementById('formProductoServicio').reset();
            
            items = [];
            document.getElementById('tablaItems').innerHTML = '';
            actualizarTotal();
        }

        function mostrarMensaje(texto, color = 'bg-green-600') {
            const mensaje = document.createElement('div');
            mensaje.textContent = texto;
            mensaje.className = `fixed top-5 right-5 ${color} text-white px-4 py-2 rounded shadow-lg z-50`;
            document.body.appendChild(mensaje);
            setTimeout(() => mensaje.remove(), 3000);
        }


        function mostrarMensaje(texto, color = 'bg-green-600') {
            const mensaje = document.createElement('div');
            mensaje.textContent = texto;
            mensaje.className = `fixed top-5 right-5 ${color} text-white px-4 py-2 rounded shadow-lg z-50`;
            document.body.appendChild(mensaje);
            setTimeout(() => mensaje.remove(), 3000);
        }

        // ---------------------------------------------
        // FUNCIONES DE GESTI√ìN DE VENTAS Y FACTURAS
        // ---------------------------------------------

        function agregarItem() {
            const descripcion = document.getElementById('descripcion').value;
            const cantidad = parseFloat(document.getElementById('cantidad').value);
            const precio = parseFloat(document.getElementById('precio').value);

            if (descripcion && !isNaN(cantidad) && cantidad > 0 && !isNaN(precio) && precio >= 0) {
                const subtotal = cantidad * precio;
                items.push({ descripcion, cantidad, precio, subtotal });
                renderizarItems();
                document.getElementById('descripcion').value = '';
                document.getElementById('cantidad').value = '1';
                document.getElementById('precio').value = '';
                document.getElementById('descripcion').focus();
            } else {
                mostrarMensaje('Por favor, completa todos los campos del √≠tem correctamente.', 'bg-red-500');
            }
        }

        function eliminarItem(index) {
            items.splice(index, 1);
            renderizarItems();
        }

        function renderizarItems() {
            const tablaItems = document.getElementById('tablaItems');
            tablaItems.innerHTML = '';
            items.forEach((item, index) => {
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 border-b border-gray-200">${item.descripcion}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-center">${item.cantidad}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-right">$${item.precio.toFixed(2)}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-right">$${item.subtotal.toFixed(2)}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-center">
                            <button type="button" onclick="eliminarItem(${index})" class="text-red-500 hover:text-red-700">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
                tablaItems.innerHTML += row;
            });
            actualizarTotal();
        }

        function actualizarTotal() {
            const total = items.reduce((sum, item) => sum + item.subtotal, 0);
            document.getElementById('total').textContent = `$${total.toFixed(2)}`;
        }
        
        async function generarNumeroFactura() {
            const counterRef = db.collection('contadores').doc('facturas');
            return db.runTransaction(async transaction => {
                const counterDoc = await transaction.get(counterRef);
                const currentValor = counterDoc.exists ? (counterDoc.data().valor || 0) : 0;
                const nuevoValor = currentValor + 1;
                await transaction.set(counterRef, { valor: nuevoValor });
                return nuevoValor;
            });
        }
        
        function formatFacturaNumber(num) {
            const year = new Date().getFullYear().toString().slice(-2);
            const paddedCounter = String(num).padStart(6, '0');
            return paddedCounter + year;
        }

        async function guardarFactura() {
            const cedulaCliente = document.getElementById('cedulaCliente').value;
            const nombreCliente = document.getElementById('nombreCliente').value;
            const telefono = document.getElementById('telefono').value;
            const direccion = document.getElementById('direccion').value;
            const fechaIngreso = document.getElementById('fechaIngreso').value;
            const fechaEntrega = document.getElementById('fechaEntrega').value;
            const estado = document.getElementById('estado').value;
            const vendedor = document.getElementById('vendedor').value;
            const total = items.reduce((sum, item) => sum + item.subtotal, 0);

            if (!cedulaCliente || !nombreCliente || items.length === 0) {
                mostrarMensaje('‚ùå Por favor, complete la informaci√≥n del cliente y agregue al menos un √≠tem.', 'bg-red-500');
                return;
            }

            try {
                let numeroFactura = null;
                if (estado === 'Facturado' && (!todaLaInformacionFacturaEnEdicion || !todaLaInformacionFacturaEnEdicion.numeroFactura)) {
                    const counter = await generarNumeroFactura();
                    numeroFactura = formatFacturaNumber(counter);
                } else if (todaLaInformacionFacturaEnEdicion && todaLaInformacionFacturaEnEdicion.numeroFactura) {
                    numeroFactura = todaLaInformacionFacturaEnEdicion.numeroFactura;
                }

                const facturaData = {
                    cedulaCliente,
                    nombreCliente,
                    telefono,
                    direccion,
                    fechaIngreso,
                    fechaEntrega,
                    estado,
                    vendedor,
                    items,
                    total,
                    numeroFactura,
                    fechaCreacion: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (facturaEnEdicionId) {
                    await db.collection('facturas').doc(facturaEnEdicionId).update(facturaData);
                    mostrarMensaje('‚úÖ Factura actualizada con √©xito.');
                } else {
                    await db.collection('facturas').add(facturaData);
                    mostrarMensaje('‚úÖ Venta guardada con √©xito.');
                }
                
                limpiarFormularioFactura();
                cargarFacturas();
                cargarDashboardData();

            } catch (error) {
                console.error("Error al guardar la factura:", error);
                mostrarMensaje('‚ùå Ocurri√≥ un error al intentar guardar la venta.', 'bg-red-500');
            }
        }

        async function cargarFacturas() {
            try {
                const snapshot = await db.collection('facturas').orderBy('fechaCreacion', 'desc').get();
                todasLasFacturas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filtrarFacturas();
            } catch (error) {
                console.error("Error al cargar las facturas:", error);
            }
        }

        function filtrarFacturas() {
            const filtroAnio = document.getElementById('filtroVentasAnio').value;
            const filtroMes = document.getElementById('filtroVentasMes').value;
            const filtroHoraInicial = document.getElementById('filtroVentasHoraInicial').value;
            const filtroHoraFinal = document.getElementById('filtroVentasHoraFinal').value;
            
            let facturasFiltradas = todasLasFacturas;

            if (filtroAnio) {
                facturasFiltradas = facturasFiltradas.filter(factura => {
                    const fecha = factura.fechaCreacion.toDate();
                    return fecha.getFullYear() === parseInt(filtroAnio);
                });
            }
            
            if (filtroMes) {
                facturasFiltradas = facturasFiltradas.filter(factura => {
                    const fecha = factura.fechaCreacion.toDate();
                    return (fecha.getMonth() + 1) === parseInt(filtroMes);
                });
            }

            if (filtroHoraInicial && filtroHoraFinal) {
                facturasFiltradas = facturasFiltradas.filter(factura => {
                    const fecha = factura.fechaCreacion.toDate();
                    const hora = fecha.getHours().toString().padStart(2, '0');
                    const minutos = fecha.getMinutes().toString().padStart(2, '0');
                    const horaFactura = `${hora}:${minutos}`;
                    return horaFactura >= filtroHoraInicial && horaFactura <= filtroHoraFinal;
                });
            }

            renderizarFacturas(facturasFiltradas);
        }

function renderizarFacturas(facturas) {
    const tableBody = document.getElementById('listaFacturasTableBody');
    tableBody.innerHTML = '';
    
    facturas.forEach(factura => {
        const data = factura;
        const fila = document.createElement('tr');
        fila.classList.add("hover:bg-gray-50");

        // Condici√≥n para mostrar 'Pendiente' si numeroFactura es null o undefined
        const numeroDisplay = data.numeroFactura ? `${data.numeroFactura}` : 'Pendiente';

        // Validar y formatear la fecha de manera segura
        const fechaFormateada = data.fechaCreacion && data.fechaCreacion.seconds 
            ? new Date(data.fechaCreacion.seconds * 1000).toLocaleDateString()
            : 'N/A';
        
        fila.innerHTML = `
            <td class="px-3 py-2 border-b border-gray-200">${numeroDisplay}</td>
            <td class="px-3 py-2 border-b border-gray-200">${data.nombreCliente}</td>
            <td class="px-3 py-2 border-b border-gray-200 text-right">$${data.total.toFixed(2)}</td>
            <td class="px-3 py-2 border-b border-gray-200">${data.vendedor}</td>
            <td class="px-3 py-2 border-b border-gray-200">${data.estado}</td>
            <td class="px-3 py-2 border-b border-gray-200">${fechaFormateada}</td>
        `;

        const accionesCell = document.createElement('td');
        accionesCell.classList.add("px-3", "py-2", "border-b", "border-gray-200", "text-center");
        
        const btnVisualizar = document.createElement('button');
        btnVisualizar.textContent = 'üîç';
        btnVisualizar.classList.add("text-blue-500", "hover:text-blue-700", "font-bold", "px-1");
        btnVisualizar.onclick = () => verDetalleFactura(factura.id);
        accionesCell.appendChild(btnVisualizar);

        const btnImprimir = document.createElement('button');
        btnImprimir.textContent = 'üñ®Ô∏è';
        btnImprimir.classList.add("text-green-500", "hover:text-green-700", "font-bold", "px-1");
        btnImprimir.onclick = () => imprimirFactura(factura.id);
        accionesCell.appendChild(btnImprimir);

                     // **NUEVO:** Bot√≥n de Editar para facturas en espera y entregadas
        if (data.estado === 'En espera' || data.estado === 'Entregado') {
            const btnEditar = document.createElement('button');
            btnEditar.textContent = '‚úèÔ∏è';
            btnEditar.classList.add("text-orange-500", "hover:text-orange-700", "font-bold", "px-1");
            btnEditar.onclick = () => editarFactura(factura.id);
            accionesCell.appendChild(btnEditar);
        }
        
        if (usuarioActual.rol === 'superusuario' || usuarioActual.rol === 'admin') {
            const btnEliminar = document.createElement('button');
            btnEliminar.textContent = 'üóëÔ∏è';
            btnEliminar.classList.add("text-red-500", "hover:text-red-700", "font-bold", "px-1");
            btnEliminar.onclick = () => eliminarFactura(factura.id);
            accionesCell.appendChild(btnEliminar);
        }

        fila.appendChild(accionesCell);
        tableBody.appendChild(fila);
    });
}

        async function editarFactura(facturaId) {
            const facturaDoc = await db.collection('facturas').doc(facturaId).get();
            if (facturaDoc.exists) {
                const facturaData = facturaDoc.data();
                if (facturaData.estado === 'Facturado') {
                    mostrarMensaje('‚ùå No se puede editar una factura ya facturada.', 'bg-red-500');
                    return;
                }
                facturaEnEdicionId = facturaId;
                todaLaInformacionFacturaEnEdicion = facturaData;

                document.getElementById('formFacturaTitle').textContent = `Editar Venta ${facturaData.numeroFactura || facturaId.slice(0, 5)}`;
                document.getElementById('guardarFacturaBtn').textContent = 'üíæ Actualizar Venta';
                
                document.getElementById('cedulaCliente').value = facturaData.cedulaCliente || '';
                document.getElementById('nombreCliente').value = facturaData.nombreCliente || '';
                document.getElementById('telefono').value = facturaData.telefono || '';
                document.getElementById('direccion').value = facturaData.direccion || '';
                document.getElementById('fechaIngreso').value = facturaData.fechaIngreso || '';
                document.getElementById('fechaEntrega').value = facturaData.fechaEntrega || '';
                document.getElementById('estado').value = facturaData.estado || 'En espera';
                document.getElementById('vendedor').value = facturaData.vendedor || currentLoggedInUser.nombre;

                items = facturaData.items || [];
                renderizarItems();
                
                mostrarSeccion('nuevaVentaSection');
                mostrarMensaje('Cargando venta para edici√≥n...');
            }
        }

        async function eliminarFactura(facturaId) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta factura? Esta acci√≥n no se puede deshacer.')) {
                try {
                    await db.collection('facturas').doc(facturaId).delete();
                    mostrarMensaje('‚úÖ Factura eliminada con √©xito.');
                    cargarFacturas();
                    cargarDashboardData();
                } catch (error) {
                    console.error("Error al eliminar la factura:", error);
                    mostrarMensaje('‚ùå Ocurri√≥ un error al eliminar la factura.', 'bg-red-500');
                }
            }
        }

        async function imprimirFactura(facturaId) {
            const facturaDoc = await db.collection('facturas').doc(facturaId).get();
            if (!facturaDoc.exists) {
                alert('Factura no encontrada.');
                return;
            }

            const data = facturaDoc.data();
            const jsPDF = window.jspdf.jsPDF;
            const doc = new jsPDF();
            
            doc.text(`Factura N¬∞ ${data.numeroFactura || facturaId.slice(0, 5)}`, 14, 20);
            doc.text(`Cliente: ${data.nombreCliente}`, 14, 30);
            doc.text(`C√©dula: ${data.cedulaCliente}`, 14, 40);
            doc.text(`Fecha: ${data.fechaCreacion.toDate().toLocaleDateString()}`, 14, 50);
            doc.text(`Vendedor: ${data.vendedor}`, 14, 60);

            const tableData = data.items.map(item => [
                item.descripcion,
                item.cantidad,
                `$${item.precio.toFixed(2)}`,
                `$${item.subtotal.toFixed(2)}`
            ]);

            doc.autoTable({
                startY: 70,
                head: [['Descripci√≥n', 'Cantidad', 'Precio Unitario', 'Subtotal']],
                body: tableData,
                foot: [['', '', 'TOTAL:', `$${data.total.toFixed(2)}`]],
                theme: 'striped',
                styles: { fontSize: 10, cellPadding: 2 },
                headStyles: { fillColor: [200, 200, 200] }
            });

            // Reemplazamos doc.save por doc.output para mostrar en una nueva ventana
            doc.output('dataurlnewwindow');
        }

        function limpiarFormularioFactura() {
            facturaEnEdicionId = null;
            todaLaInformacionFacturaEnEdicion = null;
            document.getElementById('formFactura').reset();
            document.getElementById('formFacturaTitle').textContent = 'Datos del Cliente y Nueva Venta';
            document.getElementById('guardarFacturaBtn').textContent = 'üíæ Guardar Venta';
            items = [];
            renderizarItems();
        }

        // ---------------------------------------------
        // FUNCIONES DE GESTI√ìN DE CLIENTES
        // ---------------------------------------------

        async function cargarClientes() {
            try {
                const snapshot = await db.collection('clientes').get();
                todosLosClientes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filtrarClientes();
            } catch (error) {
                console.error("Error al cargar los clientes:", error);
            }
        }

        function filtrarClientes() {
            const filtroNombre = document.getElementById('filtroClienteNombre').value.toLowerCase();
            const clientesFiltrados = todosLosClientes.filter(cliente => 
                cliente.nombre.toLowerCase().includes(filtroNombre) || cliente.cedula.includes(filtroNombre)
            );
            renderizarClientes(clientesFiltrados);
        }
let clienteEnEdicionId = null;
        function renderizarClientes(clientes) {
            const tableBody = document.getElementById('listaClientesTableBody');
            tableBody.innerHTML = '';
            clientes.forEach(cliente => {
                tableBody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 border-b border-gray-200">${cliente.cedula}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${cliente.nombre}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${cliente.telefono || ''}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${cliente.direccion || ''}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-center">
                            <button onclick="editarCliente('${cliente.id}')" class="text-blue-500 hover:text-blue-700 mx-1" title="Editar">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="eliminarCliente('${cliente.id}', '${cliente.nombre}')" class="text-red-500 hover:text-red-700 mx-1" title="Eliminar">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        async function editarCliente(clienteId) {
                const cliente = todosLosClientes.find(c => c.cedula === clienteId);
                if (cliente) {
                    clienteEnEdicionId = clienteId;
                    document.getElementById('editCedula').value = cliente.cedula;
                    document.getElementById('editNombre').value = cliente.nombre;
                    document.getElementById('editTelefono').value = cliente.telefono || '';
                    document.getElementById('editDireccion').value = cliente.direccion || '';
                    document.getElementById('formCliente').classList.remove('hidden');
                    mostrarMensaje('Cargando cliente para edici√≥n...', 'bg-blue-500');
                }
        }


        async function eliminarCliente(cedula, nombre) {
            if (confirm(`¬øEst√°s seguro de que quieres eliminar a ${nombre} con c√©dula ${cedula}? Esta acci√≥n no se puede deshacer.`)) {
                try {
                    console.log("Intentando eliminar cliente con c√©dula:", cedula); // Mensaje de depuraci√≥n
                    await db.collection('clientes').doc(cedula).delete();
                    mostrarMensaje(`‚úÖ Cliente ${nombre} eliminado con √©xito.`);
                    cargarClientes(); // Recarga la lista para mostrar el cambio
                } catch (error) {
                    console.error("‚ùå Error al eliminar cliente:", error);
                    mostrarMensaje('‚ùå Ocurri√≥ un error al eliminar el cliente.', 'bg-red-500');
                }
            }
        }
                // Nueva funci√≥n para guardar los cambios
        async function guardarCliente() {
            const cedula = document.getElementById('editCedula').value;
            const nombre = document.getElementById('editNombre').value;
            const telefono = document.getElementById('editTelefono').value;
            const direccion = document.getElementById('editDireccion').value;
        
            if (!cedula || !nombre) {
                mostrarMensaje('‚ùå Se necesita la c√©dula y el nombre.', 'bg-red-500');
                return;
            }
        
            try {
                const clienteRef = db.collection('clientes').doc(cedula);
                const clienteData = { nombre, telefono, direccion, cedula };
                
                await clienteRef.update(clienteData);
                mostrarMensaje(`‚úÖ Cliente ${nombre} actualizado con √©xito.`);
                
                limpiarFormularioCliente();
                cargarClientes();
            } catch (error) {
                console.error("Error al actualizar cliente:", error);
                mostrarMensaje('‚ùå Ocurri√≥ un error al actualizar el cliente.', 'bg-red-500');
            }
        }
        
        // Nueva funci√≥n para limpiar el formulario
        function limpiarFormularioCliente() {
            clienteEnEdicionId = null;
            document.getElementById('formCliente').reset();
            document.getElementById('formCliente').classList.add('hidden');
            document.getElementById('filtroClienteNombre').focus();
        }

        
        async function guardarClienteDesdeFactura() {
            const cedula = document.getElementById('cedulaCliente').value;
            const nombre = document.getElementById('nombreCliente').value;
            const telefono = document.getElementById('telefono').value;
            const direccion = document.getElementById('direccion').value;
        
            if (!cedula || !nombre) {
                mostrarMensaje('‚ùå Se necesita la c√©dula y el nombre para guardar un cliente.', 'bg-red-500');
                return;
            }
        
            try {
                const clienteRef = db.collection('clientes').doc(cedula);
                const doc = await clienteRef.get();
                
                // Datos a guardar, incluyendo la c√©dula
                const clienteData = { 
                    cedula, 
                    nombre, 
                    telefono, 
                    direccion 
                };
                
                if (doc.exists) {
                    await clienteRef.update(clienteData);
                    mostrarMensaje(`‚úÖ Cliente ${nombre} actualizado con √©xito.`);
                } else {
                    await clienteRef.set(clienteData);
                    mostrarMensaje(`‚úÖ Cliente ${nombre} guardado con √©xito.`);
                }
                
                cargarClientes();
            } catch (error) {
                console.error("Error al guardar cliente:", error);
                mostrarMensaje('‚ùå Ocurri√≥ un error al guardar el cliente.', 'bg-red-500');
            }
        }

        async function buscarClientePorCedula() {
            const cedula = document.getElementById('cedulaCliente').value;
            if (cedula.length > 0) {
                const clienteDoc = await db.collection('clientes').doc(cedula).get();
                if (clienteDoc.exists) {
                    const data = clienteDoc.data();
                    document.getElementById('nombreCliente').value = data.nombre;
                    document.getElementById('telefono').value = data.telefono || '';
                    document.getElementById('direccion').value = data.direccion || '';
                    mostrarMensaje(`Cliente ${data.nombre} encontrado.`, 'bg-blue-500');
                } else {
                    document.getElementById('nombreCliente').value = '';
                    document.getElementById('telefono').value = '';
                    document.getElementById('direccion').value = '';
                    mostrarMensaje('Cliente no encontrado. Puedes guardarlo si lo deseas.', 'bg-yellow-500');
                }
            }
        }

        // ---------------------------------------------
        // FUNCIONES DE GESTI√ìN DE PRODUCTOS Y SERVICIOS
        // ---------------------------------------------

        async function cargarProductosServicios() {
            try {
                const snapshot = await db.collection('productosYServicios').get();
                todosLosProductosYServicios = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filtrarProductos(); // Llama a la nueva funci√≥n de filtrado
                cargarOpcionesDeProductosEnCompras();
            } catch (error) {
                console.error("Error al cargar productos:", error);
            }
        }

        // Nueva funci√≥n de filtrado
        function filtrarProductos() {
            const filtroNombre = document.getElementById('filtroNombreProducto').value.toLowerCase();
            const filtroTipo = document.getElementById('filtroTipoProducto').value;
            const filtroVencimiento = document.getElementById('filtroVencimientoProducto').value;
        
            let productosFiltrados = todosLosProductosYServicios.filter(producto => {
                const coincideNombre = producto.nombre.toLowerCase().includes(filtroNombre);
                const coincideTipo = !filtroTipo || producto.tipo === filtroTipo;
        
                const coincideVencimiento = !filtroVencimiento || (producto.fechaVencimiento && producto.fechaVencimiento <= filtroVencimiento);
        
                return coincideNombre && coincideTipo && coincideVencimiento;
            });
        
            renderizarProductos(productosFiltrados);
        }
        
        // La funci√≥n renderizarProductos debe ser reemplazada
        function renderizarProductos(productos) {
            const tableBody = document.getElementById('listaProductosTableBody');
            tableBody.innerHTML = '';
            const today = new Date();
            
            productos.forEach(producto => {
                const fechaVencimiento = producto.fechaVencimiento ? new Date(producto.fechaVencimiento).toLocaleDateString() : 'N/A';
                const stock = producto.tipo === 'producto' ? producto.stock : 'N/A';
                
                let rowClass = '';
                if (producto.fechaVencimiento) {
                    const vencimiento = new Date(producto.fechaVencimiento);
                    const diffTime = vencimiento.getTime() - today.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays <= 30 && diffDays >= 0) {
                        rowClass = 'expiring-soon';
                    }
                }
                
                tableBody.innerHTML += `
                    <tr class="hover:bg-gray-50 ${rowClass}">
                        <td class="px-3 py-2 border-b border-gray-200">${producto.nombre}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${producto.tipo}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-right">$${producto.precio.toFixed(2)}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-center">${stock}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${fechaVencimiento}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-center">
                            <button onclick="editarProductoServicio('${producto.id}')" class="text-blue-500 hover:text-blue-700 mx-1" title="Editar">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="eliminarProductoServicio('${producto.id}', '${producto.nombre}')" class="text-red-500 hover:text-red-700 mx-1" title="Eliminar">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
            });
        }
        
        function toggleStockInput() {
            const tipo = document.getElementById('tipoProducto').value;
            const stockDiv = document.getElementById('stockInputDiv');
            if (tipo === 'servicio') {
                stockDiv.classList.add('hidden');
                document.getElementById('stockProducto').value = '0';
            } else {
                stockDiv.classList.remove('hidden');
            }
        }

        async function guardarProductoServicio() {
            const nombre = document.getElementById('nombreProducto').value;
            const tipo = document.getElementById('tipoProducto').value;
            const precio = parseFloat(document.getElementById('precioProducto').value);
            const stock = tipo === 'producto' ? parseInt(document.getElementById('stockProducto').value) : 0;
            const fechaVencimiento = document.getElementById('fechaVencimientoProducto').value;

            if (!nombre || isNaN(precio) || precio < 0) {
                mostrarMensaje('‚ùå Por favor, completa los campos de nombre y precio correctamente.', 'bg-red-500');
                return;
            }
            if (tipo === 'producto' && isNaN(stock)) {
                mostrarMensaje('‚ùå Por favor, ingresa un stock v√°lido.', 'bg-red-500');
                return;
            }

            try {
                const data = { nombre, tipo, precio, stock, fechaVencimiento };
                if (productoServicioEnEdicionId) {
                    await db.collection('productosYServicios').doc(productoServicioEnEdicionId).update(data);
                    mostrarMensaje(`‚úÖ "${nombre}" actualizado con √©xito.`);
                } else {
                    await db.collection('productosYServicios').add(data);
                    mostrarMensaje(`‚úÖ "${nombre}" guardado con √©xito.`);
                }
                
                limpiarFormularioProductoServicio();
                cargarProductosServicios();
                cargarDashboardData();

            } catch (error) {
                console.error("Error al guardar el producto/servicio:", error);
                mostrarMensaje('‚ùå Ocurri√≥ un error al guardar el producto/servicio.', 'bg-red-500');
            }
        }

        async function editarProductoServicio(itemId) {
            const doc = await db.collection('productosYServicios').doc(itemId).get();
            if (doc.exists) {
                const itemData = doc.data();
                productoServicioEnEdicionId = itemId;
                
                document.getElementById('formProductoServicioTitle').textContent = `Editar "${itemData.nombre}"`;
                document.getElementById('guardarProductoBtn').textContent = 'üíæ Actualizar';
                document.getElementById('nombreProducto').value = itemData.nombre;
                document.getElementById('tipoProducto').value = itemData.tipo;
                document.getElementById('precioProducto').value = itemData.precio;
                document.getElementById('stockProducto').value = itemData.stock || 0;
                document.getElementById('fechaVencimientoProducto').value = itemData.fechaVencimiento || '';
                toggleStockInput();
                mostrarSeccion('gestionProductosSection');
                mostrarMensaje(`"${itemData.nombre}" cargado para edici√≥n.`, "bg-blue-500");
            } else {
                mostrarMensaje("Producto/Servicio no encontrado para edici√≥n.", "bg-red-500");
            }
        }

        async function eliminarProductoServicio(itemId, itemName) {
            if (!confirm(`¬øEst√°s seguro de eliminar "${itemName}"?`)) {
                return;
            }
            try {
                await db.collection('productosYServicios').doc(itemId).delete();
                mostrarMensaje(`‚úÖ "${itemName}" eliminado con √©xito.`);
                cargarProductosServicios();
                cargarDashboardData();
            } catch (error) {
                console.error("Error al eliminar producto/servicio:", error);
                mostrarMensaje("‚ùå Hubo un error al eliminar el producto/servicio. Por favor, int√©ntalo de nuevo.", 'bg-red-500');
            }
        }

        function limpiarFormularioProductoServicio() {
            productoServicioEnEdicionId = null;
            document.getElementById('nombreProducto').value = '';
            document.getElementById('tipoProducto').value = 'producto';
            document.getElementById('precioProducto').value = '';
            document.getElementById('stockProducto').value = '0';
            toggleStockInput();
            document.getElementById('fechaVencimientoProducto').value = '';
            document.getElementById('formProductoServicioTitle').textContent = 'Gesti√≥n de Productos y Servicios';
            document.getElementById('guardarProductoBtn').textContent = 'üíæ Guardar Producto/Servicio';
            document.getElementById('nombreProducto').focus();
        }


        // Funci√≥n para renderizar la tabla de consulta de productos
function renderizarProductosConsulta(productos) {
    const tableBody = document.getElementById('listaProductosConsultaTableBody');
    tableBody.innerHTML = '';
    
    productos.forEach(producto => {
        // Encontrar la fecha de vencimiento m√°s lejana para este producto
        const comprasDelProducto = todasLasCompras.filter(c => c.productoId === producto.id);
        
        let fechaVencimientoMasLejana = 'N/A';
        if (comprasDelProducto.length > 0) {
            // Ordena las compras por fecha de vencimiento y toma la √∫ltima
            comprasDelProducto.sort((a, b) => new Date(a.fechaVencimiento) - new Date(b.fechaVencimiento));
            const ultimaCompra = comprasDelProducto[comprasDelProducto.length - 1];
            fechaVencimientoMasLejana = ultimaCompra.fechaVencimiento;
        }

        tableBody.innerHTML += `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">${producto.nombre}</td>
                <td class="px-6 py-4 whitespace-nowrap">${producto.stock || 0}</td>
                <td class="px-6 py-4 whitespace-nowrap">${fechaVencimientoMasLejana}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <button onclick="verDetallesLote('${producto.id}', '${producto.nombre}')" class="text-blue-600 hover:text-blue-900 font-bold">Ver Lotes</button>
                </td>
            </tr>
        `;
    });
}

// Funci√≥n para abrir el modal y mostrar los detalles del lote
function verDetallesLote(productoId, nombreProducto) {
    const loteModal = document.getElementById('loteModal');
    const loteDetallesTableBody = document.getElementById('loteDetallesTableBody');
    const loteProductoNombre = document.getElementById('loteProductoNombre');

    loteProductoNombre.textContent = `Producto: ${nombreProducto}`;
    loteDetallesTableBody.innerHTML = '';

    const comprasDelProducto = todasLasCompras.filter(c => c.productoId === productoId);
    
    if (comprasDelProducto.length > 0) {
        comprasDelProducto.forEach(compra => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">${compra.numeroFactura || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap">${compra.cantidad || 0}</td>
                <td class="px-6 py-4 whitespace-nowrap">${compra.fechaVencimiento || 'N/A'}</td>
            `;
            loteDetallesTableBody.appendChild(row);
        });
    } else {
        loteDetallesTableBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center">No se encontraron lotes para este producto.</td></tr>`;
    }

    loteModal.classList.remove('hidden');
}

// Event listener para el bot√≥n de cerrar el modal
document.getElementById('cerrarLoteModal').addEventListener('click', () => {
    document.getElementById('loteModal').classList.add('hidden');
});

// Event listener para la b√∫squeda en la tabla de productos
document.getElementById('filtroProducto').addEventListener('input', (e) => {
    const searchText = e.target.value.toLowerCase();
    const productosFiltrados = todosLosProductosYServicios.filter(p => p.nombre.toLowerCase().includes(searchText));
    renderizarProductosConsulta(productosFiltrados);
});

// Aseg√∫rate de llamar a esta funci√≥n al inicio de la carga de la p√°gina
// para que el rol de vendedor pueda ver la opci√≥n.
function controlarMenuPorRol() {
    const menuItemsAdmin = ['menu-dashboard', 'menu-facturas', 'menu-clientes', 'menu-productos', 'menu-compras', 'menu-usuarios'];
    const menuItemsVendedor = ['menu-nueva-venta', 'menu-facturas', 'menu-consulta-productos'];

    if (usuarioActual.rol === 'superusuario') {
        menuItemsAdmin.concat(menuItemsVendedor).forEach(itemId => {
            const item = document.getElementById(itemId);
            if (item) {
                item.classList.remove('hidden');
            }
        });
        return;
    }
    
    if (usuarioActual.rol === 'admin') {
        menuItemsAdmin.forEach(itemId => {
            const item = document.getElementById(itemId);
            if (item) {
                item.classList.remove('hidden');
            }
        });
    } else { // Vendedor
        menuItemsAdmin.forEach(itemId => {
            const item = document.getElementById(itemId);
            if (item) {
                item.classList.add('hidden');
            }
        });
        menuItemsVendedor.forEach(itemId => {
            const item = document.getElementById(itemId);
            if (item) {
                item.classList.remove('hidden');
            }
        });
    }
}

        // ---------------------------------------------
        // FUNCIONES DE GESTI√ìN DE COMPRAS
        // ---------------------------------------------

        async function cargarCompras() {
            try {
                const snapshot = await db.collection('compras').orderBy('fecha', 'desc').get();
                todasLasCompras = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filtrarCompras();
            } catch (error) {
                console.error("Error al cargar las compras:", error);
            }
        }

        function filtrarCompras() {
            const filtroAnio = document.getElementById('filtroComprasAnio').value;
            const filtroMes = document.getElementById('filtroComprasMes').value;
            
            let comprasFiltradas = todasLasCompras;

            if (filtroAnio) {
                comprasFiltradas = comprasFiltradas.filter(compra => new Date(compra.fecha).getFullYear() === parseInt(filtroAnio));
            }
            
            if (filtroMes) {
                comprasFiltradas = comprasFiltradas.filter(compra => (new Date(compra.fecha).getMonth() + 1) === parseInt(filtroMes));
            }
            
            renderizarCompras(comprasFiltradas);
        }


      function renderizarCompras(compras) {
    const tableBody = document.getElementById('listaComprasTableBody');
    tableBody.innerHTML = '';
    
    let totalInversion = 0;
    
    compras.forEach(compra => {
        const costo = compra.costo || 0;
        const total = compra.totalCompra || (compra.cantidad * costo) || 0;
        
        totalInversion += total;
        
        let accionesHtml = '';
        // Condici√≥n para mostrar los botones de editar y eliminar
        if (usuarioActual.rol === 'superusuario' || usuarioActual.rol === 'admin') {
            accionesHtml = `
                <button onclick="editarCompra('${compra.id}')" class="text-blue-500 hover:text-blue-700 font-bold px-2">‚úèÔ∏è</button>
                <button onclick="eliminarCompra('${compra.id}')" class="text-red-500 hover:text-red-700 font-bold px-2">üóëÔ∏è</button>
            `;
        } else {
            accionesHtml = 'N/A';
        }
        
        tableBody.innerHTML += `
            <tr class="hover:bg-gray-50">
                <td class="px-3 py-2 border-b border-gray-200">${compra.numeroFactura || 'N/A'}</td>
                <td class="px-3 py-2 border-b border-gray-200">${compra.nombreProducto || 'N/A'}</td>
                <td class="px-3 py-2 border-b border-gray-200 text-center">${compra.cantidad || 'N/A'}</td>
                <td class="px-3 py-2 border-b border-gray-200 text-right">$${parseFloat(costo).toFixed(2)}</td>
                <td class="px-3 py-2 border-b border-gray-200 text-right">$${parseFloat(total).toFixed(2)}</td>
                <td class="px-3 py-2 border-b border-gray-200">${compra.fecha || 'N/A'}</td>
                <td class="px-3 py-2 border-b border-gray-200">${compra.usuario || 'N/A'}</td>
                <td class="px-3 py-2 border-b border-gray-200 text-right">${accionesHtml}</td>
            </tr>
        `;
    });
    
    const summaryFooter = document.getElementById('comprasSummaryFooter');
    if (summaryFooter) {
        summaryFooter.innerHTML = `
            <tr class="bg-gray-50 font-semibold">
                <td colspan="5" class="text-right px-3 py-2 border-t border-gray-200 text-gray-800">Total de Inversi√≥n:</td>
                <td class="px-3 py-2 border-t border-gray-200 text-right text-gray-800">$${totalInversion.toFixed(2)}</td>
                <td colspan="2" class="px-3 py-2 border-t border-gray-200"></td>
            </tr>
        `;
    }
}

        function cargarOpcionesDeProductosEnCompras() {
            const select = document.getElementById('productoCompra');
            select.innerHTML = '<option value="">Seleccione un producto</option>';
            todosLosProductosYServicios.filter(p => p.tipo === 'producto').forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.nombre}</option>`;
            });
        }



async function eliminarCompra(id) {
    if (!confirm('¬øEst√°s seguro de que quieres eliminar esta compra?')) {
        return;
    }
    try {
        const compraRef = db.collection('compras').doc(id);
        const compraDoc = await compraRef.get();
        const compraData = compraDoc.data();
        
        // Disminuir el stock del producto
        const productoRef = db.collection('productosYServicios').doc(compraData.productoId);
        const productoDoc = await productoRef.get();
        const productoStockActual = productoDoc.data().stock;
        
        await productoRef.update({
            stock: productoStockActual - compraData.cantidad
        });
        
        // Eliminar la compra
        await compraRef.delete();
        
        mostrarMensaje('‚úÖ Compra eliminada con √©xito y stock actualizado.');
        cargarCompras();
        cargarProductosServicios();
    } catch (error) {
        console.error("Error al eliminar la compra:", error);
        mostrarMensaje('‚ùå Error al eliminar la compra.', 'bg-red-500');
    }
}

// Variable global para rastrear el ID del documento en edici√≥n
let idCompraEnEdicion = null;

async function editarCompra(id) {
    try {
        const doc = await db.collection('compras').doc(id).get();
        const compra = doc.data();

        // Asigna los valores al formulario
        document.getElementById('fechaCompra').value = compra.fecha;
        document.getElementById('productoCompra').value = compra.productoId;
        document.getElementById('cantidadCompra').value = compra.cantidad;
        document.getElementById('costoCompra').value = compra.costo;
        document.getElementById('fechaVencimientoCompra').value = compra.fechaVencimiento || ''; // Manejo de valor nulo
        document.getElementById('numeroFacturaCompra').value = compra.numeroFactura || ''; // Manejo de valor nulo
        
        // Cambia el texto del bot√≥n y guarda el ID en una variable global
        const btnGuardarCompra = document.getElementById('btnGuardarCompra');
        if (btnGuardarCompra) {
            btnGuardarCompra.textContent = 'üìù Actualizar Compra';
        }

        idCompraEnEdicion = id;
        mostrarSeccion('gestionComprasSection'); // Redirecciona a la secci√≥n si no est√°s en ella

        mostrarMensaje('‚úèÔ∏è Ahora puedes editar los detalles de la compra en el formulario.');
        
    } catch (error) {
        console.error("Error al cargar datos para edici√≥n:", error);
        mostrarMensaje('‚ùå Error al cargar los datos de la compra.', 'bg-red-500');
    }
}

// Actualiza tu funci√≥n guardarCompra para manejar la edici√≥n
// La variable global para el usuario que est√° usando la aplicaci√≥n
//let usuarioActual = JSON.parse(localStorage.getItem('usuarioActual'));

async function guardarCompra() {
    const fechaCompra = document.getElementById('fechaCompra').value;
    const productoId = document.getElementById('productoCompra').value;
    const cantidad = parseInt(document.getElementById('cantidadCompra').value);
    const costo = parseFloat(document.getElementById('costoCompra').value);
    const fechaVencimiento = document.getElementById('fechaVencimientoCompra').value;
    const numeroFactura = document.getElementById('numeroFacturaCompra').value;
    const totalCompra = cantidad * costo;

    if (!fechaCompra || !productoId || isNaN(cantidad) || cantidad <= 0 || isNaN(costo) || costo < 0) {
        mostrarMensaje('‚ùå Por favor, complete todos los campos de la compra correctamente.', 'bg-red-500');
        return;
    }

    try {
        const usuario = usuarioActual.nombre; // Obtiene el nombre del usuario logueado
        const producto = todosLosProductosYServicios.find(p => p.id === productoId);
        
        if (idCompraEnEdicion) {
            // L√≥gica para editar una compra
            const compraOriginalDoc = await db.collection('compras').doc(idCompraEnEdicion).get();
            const compraOriginal = compraOriginalDoc.data();
            
            // Revertir el stock original si se cambi√≥ el producto
            if (compraOriginal.productoId !== productoId) {
                await db.collection('productosYServicios').doc(compraOriginal.productoId).update({
                    stock: firebase.firestore.FieldValue.increment(-compraOriginal.cantidad)
                });
                await db.collection('productosYServicios').doc(productoId).update({
                    stock: firebase.firestore.FieldValue.increment(cantidad)
                });
            } else {
                const diferenciaCantidad = cantidad - compraOriginal.cantidad;
                await db.collection('productosYServicios').doc(productoId).update({
                    stock: firebase.firestore.FieldValue.increment(diferenciaCantidad)
                });
            }

            // Actualiza el documento de compra, incluyendo el usuario actual
            await db.collection('compras').doc(idCompraEnEdicion).update({
                fecha: fechaCompra,
                productoId,
                nombreProducto: producto.nombre,
                cantidad,
                costo,
                totalCompra,
                fechaVencimiento,
                numeroFactura,
                usuario: usuario // Asegura que el campo "usuario" se actualice
            });

            mostrarMensaje('‚úÖ Compra actualizada y stock ajustado.');
            document.getElementById('btnGuardarCompra').textContent = 'üíæ Registrar Compra';
            idCompraEnEdicion = null;

        } else {
            // L√≥gica para una nueva compra
            await db.collection('compras').add({
                fecha: fechaCompra,
                productoId,
                nombreProducto: producto.nombre,
                cantidad,
                costo,
                totalCompra,
                fechaVencimiento,
                usuario: usuario, // Guarda el usuario actual
                numeroFactura,
                fechaRegistro: new Date()
            });

            const nuevoStock = producto.stock + cantidad;
            await db.collection('productosYServicios').doc(productoId).update({
                stock: nuevoStock
            });
            mostrarMensaje('‚úÖ Compra registrada y stock actualizado con √©xito.');
        }

        // Se limpia el formulario
        document.getElementById('formCompra').reset();
        // Se vuelve a llenar el campo "registrado por" con el nombre del usuario
        document.getElementById('usuarioCompra').value = usuario;

        cargarCompras();
        cargarProductosServicios();
    } catch (error) {
        console.error("Error al guardar/actualizar la compra:", error);
        mostrarMensaje('‚ùå Ocurri√≥ un error al procesar la compra.', 'bg-red-500');
    }
}


        
        // ---------------------------------------------
        // FUNCIONES DEL DASHBOARD
        // ---------------------------------------------
        async function cargarDashboardData() {
            try {
                // Productos con mayor stock
                const productosConStock = todosLosProductosYServicios.filter(p => p.tipo === 'producto').sort((a, b) => b.stock - a.stock).slice(0, 5);
                const topStockList = document.getElementById('topStockProductsList');
                topStockList.innerHTML = productosConStock.length > 0 ? productosConStock.map(p => `<li>${p.nombre} (${p.stock} uds)</li>`).join('') : '<li>No hay productos con stock.</li>';
                
                // Productos por vencer
                const today = new Date();
                const expiringProducts = todosLosProductosYServicios.filter(p => {
                    if (p.fechaVencimiento) {
                        const vencimiento = new Date(p.fechaVencimiento);
                        const diffTime = vencimiento.getTime() - today.getTime();
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        return diffDays <= 30 && diffDays >= 0;
                    }
                    return false;
                });
                const expiringList = document.getElementById('expiringProductsList');
                expiringList.innerHTML = expiringProducts.length > 0 ? expiringProducts.map(p => `<li>${p.nombre} (Vence en ${Math.ceil((new Date(p.fechaVencimiento).getTime() - today.getTime()) / (1000 * 60 * 60 * 24))} d√≠as)</li>`).join('') : '<li>No hay productos pr√≥ximos a vencer.</li>';

                // Productos m√°s vendidos
                const ventasPorProducto = {};
                const ventasPorVendedor = {};
                const facturasSnapshot = await db.collection('facturas').get();
                facturasSnapshot.forEach(doc => {
                    const venta = doc.data();
                    venta.items.forEach(item => {
                        ventasPorProducto[item.descripcion] = (ventasPorProducto[item.descripcion] || 0) + item.cantidad;
                    });
                    ventasPorVendedor[venta.vendedor] = (ventasPorVendedor[venta.vendedor] || 0) + venta.total;
                });

                const sortedProducts = Object.entries(ventasPorProducto).sort(([, a], [, b]) => b - a).slice(0, 5);
                const topSellingList = document.getElementById('topSellingProductsList');
                topSellingList.innerHTML = sortedProducts.length > 0 ? sortedProducts.map(([producto, cantidad]) => `<li>${producto}: ${cantidad} unidades</li>`).join('') : '<li>No hay ventas registradas.</li>';

                const sortedUsers = Object.entries(ventasPorVendedor).sort(([, a], [, b]) => b - a).slice(0, 5);
                const topSellingUsersList = document.getElementById('topSellingUsersList');
                topSellingUsersList.innerHTML = sortedUsers.length > 0 ? sortedUsers.map(([usuario, total]) => `<li>${usuario}: $${total.toFixed(2)}</li>`).join('') : '<li>No hay ventas registradas.</li>';

            } catch (error) {
                console.error("Error al cargar datos del dashboard:", error);
                mostrarMensaje('‚ùå Error al cargar los datos del dashboard.', 'bg-red-500');
            }
        }

        // Cargar a√±os para los filtros
        function cargarAniosFiltros() {
            const anios = new Set();
            todasLasFacturas.forEach(f => anios.add(f.fechaCreacion.toDate().getFullYear()));
            todasLasCompras.forEach(c => anios.add(new Date(c.fecha).getFullYear()));

            const filtroVentasAnio = document.getElementById('filtroVentasAnio');
            const filtroComprasAnio = document.getElementById('filtroComprasAnio');
            filtroVentasAnio.innerHTML = '<option value="">Todos</option>';
            filtroComprasAnio.innerHTML = '<option value="">Todos</option>';

            const sortedAnios = Array.from(anios).sort((a, b) => b - a);
            sortedAnios.forEach(anio => {
                filtroVentasAnio.innerHTML += `<option value="${anio}">${anio}</option>`;
                filtroComprasAnio.innerHTML += `<option value="${anio}">${anio}</option>`;
            });
        }

        async function cargarDatosIniciales() {
            await Promise.all([
                cargarFacturas(),
                cargarClientes(),
                cargarProductosServicios(),
                cargarCompras()
            ]);
            cargarAniosFiltros();
            cargarDashboardData();
        }
        
        document.getElementById('descripcion').addEventListener('input', function() {
            const input = this.value.toLowerCase();
            const sugerenciasUl = document.getElementById('sugerencias');
            if (input.length > 0) {
                const sugerencias = todosLosProductosYServicios.filter(p => p.nombre.toLowerCase().includes(input));
                sugerenciasUl.innerHTML = '';
                sugerencias.forEach(sug => {
                    const li = document.createElement('li');
                    li.textContent = sug.nombre;
                    li.classList.add('px-4', 'py-2', 'cursor-pointer', 'hover:bg-gray-100');
                    li.addEventListener('click', () => {
                        document.getElementById('descripcion').value = sug.nombre;
                        document.getElementById('precio').value = sug.precio;
                        sugerenciasUl.classList.add('hidden');
                    });
                    sugerenciasUl.appendChild(li);
                });
                sugerenciasUl.classList.remove('hidden');
            } else {
                sugerenciasUl.classList.add('hidden');
            }
        });
        
        document.addEventListener('click', function(event) {
            const sugerenciasUl = document.getElementById('sugerencias');
            const descripcionInput = document.getElementById('descripcion');
            if (!sugerenciasUl.contains(event.target) && event.target !== descripcionInput) {
                sugerenciasUl.classList.add('hidden');
            }
        });

    </script>
</body>
</html>
