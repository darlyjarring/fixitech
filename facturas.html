<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Facturaci√≥n y Compras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        .sidebar {
            width: 250px;
        }
        .main-content {
            margin-left: 250px;
        }
        .menu-item.active {
            background-color: #3f83f8;
            color: white;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-content, .printable-content * {
                visibility: visible;
            }
            .printable-content {
                position: absolute;
                left: 0;
                top: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex min-h-screen">

    <div id="loginSection" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-3xl font-bold text-center text-teal-600 mb-6">Iniciar Sesi√≥n Fixitech</h2>
            <p id="error" class="text-red-600 mt-4 text-center hidden">Credenciales incorrectas</p>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="usuario" class="block text-gray-700 font-medium mb-2">Usuario:</label>
                    <input type="text" id="usuario" name="usuario" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Ej: admin" required>
                </div>
                 <div class="mb-4">
                    <label for="password" class="block text-gray-700 font-medium mb-2">Contrase√±a:</label>
                    <input type="password" id="password" name="password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Contrase√±a" required>
                </div>
                <button type="button" onclick="login()" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition duration-300">Ingresar</button>
            </form>
        </div>
    </div>

    <div id="sidebar" class="sidebar bg-gray-800 text-white flex-shrink-0 fixed h-full p-4 flex flex-col hidden">
        <h1 class="text-2xl font-bold mb-6 text-center text-teal-400">Sistema de Venta</h1>
        <nav class="flex-grow">
            <ul>
                <li id="menu-dashboard" class="mb-2 hidden">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('dashboardSection')">
                        <span class="mr-2">üìä</span> Dashboard
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 active" onclick="mostrarSeccion('nuevaVentaSection')">
                        <span class="mr-2">üí∞</span> Nueva Venta
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('gestionFacturasSection')">
                        <span class="mr-2">üìã</span> Gesti√≥n de Ventas
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('gestionClientesSection')">
                        <span class="mr-2">üßë‚Äçü§ù‚Äçüßë</span> Gesti√≥n de Clientes
                    </a>
                </li>
                <li id="menu-productos" class="mb-2 hidden">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('gestionProductosSection')">
                        <span class="mr-2">üì¶</span> Productos y Servicios
                    </a>
                </li>
                <li id="menu-compras" class="mb-2 hidden">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" onclick="mostrarSeccion('gestionComprasSection')">
                        <span class="mr-2">üõí</span> Gesti√≥n de Compras
                    </a>
                </li>
            </ul>
        </nav>
        <div class="mt-auto text-center text-gray-400 text-sm">
            <p>Bienvenido, <span id="userNameDisplay" class="font-bold"></span></p>
            <p>Rol: <span id="userRoleDisplay" class="font-bold"></span></p>
            <button class="mt-2 text-red-400 hover:text-red-300" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <div id="main-content" class="main-content flex-grow p-8 hidden">
        
        <div id="dashboardSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-3xl font-semibold mb-6 text-gray-800">Dashboard de Gerencia üìä</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-blue-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-blue-800 mb-4">Productos con Mayor Stock üì¶</h3>
                    <ul id="topStockProductsList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
                <div class="bg-yellow-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-yellow-800 mb-4">Productos por Vencer ‚è≥</h3>
                    <ul id="expiringProductsList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
                <div class="bg-green-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-green-800 mb-4">Productos M√°s Vendidos üìà</h3>
                    <ul id="topSellingProductsList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
                <div class="bg-purple-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-purple-800 mb-4">Vendedores con M√°s Ventas üèÜ</h3>
                    <ul id="topSellingUsersList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="nuevaVentaSection" class="bg-white rounded-lg shadow-md p-6">
            <h2 id="formFacturaTitle" class="text-2xl font-semibold mb-6 text-gray-800">Datos del Cliente y Nueva Venta</h2>
            
            <form id="formFactura" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-4 mb-4">
                    <div class="relative">
                        <label for="cedulaCliente" class="block text-sm font-medium text-gray-700">C√©dula</label>
                        <input type="text" id="cedulaCliente" placeholder="C√©dula del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" onblur="buscarClientePorCedula()">
                    </div>
                    <div class="relative">
                        <label for="nombreCliente" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="nombreCliente" placeholder="Nombre Completo del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                        <button type="button" onclick="guardarClienteDesdeFactura()" class="absolute right-2 top-8 text-sm bg-gray-200 hover:bg-gray-300 p-1 rounded-md" title="Guardar este cliente">üíæ</button>
                    </div>
                    <div>
                        <label for="telefono" class="block text-sm font-medium text-gray-700">Tel√©fono</label>
                        <input type="text" id="telefono" placeholder="N√∫mero de Tel√©fono" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="direccion" class="block text-sm font-medium text-gray-700">Direcci√≥n</label>
                        <input type="text" id="direccion" placeholder="Direcci√≥n del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-1 relative">
                        <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripci√≥n</label>
                        <input type="text" id="descripcion" placeholder="Descripci√≥n del Art√≠culo/Servicio" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" />
                        <ul id="sugerencias" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-48 overflow-y-auto hidden"></ul>
                    </div>
                    <div class="md:col-span-1">
                        <label for="cantidad" class="block text-sm font-medium text-gray-700">Cantidad</label>
                        <input type="number" id="cantidad" value="1" min="1" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div class="md:col-span-1">
                        <label for="precio" class="block text-sm font-medium text-gray-700">Precio Unitario</label>
                        <input type="number" id="precio" placeholder="Precio" step="0.01" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div class="md:col-span-1 flex items-end">
                        <button type="button" onclick="agregarItem()" class="w-full bg-teal-500 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-600 transition duration-200">
                            + Agregar √çtem
                        </button>
                    </div>
                </div>
            </form>

            <div class="mt-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">√çtems de la Venta</h3>
                <div class="bg-gray-50 rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripci√≥n</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unitario</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="tablaItems" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        <tfoot>
                            <tr class="bg-gray-100">
                                <td colspan="3" class="px-3 py-2 text-right font-bold text-lg text-gray-800">Total:</td>
                                <td colspan="2" class="px-3 py-2 text-right font-bold text-lg text-gray-800" id="total">$0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
            <div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="fechaIngreso" class="block text-sm font-medium text-gray-700">Fecha de Ingreso</label>
                    <input type="date" id="fechaIngreso" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="fechaEntrega" class="block text-sm font-medium text-gray-700">Fecha de Entrega</label>
                    <input type="date" id="fechaEntrega" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="estado" class="block text-sm font-medium text-gray-700">Estado</label>
                    <select id="estado" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                        <option value="En espera">En espera</option>
                        <option value="Facturado">Facturado</option>
                        <option value="Entregado">Entregado</option>
                    </select>
                </div>
                <div>
                    <label for="vendedor" class="block text-sm font-medium text-gray-700">Vendedor</label>
                    <input type="text" id="vendedor" class="mt-1 p-2 block w-full border border-gray-300 rounded-md bg-gray-200" readonly>
                </div>
            </div>
            
            <div class="flex justify-end space-x-4 mt-8">
                <button type="button" onclick="mostrarFactura()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                    üîç Previsualizar
                </button>
                <button type="button" id="guardarFacturaBtn" onclick="guardarFactura()" class="bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition duration-200">
                    üíæ Guardar Venta
                </button>
            </div>
        </div>

        <div id="gestionFacturasSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Ventas</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div>
                    <label for="filtroVentasAnio" class="block text-sm font-medium text-gray-700">A√±o</label>
                    <select id="filtroVentasAnio" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div>
                    <label for="filtroVentasMes" class="block text-sm font-medium text-gray-700">Mes</label>
                    <select id="filtroVentasMes" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                        <option value="">Todos</option>
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div>
                    <label for="filtroVentasHoraInicial" class="block text-sm font-medium text-gray-700">Hora Inicial</label>
                    <input type="time" id="filtroVentasHoraInicial" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="filtroVentasHoraFinal" class="block text-sm font-medium text-gray-700">Hora Final</label>
                    <input type="time" id="filtroVentasHoraFinal" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N¬∞ Factura</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendedor</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaFacturasTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="gestionClientesSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Clientes</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="filtroClienteNombre" class="block text-sm font-medium text-gray-700">Buscar por Nombre o C√©dula</label>
                    <input type="text" id="filtroClienteNombre" oninput="filtrarClientes()" placeholder="Ej: Ana L√≥pez" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√©dula</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tel√©fono</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Direcci√≥n</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaClientesTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div id="gestionProductosSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 id="formProductoServicioTitle" class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Productos y Servicios</h2>
            
            <form id="formProductoServicio" class="space-y-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label for="nombreProducto" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="nombreProducto" placeholder="Nombre del Producto/Servicio" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="tipoProducto" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="tipoProducto" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" onchange="toggleStockInput()">
                            <option value="producto">Producto</option>
                            <option value="servicio">Servicio</option>
                        </select>
                    </div>
                    <div>
                        <label for="precioProducto" class="block text-sm font-medium text-gray-700">Precio de Venta</label>
                        <input type="number" id="precioProducto" placeholder="Precio" step="0.01" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div id="stockInputDiv">
                        <label for="stockProducto" class="block text-sm font-medium text-gray-700">Stock Inicial</label>
                        <input type="number" id="stockProducto" value="0" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="fechaVencimientoProducto" class="block text-sm font-medium text-gray-700">Fecha de Vencimiento</label>
                        <input type="date" id="fechaVencimientoProducto" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                <div class="flex justify-end">
                    <button type="button" id="guardarProductoBtn" onclick="guardarProductoServicio()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                        üíæ Guardar Producto/Servicio
                    </button>
                </div>
            </form>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vencimiento</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaProductosTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="gestionComprasSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Compras</h2>
            
            <form id="formCompra" class="space-y-4 mb-6">
                <h3 class="text-xl font-semibold mb-2">Registrar Nueva Compra</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label for="fechaCompra" class="block text-sm font-medium text-gray-700">Fecha</label>
                        <input type="date" id="fechaCompra" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="productoCompra" class="block text-sm font-medium text-gray-700">Producto</label>
                        <select id="productoCompra" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                            </select>
                    </div>
                    <div>
                        <label for="cantidadCompra" class="block text-sm font-medium text-gray-700">Cantidad</label>
                        <input type="number" id="cantidadCompra" value="1" min="1" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="costoCompra" class="block text-sm font-medium text-gray-700">Costo Unitario</label>
                        <input type="number" id="costoCompra" placeholder="Costo" step="0.01" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="facturaCompra" class="block text-sm font-medium text-gray-700">N¬∞ Factura Proveedor</label>
                        <input type="text" id="facturaCompra" placeholder="N¬∞ de Factura" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="usuarioCompra" class="block text-sm font-medium text-gray-700">Registrado por</label>
                        <input type="text" id="usuarioCompra" class="mt-1 p-2 block w-full border border-gray-300 rounded-md bg-gray-200" readonly>
                    </div>
                    <div class="flex items-end justify-end">
                        <button type="button" onclick="guardarCompra()" class="bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition duration-200">
                            üíæ Registrar Compra
                        </button>
                    </div>
                </div>
            </form>
            
            <h3 class="text-xl font-semibold mb-4">Historial de Compras</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                <div>
                    <label for="filtroComprasAnio" class="block text-sm font-medium text-gray-700">A√±o</label>
                    <select id="filtroComprasAnio" onchange="filtrarCompras()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div>
                    <label for="filtroComprasMes" class="block text-sm font-medium text-gray-700">Mes</label>
                    <select id="filtroComprasMes" onchange="filtrarCompras()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                        <option value="">Todos</option>
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div>
                    <label for="filtroComprasDia" class="block text-sm font-medium text-gray-700">D√≠a</label>
                    <input type="number" id="filtroComprasDia" onchange="filtrarCompras()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="filtroComprasHoraInicial" class="block text-sm font-medium text-gray-700">Hora Inicial</label>
                    <input type="time" id="filtroComprasHoraInicial" onchange="filtrarCompras()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="filtroComprasHoraFinal" class="block text-sm font-medium text-gray-700">Hora Final</label>
                    <input type="time" id="filtroComprasHoraFinal" onchange="filtrarCompras()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Costo Unit.</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Factura</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                        </tr>
                    </thead>
                    <tbody id="listaComprasTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    <tfoot id="comprasSummaryFooter">
                        </tfoot>
                </table>
            </div>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
    <script src="firebase.js"></script> 
    <script>
        const db = firebase.firestore();
        let items = [];
        let todasLasFacturas = []; 
        let facturaEnEdicionId = null; 
        let todaLaInformacionFacturaEnEdicion = null; 
        
        let todosLosClientes = []; 
        let todosLosProductosYServicios = []; 
        let productoServicioEnEdicionId = null; 

        let todasLasCompras = []; 
        
        let currentLoggedInUser = null; 
        
        // --- L√ìGICA DE LOGIN INTEGRADA ---
        async function login() {
            const usuario = document.getElementById('usuario').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('error');

            const doc = await db.collection('usuarios').doc(usuario).get();
            
            if (doc.exists && doc.data().password === password) {
                errorElement.classList.add('hidden');
                currentLoggedInUser = {
                    username: usuario,
                    rol: doc.data().rol,
                    nombre: doc.data().nombre,
                };
                
                // Ocultar login y mostrar el sistema
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('userNameDisplay').textContent = currentLoggedInUser.nombre;
                document.getElementById('userRoleDisplay').textContent = currentLoggedInUser.rol.toUpperCase();
                
                // Configurar permisos y secci√≥n inicial
                if (currentLoggedInUser.rol === 'admin') {
                    document.getElementById('menu-dashboard').classList.remove('hidden');
                    document.getElementById('menu-productos').classList.remove('hidden');
                    document.getElementById('menu-compras').classList.remove('hidden');
                    mostrarSeccion('dashboardSection');
                } else {
                    document.getElementById('menu-dashboard').classList.add('hidden');
                    document.getElementById('menu-productos').classList.add('hidden');
                    document.getElementById('menu-compras').classList.add('hidden');
                    mostrarSeccion('nuevaVentaSection');
                }
                document.getElementById('vendedor').value = currentLoggedInUser.nombre;

            } else {
                errorElement.classList.remove('hidden');
            }
        }
        
        function logout() {
            currentLoggedInUser = null;
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('usuario').value = '';
            document.getElementById('password').value = '';
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
        }

        function mostrarMensaje(mensaje, colorClass = 'bg-blue-500') {
            const container = document.createElement('div');
            container.className = `fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-md shadow-lg text-white ${colorClass} transition-all duration-300 z-50`;
            container.textContent = mensaje;
            document.body.appendChild(container);
            setTimeout(() => {
                container.classList.add('opacity-0', 'translate-y-4');
                container.addEventListener('transitionend', () => container.remove());
            }, 3000);
        }

        function limpiarFormulario() {
            document.getElementById('cedulaCliente').value = '';
            document.getElementById('nombreCliente').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('direccion').value = '';
            document.getElementById('fechaIngreso').value = new Date().toISOString().split('T')[0];
            document.getElementById('fechaEntrega').value = new Date().toISOString().split('T')[0];
            document.getElementById('estado').value = 'En espera';
            items = [];
            actualizarTabla();
            
            facturaEnEdicionId = null;
            todaLaInformacionFacturaEnEdicion = null;
            document.getElementById('formFacturaTitle').textContent = 'Datos del Cliente y Nueva Venta';
            document.getElementById('guardarFacturaBtn').textContent = 'üíæ Guardar Venta';
        }

        function limpiarFormularioCompra() {
            document.getElementById('fechaCompra').value = new Date().toISOString().split('T')[0];
            document.getElementById('productoCompra').value = '';
            document.getElementById('cantidadCompra').value = '1';
            document.getElementById('costoCompra').value = '';
            document.getElementById('facturaCompra').value = '';
            document.getElementById('usuarioCompra').value = currentLoggedInUser.nombre;
        }

        function limpiarFormularioProductoServicio() {
            document.getElementById('nombreProducto').value = '';
            document.getElementById('tipoProducto').value = 'producto';
            document.getElementById('precioProducto').value = '';
            document.getElementById('stockProducto').value = '0';
            document.getElementById('fechaVencimientoProducto').value = '';
            document.getElementById('stockInputDiv').classList.remove('hidden');
            productoServicioEnEdicionId = null;
            document.getElementById('formProductoServicioTitle').textContent = 'Gesti√≥n de Productos y Servicios';
            document.getElementById('guardarProductoBtn').textContent = 'üíæ Guardar Producto/Servicio';
        }


        async function mostrarSeccion(sectionId) {
            document.querySelectorAll('div[id$="Section"]').forEach(section => {
                section.classList.add('hidden');
            });
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`a[onclick="mostrarSeccion('${sectionId}')"]`).classList.add('active');

            document.getElementById(sectionId).classList.remove('hidden');

            if (sectionId === 'nuevaVentaSection') {
                if (facturaEnEdicionId === null) { 
                    limpiarFormulario();
                    document.getElementById('vendedor').value = currentLoggedInUser.nombre;
                }
                if (todosLosProductosYServicios.length === 0) {
                     await cargarProductosServicios();
                }
            } else if (sectionId === 'gestionFacturasSection') {
                cargarFacturas(); 
                facturaEnEdicionId = null; 
                todaLaInformacionFacturaEnEdicion = null;
            } else if (sectionId === 'gestionClientesSection') {
                cargarClientes();
            } else if (sectionId === 'gestionProductosSection') {
                limpiarFormularioProductoServicio();
                cargarProductosServicios();
            } else if (sectionId === 'gestionComprasSection') {
                limpiarFormularioCompra();
                cargarProductosParaCompras(); 
                cargarCompras(); 
            } else if (sectionId === 'dashboardSection') {
                cargarDashboard();
            }
        }


        // Inicializar las fechas a la fecha actual y mostrar la secci√≥n de nueva venta
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fechaIngreso').value = today;
            document.getElementById('fechaEntrega').value = today;
            document.getElementById('fechaCompra').value = today; 
            actualizarTabla(); 
        });
        
        // Autocompletado de items
        const descripcionInput = document.getElementById('descripcion');
        const sugerenciasUl = document.getElementById('sugerencias');

        descripcionInput.addEventListener('input', () => {
            const query = descripcionInput.value.toLowerCase();
            sugerenciasUl.innerHTML = '';

            if (query.length < 2) {
                sugerenciasUl.classList.add('hidden');
                return;
            }

            const resultados = todosLosProductosYServicios.filter(item => 
                item.nombre.toLowerCase().includes(query)
            );

            if (resultados.length > 0) {
                resultados.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'p-2 cursor-pointer hover:bg-gray-100';
                    li.textContent = `${item.nombre} - $${item.precio.toFixed(2)}`;
                    li.addEventListener('click', () => {
                        descripcionInput.value = item.nombre;
                        document.getElementById('precio').value = item.precio;
                        document.getElementById('cantidad').value = 1;
                        sugerenciasUl.classList.add('hidden');
                    });
                    sugerenciasUl.appendChild(li);
                });
                sugerenciasUl.classList.remove('hidden');
            } else {
                sugerenciasUl.classList.add('hidden');
            }
        });
        // Ocultar sugerencias al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!sugerenciasUl.contains(e.target) && !descripcionInput.contains(e.target)) {
                sugerenciasUl.classList.add('hidden');
            }
        });


        function agregarItem() {
            const descripcionInput = document.getElementById('descripcion');
            const cantidadInput = document.getElementById('cantidad');
            const precioInput = document.getElementById('precio');

            const descripcion = descripcionInput.value.trim();
            const cantidad = parseInt(cantidadInput.value);
            const precio = parseFloat(precioInput.value);

            if (!descripcion || isNaN(cantidad) || cantidad <= 0 || isNaN(precio) || precio < 0) {
                mostrarMensaje('Por favor, ingresa una descripci√≥n v√°lida, una cantidad positiva y un precio unitario no negativo.', 'bg-red-500');
                return;
            }

            const subtotal = cantidad * precio;
            items.push({ descripcion, cantidad, precio, subtotal });

            // Limpiar campos despu√©s de agregar
            descripcionInput.value = '';
            cantidadInput.value = '1';
            precioInput.value = '';
            descripcionInput.focus();

            actualizarTabla();
        }

        function actualizarTabla() {
            const tabla = document.getElementById('tablaItems');
            const totalEl = document.getElementById('total');
            tabla.innerHTML = '';
            let total = 0;

            if (items.length === 0) {
                tabla.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No hay √≠tems agregados a√∫n.</td></tr>`;
                totalEl.textContent = `$0.00`;
                return;
            }

            items.forEach((item, index) => {
                total += item.subtotal;
                tabla.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 border-b border-gray-200">${item.descripcion}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-center">${item.cantidad}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-right">$${item.precio.toFixed(2)}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-right">$${item.subtotal.toFixed(2)}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-center">
                            <button onclick="eliminarItem(${index})" class="text-red-600 hover:text-red-800 transition duration-150 ease-in-out" title="Eliminar √çtem">‚úñ</button>
                        </td>
                    </tr>
                `;
            });
            totalEl.textContent = `$${total.toFixed(2)}`;
        }

        function eliminarItem(index) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este √≠tem?')) {
                items.splice(index, 1);
                actualizarTabla();
            }
        }

        function formatInvoiceNumber(number) {
            const year = new Date().getFullYear();
            const paddedNumber = String(number).padStart(6, '0');
            return `${paddedNumber}${year.toString().substring(2)}`;
        }

        async function guardarFactura() {
            const clienteCedula = document.getElementById('cedulaCliente').value.trim();
            const clienteNombre = document.getElementById('nombreCliente').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const direccion = document.getElementById('direccion').value.trim();
            const fechaIngreso = document.getElementById('fechaIngreso').value;
            const fechaEntrega = document.getElementById('fechaEntrega').value;
            const estado = document.getElementById('estado').value;
            const vendedor = document.getElementById('vendedor').value.trim();
            const total = items.reduce((sum, item) => sum + item.subtotal, 0);

            if (!vendedor || (!clienteCedula && !clienteNombre)) {
                mostrarMensaje('Por favor, ingresa el Vendedor y al menos la C√©dula o el Nombre del cliente.', 'bg-red-500');
                return;
            }
            if (!telefono || !direccion || !fechaIngreso || !fechaEntrega) {
                mostrarMensaje('Por favor, completa el Tel√©fono, Direcci√≥n y las Fechas.', 'bg-red-500');
                return;
            }
            if (items.length === 0) {
                mostrarMensaje('La venta debe contener al menos un √≠tem.', 'bg-red-500');
                return;
            }
            if (new Date(fechaIngreso) > new Date(fechaEntrega)) {
                mostrarMensaje('La fecha de entrega no puede ser anterior a la fecha de ingreso.', 'bg-red-500');
                return;
            }

            let message = '';
            let docRef;

            if (facturaEnEdicionId) {
                docRef = db.collection('facturas').doc(facturaEnEdicionId);
            } else {
                docRef = db.collection('facturas').doc();
            }
            
            try {
                if (estado === 'Facturado') {
                    await db.runTransaction(async (transaction) => {
                        const counterRef = db.collection('contadores').doc('facturas');
                        const counterDoc = await transaction.get(counterRef);
                        const pedidoDoc = await transaction.get(docRef);

                        if (pedidoDoc.exists) {
                            const stockPromises = items.map(item => {
                                const producto = todosLosProductosYServicios.find(p => p.nombre === item.descripcion && p.tipo === 'producto');
                                if (producto) {
                                    const productoRef = db.collection('productosYServicios').doc(producto.id);
                                    return transaction.get(productoRef);
                                }
                                return Promise.resolve(null);
                            });
                            const stockDocs = await Promise.all(stockPromises);

                            stockDocs.forEach((stockDoc, index) => {
                                if (stockDoc && stockDoc.exists) {
                                    const stockActual = stockDoc.data().stock || 0;
                                    const cantidadVendida = items[index].cantidad;
                                    const nuevoStock = stockActual - cantidadVendida;
                                    if (nuevoStock < 0) {
                                        throw new Error(`No hay suficiente stock para el producto "${items[index].descripcion}". Stock actual: ${stockActual}.`);
                                    }
                                    transaction.update(stockDoc.ref, { stock: nuevoStock });
                                }
                            });
                        }
                        
                        let currentNumber = counterDoc.exists ? (counterDoc.data().ultimoNumero || 0) : 0;
                        const newNumber = currentNumber + 1;
                        const invoiceNumber = formatInvoiceNumber(newNumber);
                        
                        transaction.update(counterRef, { ultimoNumero: newNumber });
                        
                        const data = {
                            numeroFactura: invoiceNumber,
                            clienteCedula: clienteCedula || null,
                            clienteNombre: clienteNombre || null, 
                            telefono,
                            direccion,
                            fechaIngreso,
                            fechaEntrega,
                            estado,
                            items: items.map(item => ({ descripcion: item.descripcion, cantidad: item.cantidad, precio: item.precio, subtotal: item.subtotal })),
                            total: parseFloat(total.toFixed(2)),
                            facturadoPor: vendedor,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        transaction.set(docRef, data);
                    });
                    message = facturaEnEdicionId ? `‚úÖ Pedido facturado y stock actualizado con √©xito.` : `‚úÖ Factura guardada y stock actualizado con √©xito.`;
                } else {
                    const data = {
                        numeroFactura: null,
                        clienteCedula: clienteCedula || null,
                        clienteNombre: clienteNombre || null, 
                        telefono,
                        direccion,
                        fechaIngreso,
                        fechaEntrega,
                        estado,
                        items: items.map(item => ({ descripcion: item.descripcion, cantidad: item.cantidad, precio: item.precio, subtotal: item.subtotal })),
                        total: parseFloat(total.toFixed(2)),
                        facturadoPor: vendedor,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await docRef.set(data);
                    message = facturaEnEdicionId ? `‚úÖ Pedido actualizado con √©xito.` : `‚úÖ Pedido de venta guardado con √©xito.`;
                }

                mostrarMensaje(message);
                limpiarFormulario();
                cargarFacturas(); 

            } catch (error) {
                console.error("Error al guardar/actualizar la venta: ", error);
                mostrarMensaje("‚ùå Hubo un error al guardar/actualizar la venta. Por favor, int√©ntalo de nuevo. Detalles: " + error.message, 'bg-red-500');
            }
        }
        
        async function cargarFacturaParaEdicion(facturaId) {
            const factura = todasLasFacturas.find(f => f.id === facturaId);
            if (!factura) {
                mostrarMensaje('Venta no encontrada para editar.', 'bg-red-500');
                return;
            }

            if (factura.estado === 'Facturado') {
                mostrarMensaje('No se pueden editar las ventas que ya han sido facturadas.', 'bg-red-500');
                return;
            }

            facturaEnEdicionId = facturaId;
            todaLaInformacionFacturaEnEdicion = factura;

            document.getElementById('cedulaCliente').value = factura.clienteCedula || '';
            document.getElementById('nombreCliente').value = factura.clienteNombre || '';
            document.getElementById('telefono').value = factura.telefono || '';
            document.getElementById('direccion').value = factura.direccion || '';
            document.getElementById('fechaIngreso').value = factura.fechaIngreso;
            document.getElementById('fechaEntrega').value = factura.fechaEntrega;
            document.getElementById('estado').value = factura.estado;
            document.getElementById('vendedor').value = factura.facturadoPor;

            items = factura.items;
            actualizarTabla();

            document.getElementById('formFacturaTitle').textContent = `Editando Venta`;
            document.getElementById('guardarFacturaBtn').textContent = 'üíæ Actualizar Venta';

            mostrarSeccion('nuevaVentaSection');
        }

        async function cargarFacturas() {
            const tableBody = document.getElementById('listaFacturasTableBody');
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Cargando ventas...</td></tr>';
            todasLasFacturas = [];
            try {
                const querySnapshot = await db.collection('facturas').orderBy('timestamp', 'desc').get();
                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No hay ventas registradas.</td></tr>';
                    return;
                }
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    todasLasFacturas.push({ id: doc.id, ...data });
                });
                
                const anosUnicos = [...new Set(todasLasFacturas.map(f => new Date(f.timestamp.toDate()).getFullYear().toString()))].sort().reverse();
                const filtroVentasAnio = document.getElementById('filtroVentasAnio');
                filtroVentasAnio.innerHTML = '<option value="">Todos</option>';
                anosUnicos.forEach(ano => {
                    const option = document.createElement('option');
                    option.value = ano;
                    option.textContent = ano;
                    filtroVentasAnio.appendChild(option);
                });

                filtrarFacturas();
            } catch (error) {
                console.error("Error al cargar las facturas: ", error);
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-500">Error al cargar las ventas.</td></tr>';
            }
        }

        function filtrarFacturas() {
            const tableBody = document.getElementById('listaFacturasTableBody');
            tableBody.innerHTML = '';
            
            const filtroAnio = document.getElementById('filtroVentasAnio').value;
            const filtroMes = document.getElementById('filtroVentasMes').value;
            const filtroHoraInicial = document.getElementById('filtroVentasHoraInicial').value;
            const filtroHoraFinal = document.getElementById('filtroVentasHoraFinal').value;

            const facturasFiltradas = todasLasFacturas.filter(factura => {
                const timestamp = factura.timestamp ? new Date(factura.timestamp.toDate()) : null;
                if (!timestamp) return false;

                const facturaAnio = timestamp.getFullYear().toString();
                const facturaMes = (timestamp.getMonth() + 1).toString();
                const facturaHora = timestamp.toTimeString().split(' ')[0];

                const anioMatch = !filtroAnio || facturaAnio === filtroAnio;
                const mesMatch = !filtroMes || facturaMes === filtroMes;
                const horaInicialMatch = !filtroHoraInicial || facturaHora >= filtroHoraInicial;
                const horaFinalMatch = !filtroHoraFinal || facturaHora <= filtroHoraFinal;

                return anioMatch && mesMatch && horaInicialMatch && horaFinalMatch;
            });

            if (facturasFiltradas.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No se encontraron ventas con los filtros aplicados.</td></tr>';
                return;
            }

            facturasFiltradas.forEach(factura => {
                const fecha = factura.timestamp ? factura.timestamp.toDate().toLocaleString() : 'N/A';
                const numeroFacturaDisplay = factura.numeroFactura || `<span class="bg-yellow-100 text-yellow-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">Pendiente</span>`;
                const accionesHTML = factura.estado === 'Facturado'
                    ? `<button onclick="verDetalleFactura('${factura.id}')" class="text-blue-600 hover:text-blue-800 transition duration-150 ease-in-out mr-2" title="Ver Detalle">üëÅÔ∏è</button>`
                    : `<button onclick="verDetalleFactura('${factura.id}')" class="text-blue-600 hover:text-blue-800 transition duration-150 ease-in-out mr-2" title="Ver Detalle">üëÅÔ∏è</button>
                       <button onclick="cargarFacturaParaEdicion('${factura.id}')" class="text-green-600 hover:text-green-800 transition duration-150 ease-in-out mr-2" title="Editar">‚úèÔ∏è</button>`;

                tableBody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 border-b border-gray-200">${numeroFacturaDisplay}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${factura.clienteNombre || factura.clienteCedula || 'N/A'}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-right">$${factura.total.toFixed(2)}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${factura.facturadoPor || 'N/A'}</td>
                        <td class="px-3 py-2 border-b border-gray-200">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                factura.estado === 'Facturado' ? 'bg-green-100 text-green-800' :
                                factura.estado === 'En espera' ? 'bg-yellow-100 text-yellow-800' :
                                factura.estado === 'Entregado' ? 'bg-blue-100 text-blue-800' :
                                'bg-gray-100 text-gray-800'
                            }">
                                ${factura.estado}
                            </span>
                        </td>
                        <td class="px-3 py-2 border-b border-gray-200">${fecha}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-center">
                            ${accionesHTML}
                        </td>
                    </tr>
                `;
            });
        }
        
        async function verDetalleFactura(facturaId) {
            const facturaDoc = await db.collection('facturas').doc(facturaId).get();
            if (!facturaDoc.exists) {
                mostrarMensaje('Venta no encontrada.', 'bg-red-500');
                return;
            }
            const data = facturaDoc.data();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const title = data.numeroFactura ? `Factura N¬∞ ${data.numeroFactura}` : `Pedido N¬∞ ${facturaId.substring(0, 8)}`;
            doc.text(title, 15, 15);
            
            let y = 25;
            doc.setFontSize(10);
            doc.text(`Cliente: ${data.clienteNombre || 'N/A'}`, 15, y);
            doc.text(`C√©dula: ${data.clienteCedula || 'N/A'}`, 15, y + 5);
            doc.text(`Fecha de Ingreso: ${data.fechaIngreso}`, 100, y);
            doc.text(`Fecha de Entrega: ${data.fechaEntrega}`, 100, y + 5);
            doc.text(`Vendedor: ${data.facturadoPor || 'N/A'}`, 15, y + 10);
            
            y += 20;
            doc.autoTable({
                startY: y,
                head: [['Descripci√≥n', 'Cantidad', 'Precio Unitario', 'Subtotal']],
                body: data.items.map(item => [item.descripcion, item.cantidad, `$${item.precio.toFixed(2)}`, `$${item.subtotal.toFixed(2)}`]),
                foot: [['', '', 'Total:', `$${data.total.toFixed(2)}`]],
                theme: 'striped'
            });

            const popup = window.open('', '_blank', 'width=800,height=600');
            const pdfUrl = doc.output('datauristring');
            popup.document.write(`
                <iframe width='100%' height='100%' src='${pdfUrl}'></iframe>
            `);
        }

        async function guardarClienteDesdeFactura() {
            const cedula = document.getElementById('cedulaCliente').value.trim();
            const nombre = document.getElementById('nombreCliente').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const direccion = document.getElementById('direccion').value.trim();

            if (!cedula || !nombre) {
                mostrarMensaje('Por favor, ingresa la c√©dula y el nombre del cliente para registrar.', 'bg-red-500');
                return;
            }

            try {
                const clienteExistente = await db.collection('clientes').doc(cedula).get();
                const clienteData = {
                    nombre,
                    telefono,
                    direccion,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('clientes').doc(cedula).set(clienteData, { merge: true });
                if (clienteExistente.exists) {
                    mostrarMensaje('Cliente actualizado con √©xito.');
                } else {
                    mostrarMensaje('Cliente registrado con √©xito.');
                }
            } catch (error) {
                console.error("Error al registrar/actualizar el cliente: ", error);
                mostrarMensaje("Error al registrar/actualizar el cliente. Por favor, int√©ntalo de nuevo.", 'bg-red-500');
            }
        }
        
        async function buscarClientePorCedula() {
            const cedulaInput = document.getElementById('cedulaCliente').value.trim();
            const nombreInput = document.getElementById('nombreCliente');
            const telefonoInput = document.getElementById('telefono');
            const direccionInput = document.getElementById('direccion');

            if (cedulaInput.length === 0) {
                return;
            }

            try {
                const clienteDoc = await db.collection('clientes').doc(cedulaInput).get();
                if (clienteDoc.exists) {
                    const data = clienteDoc.data();
                    nombreInput.value = data.nombre || '';
                    telefonoInput.value = data.telefono || '';
                    direccionInput.value = data.direccion || '';
                    mostrarMensaje('Cliente encontrado.', 'bg-green-500');
                } else {
                    telefonoInput.value = '';
                    direccionInput.value = '';
                    mostrarMensaje('Cliente no encontrado. Puedes ingresarlo y guardarlo.', 'bg-yellow-500');
                }
            } catch (error) {
                console.error("Error al buscar cliente: ", error);
                mostrarMensaje("Error al buscar el cliente.", 'bg-red-500');
            }
        }
        

        async function cargarClientes() {
            const tableBody = document.getElementById('listaClientesTableBody');
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Cargando clientes...</td></tr>';
            todosLosClientes = [];
            try {
                const querySnapshot = await db.collection('clientes').get();
                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No hay clientes registrados.</td></tr>';
                    return;
                }
                
                querySnapshot.forEach(doc => {
                    todosLosClientes.push({ id: doc.id, ...doc.data() });
                });
                
                filtrarClientes();
            } catch (error) {
                console.error("Error al cargar los clientes: ", error);
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Error al cargar los clientes.</td></tr>';
            }
        }

        function filtrarClientes() {
            const filtroNombre = document.getElementById('filtroClienteNombre').value.toLowerCase();
            const tableBody = document.getElementById('listaClientesTableBody');
            tableBody.innerHTML = '';
            
            const clientesFiltrados = todosLosClientes.filter(cliente => 
                (cliente.nombre && cliente.nombre.toLowerCase().includes(filtroNombre)) ||
                (cliente.id && cliente.id.toLowerCase().includes(filtroNombre))
            );

            if (clientesFiltrados.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No se encontraron clientes con los filtros aplicados.</td></tr>';
                 return;
            }

            clientesFiltrados.forEach(cliente => {
                tableBody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 border-b border-gray-200">${cliente.id}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${cliente.nombre || 'N/A'}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${cliente.telefono || 'N/A'}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${cliente.direccion || 'N/A'}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-center">
                            <button onclick="editarCliente('${cliente.id}')" class="text-green-600 hover:text-green-800 transition duration-150 ease-in-out" title="Editar">‚úèÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
        }

        async function editarCliente(clienteId) {
            mostrarMensaje('Esta funci√≥n est√° pendiente de implementar.', 'bg-gray-500');
        }

        function toggleStockInput() {
            const tipo = document.getElementById('tipoProducto').value;
            const stockInputDiv = document.getElementById('stockInputDiv');
            if (tipo === 'servicio') {
                stockInputDiv.classList.add('hidden');
                document.getElementById('stockProducto').value = 0;
            } else {
                stockInputDiv.classList.remove('hidden');
            }
        }

        async function guardarProductoServicio() {
            const nombre = document.getElementById('nombreProducto').value.trim();
            const tipo = document.getElementById('tipoProducto').value;
            const precio = parseFloat(document.getElementById('precioProducto').value);
            const stock = tipo === 'producto' ? parseInt(document.getElementById('stockProducto').value) : 0;
            const fechaVencimiento = document.getElementById('fechaVencimientoProducto').value || null;

            if (!nombre || isNaN(precio) || precio < 0 || (tipo === 'producto' && (isNaN(stock) || stock < 0))) {
                mostrarMensaje('Por favor, completa todos los campos correctamente.', 'bg-red-500');
                return;
            }

            try {
                const data = {
                    nombre,
                    tipo,
                    precio,
                    stock: stock,
                    fechaVencimiento,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (productoServicioEnEdicionId) {
                    await db.collection('productosYServicios').doc(productoServicioEnEdicionId).set(data, { merge: true });
                    mostrarMensaje('Producto/Servicio actualizado con √©xito.');
                } else {
                    await db.collection('productosYServicios').add(data);
                    mostrarMensaje('Producto/Servicio guardado con √©xito.');
                }

                limpiarFormularioProductoServicio();
                cargarProductosServicios();
            } catch (error) {
                console.error("Error al guardar/actualizar el producto/servicio: ", error);
                mostrarMensaje("Error al guardar/actualizar el producto/servicio. " + error.message, 'bg-red-500');
            }
        }

        async function cargarProductosServicios() {
            const tableBody = document.getElementById('listaProductosTableBody');
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Cargando productos y servicios...</td></tr>';
            todosLosProductosYServicios = [];
            try {
                const querySnapshot = await db.collection('productosYServicios').get();
                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No hay productos ni servicios registrados.</td></tr>';
                    return;
                }
                
                querySnapshot.forEach(doc => {
                    todosLosProductosYServicios.push({ id: doc.id, ...doc.data() });
                });
                
                tableBody.innerHTML = '';
                todosLosProductosYServicios.forEach(item => {
                    const stockDisplay = item.tipo === 'producto' ? item.stock : 'N/A';
                    const vencimientoDisplay = item.fechaVencimiento || 'N/A';
                    tableBody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-3 py-2 border-b border-gray-200">${item.nombre}</td>
                            <td class="px-3 py-2 border-b border-gray-200">${item.tipo}</td>
                            <td class="px-3 py-2 border-b border-gray-200 text-right">$${item.precio.toFixed(2)}</td>
                            <td class="px-3 py-2 border-b border-gray-200 text-center">${stockDisplay}</td>
                            <td class="px-3 py-2 border-b border-gray-200">${vencimientoDisplay}</td>
                            <td class="px-3 py-2 border-b border-gray-200 text-center">
                                <button onclick="editarProductoServicio('${item.id}')" class="text-green-600 hover:text-green-800 transition duration-150 ease-in-out" title="Editar">‚úèÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Error al cargar los productos y servicios: ", error);
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Error al cargar los datos.</td></tr>';
            }
        }

        function editarProductoServicio(itemId) {
            const item = todosLosProductosYServicios.find(p => p.id === itemId);
            if (!item) {
                mostrarMensaje('√çtem no encontrado para editar.', 'bg-red-500');
                return;
            }

            productoServicioEnEdicionId = itemId;

            document.getElementById('nombreProducto').value = item.nombre;
            document.getElementById('tipoProducto').value = item.tipo;
            document.getElementById('precioProducto').value = item.precio;
            document.getElementById('stockProducto').value = item.stock;
            document.getElementById('fechaVencimientoProducto').value = item.fechaVencimiento || '';
            toggleStockInput();

            document.getElementById('formProductoServicioTitle').textContent = `Editando: ${item.nombre}`;
            document.getElementById('guardarProductoBtn').textContent = 'üíæ Actualizar';

            mostrarSeccion('gestionProductosSection');
        }
        
        async function guardarCompra() {
            const fechaCompra = document.getElementById('fechaCompra').value;
            const productoId = document.getElementById('productoCompra').value;
            const cantidad = parseInt(document.getElementById('cantidadCompra').value);
            const costo = parseFloat(document.getElementById('costoCompra').value);
            const numeroFactura = document.getElementById('facturaCompra').value.trim();
            const usuario = document.getElementById('usuarioCompra').value.trim();
            
            if (!fechaCompra || !productoId || isNaN(cantidad) || cantidad <= 0 || isNaN(costo) || costo < 0 || !numeroFactura || !usuario) {
                mostrarMensaje('Por favor, completa todos los campos del formulario de compra correctamente.', 'bg-red-500');
                return;
            }

            try {
                const comprasRef = db.collection('compras');
                const facturaExistente = await comprasRef.where('numeroFactura', '==', numeroFactura).limit(1).get();
                if (!facturaExistente.empty) {
                    mostrarMensaje(`El n√∫mero de factura "${numeroFactura}" ya ha sido registrado.`, 'bg-red-500');
                    return;
                }

                const newCompraRef = comprasRef.doc(); 

                await db.runTransaction(async (transaction) => {
                    const productoRef = db.collection('productosYServicios').doc(productoId);
                    const productoDoc = await transaction.get(productoRef);
                    if (!productoDoc.exists) {
                        throw new Error("El producto seleccionado no existe.");
                    }
                    const stockActual = productoDoc.data().stock || 0;
                    const nuevoStock = stockActual + cantidad;
                    
                    transaction.update(productoRef, { stock: nuevoStock });
                    
                    const nombreProducto = productoDoc.data().nombre;
                    const compraData = {
                        fecha: fechaCompra,
                        productoId,
                        nombreProducto,
                        cantidad,
                        costo,
                        totalCompra: cantidad * costo,
                        numeroFactura,
                        usuario,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    transaction.set(newCompraRef, compraData); 
                });

                mostrarMensaje('‚úÖ Compra registrada y stock actualizado con √©xito.');
                limpiarFormularioCompra();
                cargarCompras(); 
                
            } catch (error) {
                console.error("Error al registrar la compra: ", error);
                mostrarMensaje("‚ùå Error al registrar la compra. " + error.message, 'bg-red-500');
            }
        }
        
        async function cargarProductosParaCompras() {
            const select = document.getElementById('productoCompra');
            select.innerHTML = '<option value="">Cargando...</option>';
            try {
                const querySnapshot = await db.collection('productosYServicios').where('tipo', '==', 'producto').get();
                select.innerHTML = '<option value="">Selecciona un producto</option>';
                querySnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = data.nombre;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Error al cargar productos para el formulario de compras: ", error);
                select.innerHTML = '<option value="">Error al cargar</option>';
            }
        }
        
        async function cargarCompras() {
            const tableBody = document.getElementById('listaComprasTableBody');
            const summaryFooter = document.getElementById('comprasSummaryFooter');
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Cargando compras...</td></tr>';
            summaryFooter.innerHTML = '';
            todasLasCompras = [];

            try {
                const querySnapshot = await db.collection('compras').orderBy('timestamp', 'desc').get();
                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No hay compras registradas.</td></td>';
                    return;
                }
                
                querySnapshot.forEach(doc => {
                    todasLasCompras.push({ id: doc.id, ...doc.data() });
                });
                
                const anosUnicos = [...new Set(todasLasCompras.map(c => new Date(c.timestamp.toDate()).getFullYear().toString()))].sort().reverse();
                const filtroComprasAnio = document.getElementById('filtroComprasAnio');
                filtroComprasAnio.innerHTML = '<option value="">Todos</option>';
                anosUnicos.forEach(ano => {
                    const option = document.createElement('option');
                    option.value = ano;
                    option.textContent = ano;
                    filtroComprasAnio.appendChild(option);
                });
                
                filtrarCompras();
            } catch (error) {
                console.error("Error al cargar las compras: ", error);
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-500">Error al cargar las compras.</td></tr>';
            }
        }

        function filtrarCompras() {
            const tableBody = document.getElementById('listaComprasTableBody');
            const summaryFooter = document.getElementById('comprasSummaryFooter');
            
            tableBody.innerHTML = '';
            summaryFooter.innerHTML = '';
            
            let totalGeneral = 0;
            let totalUnidades = 0;
            
            const filtroAnio = document.getElementById('filtroComprasAnio').value;
            const filtroMes = document.getElementById('filtroComprasMes').value;
            const filtroDia = document.getElementById('filtroComprasDia').value;
            const filtroHoraInicial = document.getElementById('filtroComprasHoraInicial').value;
            const filtroHoraFinal = document.getElementById('filtroComprasHoraFinal').value;


            const comprasFiltradas = todasLasCompras.filter(compra => {
                const timestamp = compra.timestamp ? new Date(compra.timestamp.toDate()) : null;
                if (!timestamp) return false;

                const compraAnio = timestamp.getFullYear().toString();
                const compraMes = (timestamp.getMonth() + 1).toString();
                const compraDia = timestamp.getDate().toString();
                const compraHora = timestamp.toTimeString().split(' ')[0];
                
                const anioMatch = !filtroAnio || compraAnio === filtroAnio;
                const mesMatch = !filtroMes || compraMes === filtroMes;
                const diaMatch = !filtroDia || compraDia === filtroDia;
                const horaInicialMatch = !filtroHoraInicial || compraHora >= filtroHoraInicial;
                const horaFinalMatch = !filtroHoraFinal || compraHora <= filtroHoraFinal;
                
                return anioMatch && mesMatch && diaMatch && horaInicialMatch && horaFinalMatch;
            });
            
            if (comprasFiltradas.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No se encontraron compras con los filtros aplicados.</td></tr>';
                 return;
            }

            comprasFiltradas.forEach(compra => {
                totalGeneral += compra.totalCompra;
                totalUnidades += compra.cantidad;
                tableBody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 border-b border-gray-200">${compra.timestamp.toDate().toLocaleString()}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${compra.nombreProducto}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-center">${compra.cantidad}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-right">$${compra.costo.toFixed(2)}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-right">$${compra.totalCompra.toFixed(2)}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${compra.numeroFactura}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${compra.usuario}</td>
                    </tr>
                `;
            });
            
            summaryFooter.innerHTML = `
                <tr class="bg-gray-50 font-semibold">
                    <td colspan="2" class="text-right px-3 py-2 border-t border-gray-200 text-gray-800">Totales:</td>
                    <td class="px-3 py-2 border-t border-gray-200 text-center text-gray-800">${totalUnidades}</td>
                    <td class="border-t border-gray-200"></td>
                    <td class="px-3 py-2 border-t border-gray-200 text-right text-gray-800">$${totalGeneral.toFixed(2)}</td>
                    <td colspan="2" class="border-t border-gray-200"></td>
                </tr>
            `;
        }
        
        async function cargarDashboard() {
            const topStockList = document.getElementById('topStockProductsList');
            const expiringList = document.getElementById('expiringProductsList');
            const topSellingList = document.getElementById('topSellingProductsList');
            const topSellingUsersList = document.getElementById('topSellingUsersList');

            topStockList.innerHTML = '<li>Cargando...</li>';
            expiringList.innerHTML = '<li>Cargando...</li>';
            topSellingList.innerHTML = '<li>Cargando...</li>';
            topSellingUsersList.innerHTML = '<li>Cargando...</li>';

            // Productos con mayor stock
            const productosQuery = await db.collection('productosYServicios').where('tipo', '==', 'producto').orderBy('stock', 'desc').limit(5).get();
            topStockList.innerHTML = '';
            productosQuery.forEach(doc => {
                const data = doc.data();
                topStockList.innerHTML += `<li>${data.nombre} (${data.stock} uds)</li>`;
            });
            if (productosQuery.empty) topStockList.innerHTML = '<li>No hay productos en stock.</li>';

            // Productos por vencer (dentro de 30 d√≠as)
            const today = new Date();
            const thirtyDaysLater = new Date();
            thirtyDaysLater.setDate(today.getDate() + 30);
            
            const productosVencimientoQuery = await db.collection('productosYServicios')
                .where('fechaVencimiento', '>', today.toISOString().split('T')[0])
                .where('fechaVencimiento', '<=', thirtyDaysLater.toISOString().split('T')[0])
                .get();

            expiringList.innerHTML = '';
            productosVencimientoQuery.forEach(doc => {
                const data = doc.data();
                expiringList.innerHTML += `<li>${data.nombre} (vence el ${data.fechaVencimiento})</li>`;
            });
            if (productosVencimientoQuery.empty) expiringList.innerHTML = '<li>No hay productos por vencer.</li>';

            // Productos m√°s vendidos
            const ventasQuery = await db.collection('facturas').where('estado', '==', 'Facturado').get();
            const ventasPorProducto = {};
            const ventasPorUsuario = {};
            
            ventasQuery.forEach(factura => {
                const data = factura.data();
                data.items.forEach(item => {
                    ventasPorProducto[item.descripcion] = (ventasPorProducto[item.descripcion] || 0) + item.cantidad;
                });
                const vendedor = data.facturadoPor || 'N/A';
                ventasPorUsuario[vendedor] = (ventasPorUsuario[vendedor] || 0) + data.total;
            });
            
            const sortedProductos = Object.entries(ventasPorProducto).sort(([, a], [, b]) => b - a).slice(0, 5);
            topSellingList.innerHTML = '';
            if (sortedProductos.length > 0) {
                sortedProductos.forEach(([producto, cantidad]) => {
                    topSellingList.innerHTML += `<li>${producto} (${cantidad} uds)</li>`;
                });
            } else {
                topSellingList.innerHTML = '<li>No hay ventas registradas.</li>';
            }

            // Vendedores con m√°s ventas
            const sortedUsers = Object.entries(ventasPorUsuario).sort(([, a], [, b]) => b - a).slice(0, 5);
            topSellingUsersList.innerHTML = '';
            if (sortedUsers.length > 0) {
                sortedUsers.forEach(([usuario, totalVentas]) => {
                    topSellingUsersList.innerHTML += `<li>${usuario}: $${totalVentas.toFixed(2)}</li>`;
                });
            } else {
                topSellingUsersList.innerHTML = '<li>No hay ventas registradas.</li>';
            }
        }
    </script>
</body>
</html>
