<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Gesti√≥n de Ventas - Fixitech</title> <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Estilos b√°sicos para la ventana emergente de detalle de factura */
        .popup-invoice-container {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            color: #333;
            max-width: 800px;
            margin: 20px auto;
            border: 1px solid #eee;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            background-color: #fff;
        }
        .popup-invoice-container h2 {
            text-align: center;
            color: #0f766e;
            margin-bottom: 25px;
        }
        .popup-invoice-container .info-section {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas peque√±as */
        }
        .popup-invoice-container .info-section > div {
            flex: 1;
            min-width: 280px; /* Asegura un ancho m√≠nimo para cada columna */
            margin-right: 20px;
            margin-bottom: 10px;
        }
        .popup-invoice-container .info-section > div:last-child {
            margin-right: 0;
        }
        .popup-invoice-container p {
            margin: 5px 0;
            line-height: 1.4;
        }
        .popup-invoice-container strong {
            color: #555;
        }
        .popup-invoice-container table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .popup-invoice-container th,
        .popup-invoice-container td {
            border: 1px solid #ddd;
            padding: 10px 8px;
            text-align: left;
        }
        .popup-invoice-container th {
            background-color: #f8f8f8;
            color: #666;
            font-weight: 600;
        }
        .popup-invoice-container tfoot tr.total-row td {
            background-color: #f0f0f0;
            font-weight: bold;
            text-align: right;
        }
        .popup-invoice-container .text-right {
            text-align: right;
        }
        .popup-invoice-container .text-center {
            text-align: center;
        }
        .popup-invoice-container .btn-actions {
            text-align: center;
            margin-top: 30px;
        }
        .popup-invoice-container .btn-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }
        .popup-invoice-container .btn-actions .btn-print {
            background-color: #0f766e; /* Teal */
            color: white;
            margin-right: 10px;
        }
        .popup-invoice-container .btn-actions .btn-close {
            background-color: #6b7280; /* Gray */
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <header class="bg-cyan-800 text-white p-4 flex justify-between items-center shadow">
        <h1 class="text-xl font-bold">Fixitech - Gesti√≥n de Ventas</h1>
        <nav class="space-x-4 text-sm">
            <a href="#" class="hover:underline">Inicio</a>
            <a href="#" class="hover:underline">Clientes</a>
            <a href="#" class="hover:underline">Nueva Venta</a> <a href="#gestionFacturas" class="hover:underline">Gesti√≥n de Facturas</a> <a href="#" class="hover:underline">Galer√≠a</a>
        </nav>
    </header>

    <div class="max-w-6xl mx-auto mt-6 bg-white p-6 rounded shadow">
        <h2 class="font-semibold text-lg mb-4">Datos del Cliente y Nueva Factura</h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <div>
                <label for="cliente" class="block text-sm font-medium text-gray-700">C√©dula o Nombre:</label>
                <input type="text" id="cliente" placeholder="C√©dula o Nombre del Cliente" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" />
            </div>
            <div>
                <label for="telefono" class="block text-sm font-medium text-gray-700">Tel√©fono:</label>
                <input type="text" id="telefono" placeholder="Tel√©fono" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" />
            </div>
            <div>
                <label for="direccion" class="block text-sm font-medium text-gray-700">Direcci√≥n:</label>
                <input type="text" id="direccion" placeholder="Direcci√≥n" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" />
            </div>
            <div class="flex items-end">
                <button onclick="nuevoCliente()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md w-full transition duration-150 ease-in-out">‚ûï Nuevo Cliente</button>
            </div>
        </div>

        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div>
                <label for="fechaIngreso" class="block text-sm font-medium text-gray-700">Fecha de Ingreso:</label>
                <input type="date" id="fechaIngreso" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" />
            </div>
            <div>
                <label for="fechaEntrega" class="block text-sm font-medium text-gray-700">Fecha de Entrega:</label>
                <input type="date" id="fechaEntrega" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" />
            </div>
            <div>
                <label for="estado" class="block text-sm font-medium text-gray-700">Estado del Pedido:</label>
                <select id="estado" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500">
                    <option value="En espera">En espera</option>
                    <option value="Entregado">Entregado</option>
                    <option value="Facturado">Facturado</option>
                </select>
            </div>
            <div class="flex items-end">
                <button onclick="guardarFactura()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md w-full transition duration-150 ease-in-out">üíæ Guardar Factura</button>
            </div>
        </div>

        <h2 class="font-semibold mt-6 mb-3 text-lg">Agregar √çtems a la Factura</h2>
        <div class="grid md:grid-cols-4 gap-4 mb-4">
            <div>
                <label for="descripcion" class="sr-only">Descripci√≥n</label>
                <input type="text" id="descripcion" placeholder="Descripci√≥n del Art√≠culo/Servicio" class="p-2 border border-gray-300 rounded-md w-full focus:ring-teal-500 focus:border-teal-500" />
            </div>
            <div>
                <label for="cantidad" class="sr-only">Cantidad</label>
                <input type="number" id="cantidad" placeholder="Cantidad" class="p-2 border border-gray-300 rounded-md w-full focus:ring-teal-500 focus:border-teal-500" min="1" value="1" />
            </div>
            <div>
                <label for="precio" class="sr-only">Precio Unitario</label>
                <input type="number" id="precio" placeholder="Precio Unitario" class="p-2 border border-gray-300 rounded-md w-full focus:ring-teal-500 focus:border-teal-500" min="0" step="0.01" />
            </div>
            <div class="flex items-end">
                <button onclick="agregarItem()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-md w-full transition duration-150 ease-in-out">+ Agregar √çtem</button>
            </div>
        </div>

        <div class="overflow-x-auto mb-6">
            <table class="min-w-full text-sm text-left border border-gray-300 rounded-md overflow-hidden">
                <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
                    <tr>
                        <th class="px-3 py-3 border-b-2 border-gray-200 tracking-wider">Descripci√≥n</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-center tracking-wider">Cantidad</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-right tracking-wider">Precio Unitario</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-right tracking-wider">Subtotal</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-center tracking-wider">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="tablaItems" class="bg-white divide-y divide-gray-200">
                    </tbody>
                <tfoot>
                    <tr class="bg-gray-50 font-semibold">
                        <td colspan="3" class="text-right px-3 py-2 border-t border-gray-200 text-gray-800">Total:</td>
                        <td class="px-3 py-2 border-t border-gray-200 text-right text-gray-800" id="total">$0.00</td>
                        <td class="border-t border-gray-200"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="flex justify-end space-x-4">
            <button onclick="mostrarFactura()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-md transition duration-150 ease-in-out">üñ® Imprimir / Ver Previsualizaci√≥n</button>
            <button onclick="limpiarFormulario()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-md transition duration-150 ease-in-out">üîÑ Limpiar Formulario</button>
        </div>
    </div>

    <div id="gestionFacturas" class="max-w-6xl mx-auto mt-8 bg-white p-6 rounded shadow">
        <h2 class="font-semibold text-lg mb-4">Gesti√≥n y Consulta de Facturas</h2>

        <div class="grid md:grid-cols-3 gap-4 mb-4">
            <div>
                <label for="filtroCliente" class="block text-sm font-medium text-gray-700">Filtrar por Cliente:</label>
                <input type="text" id="filtroCliente" placeholder="Nombre o C√©dula del Cliente" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" onkeyup="filtrarFacturas()" />
            </div>
             <div>
                <label for="filtroNumeroFactura" class="block text-sm font-medium text-gray-700">Filtrar por N¬∞ Factura:</label>
                <input type="text" id="filtroNumeroFactura" placeholder="Ej: 00000125" class="p-2 border border-gray-300 rounded-md w-full focus:ring-blue-500 focus:border-blue-500" onkeyup="filtrarFacturas()" />
            </div>
            <div class="flex items-end">
                <button onclick="cargarFacturas()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md w-full transition duration-150 ease-in-out">Actualizar Lista</button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left border border-gray-300 rounded-md overflow-hidden">
                <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
                    <tr>
                        <th class="px-3 py-3 border-b-2 border-gray-200 tracking-wider">N¬∞ Factura</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 tracking-wider">Cliente</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-right tracking-wider">Total</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 tracking-wider">Estado</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 tracking-wider">Fecha Ing.</th>
                        <th class="px-3 py-3 border-b-2 border-gray-200 text-center tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody id="listaFacturasTableBody" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="6" class="text-center py-4 text-gray-500">Cargando facturas...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
    <script src="firebase.js"></script>
    <script>
        const db = firebase.firestore();
        let items = [];
        let todasLasFacturas = []; // Para almacenar todas las facturas cargadas y permitir filtros

        // Inicializar las fechas a la fecha actual y cargar facturas al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fechaIngreso').value = today;
            document.getElementById('fechaEntrega').value = today;
            actualizarTabla(); // Para el formulario de nueva factura (mostrar "No hay √≠tems...")
            cargarFacturas(); // Cargar facturas existentes al inicio
        });

        function agregarItem() {
            const descripcionInput = document.getElementById('descripcion');
            const cantidadInput = document.getElementById('cantidad');
            const precioInput = document.getElementById('precio');

            const descripcion = descripcionInput.value.trim();
            const cantidad = parseInt(cantidadInput.value);
            const precio = parseFloat(precioInput.value);

            if (!descripcion || isNaN(cantidad) || cantidad <= 0 || isNaN(precio) || precio < 0) {
                alert('Por favor, ingresa una descripci√≥n v√°lida, una cantidad positiva y un precio unitario no negativo.');
                return;
            }

            const subtotal = cantidad * precio;
            items.push({ descripcion, cantidad, precio, subtotal });

            // Limpiar campos despu√©s de agregar
            descripcionInput.value = '';
            cantidadInput.value = '1';
            precioInput.value = '';
            descripcionInput.focus();

            actualizarTabla();
        }

        function actualizarTabla() {
            const tabla = document.getElementById('tablaItems');
            const totalEl = document.getElementById('total');
            tabla.innerHTML = '';
            let total = 0;

            if (items.length === 0) {
                tabla.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No hay √≠tems agregados a√∫n.</td></tr>`;
                totalEl.textContent = `$0.00`;
                return;
            }

            items.forEach((item, index) => {
                total += item.subtotal;
                tabla.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 border-b border-gray-200">${item.descripcion}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-center">${item.cantidad}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-right">$${item.precio.toFixed(2)}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-right">$${item.subtotal.toFixed(2)}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-center">
                            <button onclick="eliminarItem(${index})" class="text-red-600 hover:text-red-800 transition duration-150 ease-in-out" title="Eliminar √çtem">‚úñ</button>
                        </td>
                    </tr>
                `;
            });
            totalEl.textContent = `$${total.toFixed(2)}`;
        }

        function eliminarItem(index) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este √≠tem?')) {
                items.splice(index, 1);
                actualizarTabla();
            }
        }

        // Funci√≥n auxiliar para formatear el n√∫mero de factura
        function formatInvoiceNumber(number) {
            const year = new Date().getFullYear();
            const paddedNumber = String(number).padStart(6, '0');
            return `${paddedNumber}${year.toString().substring(2)}`;
        }

        async function guardarFactura() {
            const cliente = document.getElementById('cliente').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const direccion = document.getElementById('direccion').value.trim();
            const fechaIngreso = document.getElementById('fechaIngreso').value;
            const fechaEntrega = document.getElementById('fechaEntrega').value;
            const estado = document.getElementById('estado').value;
            const total = items.reduce((sum, item) => sum + item.subtotal, 0);

            if (!cliente || !telefono || !direccion || !fechaIngreso || !fechaEntrega) {
                alert('Por favor, completa todos los datos del cliente y las fechas.');
                return;
            }
            if (items.length === 0) {
                alert('La factura debe contener al menos un √≠tem.');
                return;
            }
            if (new Date(fechaIngreso) > new Date(fechaEntrega)) {
                alert('La fecha de entrega no puede ser anterior a la fecha de ingreso.');
                return;
            }

            let invoiceNumber = ''; // Variable para almacenar el n√∫mero de factura generado

            try {
                // INICIO DE LA TRANSACCI√ìN PARA GENERAR EL N√öMERO DE FACTURA
                await db.runTransaction(async (transaction) => {
                    const counterRef = db.collection('contadores').doc('facturas');
                    const counterDoc = await transaction.get(counterRef);

                    let currentNumber = 0;
                    if (counterDoc.exists) {
                        currentNumber = counterDoc.data().ultimoNumero || 0;
                    }

                    const newNumber = currentNumber + 1;
                    transaction.update(counterRef, { ultimoNumero: newNumber });

                    invoiceNumber = formatInvoiceNumber(newNumber);
                });
                // FIN DE LA TRANSACCI√ìN

                const data = {
                    numeroFactura: invoiceNumber,
                    cliente,
                    telefono,
                    direccion,
                    fechaIngreso,
                    fechaEntrega,
                    estado,
                    items,
                    total: parseFloat(total.toFixed(2)),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                const docRef = await db.collection('facturas').add(data);
                alert(`Factura ${invoiceNumber} guardada con √©xito.`);

                generarPDF(data, invoiceNumber);
                limpiarFormulario();
                cargarFacturas(); // Recargar la lista de facturas despu√©s de guardar una nueva

            } catch (error) {
                console.error("Error al guardar la factura: ", error);
                alert("Hubo un error al guardar la factura. Por favor, int√©ntalo de nuevo. Detalles: " + error.message);
            }
        }

        function generarPDF(data, facturaNum) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 15;
            const margin = 15;
            const lineHeight = 7;

            doc.setFontSize(18);
            doc.setTextColor(52, 152, 219);
            doc.text("Factura - Fixitech", margin, y);
            y += lineHeight * 2;

            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);

            doc.setFontSize(12);
            doc.text(`Factura #${facturaNum || 'N/A'}`, doc.internal.pageSize.width - margin, 15, null, null, 'right');
            doc.setFontSize(10);
            y += lineHeight;

            doc.setFont("helvetica", "bold");
            doc.text("Datos del Cliente:", margin, y);
            doc.setFont("helvetica", "normal");
            y += lineHeight;
            doc.text(`Cliente: ${data.cliente}`, margin, y);
            y += lineHeight;
            doc.text(`Tel√©fono: ${data.telefono}`, margin, y);
            y += lineHeight;
            doc.text(`Direcci√≥n: ${data.direccion}`, margin, y);
            y += lineHeight;
            doc.text(`Fecha de Ingreso: ${data.fechaIngreso}`, margin, y);
            y += lineHeight;
            doc.text(`Fecha de Entrega: ${data.fechaEntrega}`, margin, y);
            y += lineHeight * 2;

            doc.setFont("helvetica", "bold");
            doc.text("Detalle de los Servicios/Productos:", margin, y);
            y += lineHeight;

            const tableHeaders = [["Descripci√≥n", "Cantidad", "Precio Unitario", "Subtotal"]];
            const tableData = data.items.map(item => [
                item.descripcion,
                item.cantidad.toString(),
                `$${item.precio.toFixed(2)}`,
                `$${item.subtotal.toFixed(2)}`
            ]);

            doc.autoTable({
                startY: y,
                head: tableHeaders,
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [23, 162, 184], textColor: [255, 255, 255], fontStyle: 'bold' },
                styles: { fontSize: 9, cellPadding: 2, overflow: 'linebreak' },
                columnStyles: {
                    0: { cellWidth: 80 },
                    1: { cellWidth: 25, halign: 'center' },
                    2: { cellWidth: 35, halign: 'right' },
                    3: { cellWidth: 35, halign: 'right' }
                },
                didDrawPage: function (data) {
                    let str = "P√°gina " + doc.internal.getNumberOfPages();
                    doc.setFontSize(10);
                    doc.text(str, doc.internal.pageSize.width - margin, doc.internal.pageSize.height - 10);
                }
            });

            y = doc.autoTable.previous.finalY + lineHeight;

            doc.setFont("helvetica", "bold");
            doc.text(`Total: $${data.total.toFixed(2)}`, doc.internal.pageSize.width - margin, y, null, null, 'right');
            y += lineHeight;
            doc.text(`Estado del Pedido: ${data.estado}`, margin, y);

            y += lineHeight * 2;
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text("Gracias por preferir Fixitech. Para cualquier consulta, cont√°ctenos.", margin, y);

            doc.save(`Factura_Fixitech_${facturaNum}.pdf`);
        }

        async function buscarClientePorCedula() {
            const clienteInput = document.getElementById('cliente');
            const telefonoInput = document.getElementById('telefono');
            const direccionInput = document.getElementById('direccion');
            const cedula = clienteInput.value.trim();

            if (cedula.length < 3) {
                telefonoInput.value = '';
                direccionInput.value = '';
                return;
            }

            try {
                const doc = await db.collection('clientes').doc(cedula).get();
                if (doc.exists) {
                    const data = doc.data();
                    telefonoInput.value = data.telefono || '';
                    direccionInput.value = data.direccion || '';
                    if (data.nombre && !/^\d+$/.test(clienteInput.value)) {
                        clienteInput.value = data.nombre; // Cambia el input a nombre si se encontr√≥ por c√©dula y tiene nombre
                    }
                    console.log("Cliente encontrado por c√©dula:", data);
                    return;
                }

                const querySnapshot = await db.collection('clientes')
                    .where('nombre', '==', cedula)
                    .limit(1)
                    .get();

                if (!querySnapshot.empty) {
                    const doc = querySnapshot.docs[0];
                    const data = doc.data();
                    telefonoInput.value = data.telefono || '';
                    direccionInput.value = data.direccion || '';
                    clienteInput.value = data.nombre || cedula;
                    console.log("Cliente encontrado por nombre:", data);
                } else {
                    telefonoInput.value = '';
                    direccionInput.value = '';
                    console.log("Cliente no encontrado.");
                }
            } catch (error) {
                console.error("Error al buscar cliente:", error);
                alert("Hubo un error al buscar el cliente. Por favor, int√©ntalo de nuevo.");
            }
        }

        async function nuevoCliente() {
            const clienteInput = document.getElementById('cliente');
            const telefonoInput = document.getElementById('telefono');
            const direccionInput = document.getElementById('direccion');

            const nombreOrCedula = clienteInput.value.trim();
            const telefono = telefonoInput.value.trim();
            const direccion = direccionInput.value.trim();

            if (!nombreOrCedula || !telefono || !direccion) {
                alert("Por favor, completa la C√©dula/Nombre, Tel√©fono y Direcci√≥n para registrar un nuevo cliente.");
                return;
            }

            try {
                const isNumeric = /^\d+$/.test(nombreOrCedula);
                let docId = nombreOrCedula;
                let clientData = { telefono, direccion };

                if (isNumeric) {
                    const docRef = db.collection('clientes').doc(docId);
                    const doc = await docRef.get();

                    if (doc.exists) {
                        await docRef.set(clientData, { merge: true });
                        alert(`Cliente con c√©dula ${docId} actualizado correctamente.`);
                    } else {
                        await docRef.set(clientData);
                        alert(`Cliente con c√©dula ${docId} registrado correctamente.`);
                    }
                } else {
                    const existingClientQuery = await db.collection('clientes')
                        .where('nombre', '==', nombreOrCedula)
                        .limit(1)
                        .get();

                    if (!existingClientQuery.empty) {
                        alert(`Error: Ya existe un cliente registrado con el nombre "${nombreOrCedula}". Por favor, usa un nombre √∫nico o la c√©dula.`);
                        return;
                    }

                    clientData.nombre = nombreOrCedula;
                    const newDocRef = await db.collection('clientes').add(clientData);
                    alert(`Cliente "${nombreOrCedula}" registrado con ID: ${newDocRef.id}`);
                }
            } catch (error) {
                console.error("Error al registrar cliente:", error);
                alert("Hubo un error al registrar el cliente. Por favor, int√©ntalo de nuevo.");
            }
        }

        document.getElementById('cliente').addEventListener('input', buscarClientePorCedula);

        function mostrarFactura() {
            const cliente = document.getElementById('cliente').value;
            const telefono = document.getElementById('telefono').value;
            const direccion = document.getElementById('direccion').value;
            const fechaIngreso = document.getElementById('fechaIngreso').value;
            const fechaEntrega = document.getElementById('fechaEntrega').value;
            const estado = document.getElementById('estado').value;

            if (!cliente || !telefono || !direccion || items.length === 0) {
                alert('Por favor, completa los datos del cliente y agrega al menos un √≠tem antes de imprimir la vista.');
                return;
            }

            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                <title>Previsualizaci√≥n de Factura</title>
                <style>
                    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 30px; color: #333; }
                    .invoice-container { max-width: 800px; margin: 0 auto; border: 1px solid #eee; padding: 30px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
                    h2 { text-align: center; color: #0f766e; margin-bottom: 25px; }
                    .header-info, .client-info { display: flex; justify-content: space-between; margin-bottom: 20px; }
                    .client-info div, .header-info div { flex: 1; margin-right: 20px; }
                    .client-info div:last-child, .header-info div:last-child { margin-right: 0; }
                    p { margin: 5px 0; line-height: 1.5; }
                    strong { color: #555; }
                    table { width: 100%; border-collapse: collapse; margin-top: 25px; }
                    th, td { border: 1px solid #ddd; padding: 12px 8px; text-align: left; }
                    th { background-color: #f8f8f8; color: #666; font-weight: 600; }
                    tfoot tr.total-row td { background-color: #f0f0f0; font-weight: bold; text-align: right; }
                    .text-right { text-align: right; }
                    .text-center { text-align: center; }
                    .footer { text-align: center; margin-top: 40px; font-size: 0.9em; color: #777; }
                    @media print {
                        body { margin: 0; padding: 0; }
                        .invoice-container { box-shadow: none; border: none; }
                    }
                </style>
                </head>
                <body>
                    <div class="invoice-container">
                        <h2>Factura de Venta - Fixitech</h2>

                        <div class="header-info">
                            <div>
                                <p><strong>N√∫mero de Factura:</strong> [Generado al guardar]</p>
                                <p><strong>Fecha de Emisi√≥n:</strong> ${new Date().toLocaleDateString('es-EC', { day: '2-digit', month: '2-digit', year: 'numeric' })}</p>
                            </div>
                            <div class="text-right">
                                <p><strong>Fixitech</strong></p>
                                <p>Su direcci√≥n aqu√≠</p>
                                <p>Su tel√©fono aqu√≠</p>
                                <p>Su email aqu√≠</p>
                            </div>
                        </div>

                        <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0;">

                        <div class="client-info">
                            <div>
                                <p><strong>Cliente:</strong> ${cliente}</p>
                                <p><strong>Tel√©fono:</strong> ${telefono}</p>
                                <p><strong>Direcci√≥n:</strong> ${direccion}</p>
                            </div>
                            <div>
                                <p><strong>Fecha de Ingreso:</strong> ${fechaIngreso}</p>
                                <p><strong>Fecha de Entrega:</strong> ${fechaEntrega}</p>
                                <p><strong>Estado del Pedido:</strong> ${estado}</p>
                            </div>
                        </div>

                        <table>
                            <thead>
                                <tr>
                                    <th>Descripci√≥n</th>
                                    <th class="text-center">Cant.</th>
                                    <th class="text-right">P. Unitario</th>
                                    <th class="text-right">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            let total = 0;
            items.forEach(item => {
                html += `<tr>
                    <td>${item.descripcion}</td>
                    <td class="text-center">${item.cantidad}</td>
                    <td class="text-right">$${item.precio.toFixed(2)}</td>
                    <td class="text-right">$${item.subtotal.toFixed(2)}</td>
                </tr>`;
                total += item.subtotal;
            });

            html += `
                            </tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <td colspan="3">Total:</td>
                                    <td class="text-right">$${total.toFixed(2)}</td>
                                </tr>
                            </tfoot>
                        </table>

                        <div class="footer">
                            <p>¬°Gracias por su preferencia!</p>
                            <p>Este documento no tiene validez tributaria a menos que se especifique lo contrario.</p>
                        </div>
                    </div>
                </body>
                </html>
            `;

            const nuevaVentana = window.open('', '', 'width=900,height=700,scrollbars=yes');
            nuevaVentana.document.write(html);
            nuevaVentana.document.close();
            nuevaVentana.focus();
        }

        function limpiarFormulario() {
            document.getElementById('cliente').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('direccion').value = '';
            document.getElementById('descripcion').value = '';
            document.getElementById('cantidad').value = '1';
            document.getElementById('precio').value = '';
            document.getElementById('estado').value = 'En espera';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fechaIngreso').value = today;
            document.getElementById('fechaEntrega').value = today;
            items = [];
            actualizarTabla();
            document.getElementById('cliente').focus();
        }

        // --- Nuevas funciones para Gesti√≥n de Facturas ---

        async function cargarFacturas() {
            const tablaBody = document.getElementById('listaFacturasTableBody');
            tablaBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">Cargando facturas...</td></tr>`;
            try {
                const snapshot = await db.collection('facturas').orderBy('timestamp', 'desc').get();
                todasLasFacturas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filtrarFacturas(); // Muestra todas las facturas al cargar inicialmente
            } catch (error) {
                console.error("Error al cargar facturas: ", error);
                tablaBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Error al cargar facturas.</td></tr>`;
            }
        }

        function filtrarFacturas() {
            const filtroCliente = document.getElementById('filtroCliente').value.toLowerCase().trim();
            const filtroNumeroFactura = document.getElementById('filtroNumeroFactura').value.toLowerCase().trim();

            const facturasFiltradas = todasLasFacturas.filter(factura => {
                const matchCliente = factura.cliente.toLowerCase().includes(filtroCliente);
                const matchNumero = factura.numeroFactura && factura.numeroFactura.toLowerCase().includes(filtroNumeroFactura);
                return matchCliente && matchNumero;
            });

            actualizarTablaFacturas(facturasFiltradas);
        }

        function actualizarTablaFacturas(facturasToDisplay) {
            const tablaBody = document.getElementById('listaFacturasTableBody');
            tablaBody.innerHTML = '';

            if (facturasToDisplay.length === 0) {
                tablaBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">No hay facturas que coincidan con los filtros.</td></tr>`;
                return;
            }

            facturasToDisplay.forEach(factura => {
                const fechaIngreso = factura.fechaIngreso || 'N/A';
                // const fechaEntrega = factura.fechaEntrega || 'N/A'; // No se usa en la tabla de listado, pero est√° disponible
                const total = factura.total ? `$${factura.total.toFixed(2)}` : '$0.00';

                tablaBody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 border-b border-gray-200">${factura.numeroFactura || factura.id}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${factura.cliente}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-right">${total}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${factura.estado}</td>
                        <td class="px-3 py-2 border-b border-gray-200">${fechaIngreso}</td>
                        <td class="px-3 py-2 border-b border-gray-200 text-center">
                            <button onclick='verDetalleFactura(${JSON.stringify(factura)})' class="bg-blue-200 text-blue-800 px-2 py-1 rounded text-xs hover:bg-blue-300 transition duration-150 ease-in-out mr-1">Ver Detalles</button>
                            <button onclick='generarPDF(${JSON.stringify(factura)}, "${factura.numeroFactura || factura.id}")' class="bg-teal-200 text-teal-800 px-2 py-1 rounded text-xs hover:bg-teal-300 transition duration-150 ease-in-out">Reimprimir</button>
                        </td>
                    </tr>
                `;
            });
        }

        function verDetalleFactura(facturaData) {
            let itemsHtml = facturaData.items.map(item => `
                <tr>
                    <td>${item.descripcion}</td>
                    <td class="text-center">${item.cantidad}</td>
                    <td class="text-right">$${item.precio.toFixed(2)}</td>
                    <td class="text-right">$${item.subtotal.toFixed(2)}</td>
                </tr>
            `).join('');

            const popupContent = `
                <div class="popup-invoice-container">
                    <h2>Detalles de Factura #${facturaData.numeroFactura || facturaData.id}</h2>

                    <div class="info-section">
                        <div>
                            <p><strong>N√∫mero de Factura:</strong> ${facturaData.numeroFactura || 'N/A'}</p>
                            <p><strong>Fecha de Emisi√≥n:</strong> ${facturaData.timestamp ? new Date(facturaData.timestamp.toDate()).toLocaleDateString('es-EC', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'N/A'}</p>
                        </div>
                        <div class="text-right">
                            <p><strong>Fixitech</strong></p>
                            <p>Su direcci√≥n aqu√≠</p>
                            <p>Su tel√©fono aqu√≠</p>
                            <p>Su email aqu√≠</p>
                        </div>
                    </div>

                    <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0;">

                    <div class="info-section">
                        <div>
                            <p><strong>Cliente:</strong> ${facturaData.cliente}</p>
                            <p><strong>Tel√©fono:</strong> ${facturaData.telefono}</p>
                            <p><strong>Direcci√≥n:</strong> ${facturaData.direccion}</p>
                        </div>
                        <div>
                            <p><strong>Fecha de Ingreso:</strong> ${facturaData.fechaIngreso}</p>
                            <p><strong>Fecha de Entrega:</strong> ${facturaData.fechaEntrega}</p>
                            <p><strong>Estado del Pedido:</strong> ${facturaData.estado}</p>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Descripci√≥n</th>
                                <th class="text-center">Cant.</th>
                                <th class="text-right">P. Unitario</th>
                                <th class="text-right">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="3">Total:</td>
                                <td class="text-right">$${facturaData.total ? facturaData.total.toFixed(2) : '0.00'}</td>
                            </tr>
                        </tfoot>
                    </table>

                    <div class="btn-actions">
                        <button class="btn-print" onclick='window.opener.generarPDF(${JSON.stringify(facturaData)}, "${facturaData.numeroFactura || facturaData.id}")'>Imprimir PDF</button>
                        <button class="btn-close" onclick="window.close()">Cerrar</button>
                    </div>
                </div>
            `;

            const popupWindow = window.open('', '_blank', 'width=950,height=750,scrollbars=yes,resizable=yes');
            popupWindow.document.write(popupContent);
            popupWindow.document.close();
            popupWindow.focus();
        }

    </script>
</body>
</html>
