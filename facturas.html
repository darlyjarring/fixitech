<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nueva Venta - Fixitech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-50 font-sans">

  <!-- Barra de navegaci√≥n -->
  <header class="bg-cyan-800 text-white p-4 flex justify-between items-center shadow">
    <h1 class="text-xl font-bold">Fixitech - Nueva Venta</h1>
    <nav class="space-x-4 text-sm">
      <a href="#" class="hover:underline">Inicio</a>
      <a href="#" class="hover:underline">Clientes</a>
      <a href="#" class="hover:underline">Facturaci√≥n</a>
      <a href="#" class="hover:underline">Galer√≠a</a>
    </nav>
  </header>

  <!-- Formulario de Cliente y Venta -->
  <div class="max-w-6xl mx-auto mt-6 bg-white p-6 rounded shadow">
    <div class="grid md:grid-cols-4 gap-4 mb-4">
      <input type="text" id="cliente" placeholder="Nombre del Cliente" class="p-2 border rounded w-full" />
      <input type="text" id="telefono" placeholder="Tel√©fono" class="p-2 border rounded w-full" />
      <input type="text" id="direccion" placeholder="Direcci√≥n" class="p-2 border rounded w-full" />
      <button onclick="nuevoCliente()" class="bg-green-600 text-white px-4 py-2 rounded w-full">‚ûï Nuevo Cliente</button>
      <button onclick="guardarFactura()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">üíæ Guardar Factura</button>
      <button onclick="mostrarFactura()" class="bg-purple-600 text-white px-4 py-2 rounded w-full">üñ® Imprimir Vista</button>

    </div>

    <div class="grid md:grid-cols-4 gap-4 mb-4">
      <input type="date" id="fechaIngreso" class="p-2 border rounded w-full" />
      <input type="date" id="fechaEntrega" class="p-2 border rounded w-full" />
      <select id="estado" class="p-2 border rounded w-full">
        <option value="En espera">En espera</option>
        <option value="Entregado">Entregado</option>
        <option value="Facturado">Facturado</option>
      </select>
      <p class="p-2 font-semibold bg-gray-100 rounded text-center">Estado del Pedido</p>
    </div>

    <!-- Agregar √çtems -->
    <h2 class="font-semibold mt-6 mb-2 text-lg">Agregar √çtems</h2>
    <div class="grid md:grid-cols-4 gap-4 mb-4">
      <input type="text" id="descripcion" placeholder="Descripci√≥n" class="p-2 border rounded w-full" />
      <input type="number" id="cantidad" placeholder="Cantidad" class="p-2 border rounded w-full" />
      <input type="number" id="precio" placeholder="Precio Unitario" class="p-2 border rounded w-full" />
      <button onclick="agregarItem()" class="bg-teal-600 text-white px-4 py-2 rounded w-full">+ Agregar</button>
    </div>

    <!-- Tabla de √≠tems -->
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm text-left border border-gray-300">
        <thead class="bg-gray-200 text-gray-700">
          <tr>
            <th class="px-3 py-2 border">Descripci√≥n</th>
            <th class="px-3 py-2 border">Cantidad</th>
            <th class="px-3 py-2 border">Precio</th>
            <th class="px-3 py-2 border">Subtotal</th>
            <th class="px-3 py-2 border">Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="tablaItems" class="bg-white"></tbody>
        <tfoot>
          <tr class="bg-gray-100 font-semibold">
            <td colspan="3" class="text-right px-3 py-2 border">Total:</td>
            <td class="px-3 py-2 border" id="total">$0.00</td>
            <td class="border"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
  <script src="firebase.js"></script>
  <script>
    const db = firebase.firestore();
    let items = [];

    function agregarItem() {
      const descripcion = document.getElementById('descripcion').value;
      const cantidad = parseInt(document.getElementById('cantidad').value);
      const precio = parseFloat(document.getElementById('precio').value);
      if (!descripcion || !cantidad || !precio) return alert('Campos incompletos');

      const subtotal = cantidad * precio;
      items.push({ descripcion, cantidad, precio, subtotal });
      document.getElementById('descripcion').value = '';
      document.getElementById('cantidad').value = '';
      document.getElementById('precio').value = '';
      actualizarTabla();
    }

    function actualizarTabla() {
      const tabla = document.getElementById('tablaItems');
      const totalEl = document.getElementById('total');
      tabla.innerHTML = '';
      let total = 0;
      items.forEach((item, index) => {
        total += item.subtotal;
        tabla.innerHTML += `
          <tr>
            <td class="px-3 py-2 border">${item.descripcion}</td>
            <td class="px-3 py-2 border">${item.cantidad}</td>
            <td class="px-3 py-2 border">$${item.precio}</td>
            <td class="px-3 py-2 border">$${item.subtotal.toFixed(2)}</td>
            <td class="px-3 py-2 border"><button onclick="eliminarItem(${index})" class="text-red-600">‚úñ</button></td>
          </tr>
        `;
      });
      totalEl.textContent = `$${total.toFixed(2)}`;
    }

    function eliminarItem(index) {
      items.splice(index, 1);
      actualizarTabla();
    }

    async function guardarFactura() {
      const cliente = document.getElementById('cliente').value;
      const telefono = document.getElementById('telefono').value;
      const direccion = document.getElementById('direccion').value;
      const fechaIngreso = document.getElementById('fechaIngreso').value;
      const fechaEntrega = document.getElementById('fechaEntrega').value;
      const estado = document.getElementById('estado').value;
      const total = items.reduce((sum, item) => sum + item.subtotal, 0);
      if (!cliente || items.length === 0) return alert('Faltan datos del cliente o √≠tems');

      const data = {
        cliente, telefono, direccion, fechaIngreso, fechaEntrega, estado, items, total, timestamp: new Date()
      };
      await db.collection('facturas').add(data);
      alert('Factura guardada');
      generarPDF(data);
      items = [];
      actualizarTabla();
    }
  
    function generarPDF(data) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      doc.setFontSize(12);
      doc.text("Factura - Fixitech", 10, y);
      y += 10;
      doc.text(`Cliente: ${data.cliente}`, 10, y);
      y += 6;
      doc.text(`Tel√©fono: ${data.telefono}`, 10, y);
      y += 6;
      doc.text(`Direcci√≥n: ${data.direccion}`, 10, y);
      y += 6;
      doc.text(`Fecha Ingreso: ${data.fechaIngreso}`, 10, y);
      y += 6;
      doc.text(`Fecha Entrega: ${data.fechaEntrega}`, 10, y);
      y += 10;

      doc.text("Detalle:", 10, y);
      y += 8;
      data.items.forEach(i => {
        doc.text(`- ${i.cantidad} x ${i.descripcion} @ $${i.precio} = $${i.subtotal.toFixed(2)}`, 10, y);
        y += 6;
      });
      y += 4;
      doc.text(`Total: $${data.total.toFixed(2)}`, 10, y);
      y += 6;
      doc.text(`Estado: ${data.estado}`, 10, y + 4);
      doc.save(`Factura_${data.cliente}.pdf`);
    }


     async function buscarClientePorCedula() {
      const cedula = document.getElementById('cliente').value;
      if (cedula.length < 6) return;
      const doc = await db.collection('clientes').doc(cedula).get();
      if (doc.exists) {
        const data = doc.data();
        document.getElementById('telefono').value = data.telefono;
        document.getElementById('direccion').value = data.direccion;
      }
    }
    
    async function nuevoCliente() {
      const cedula = document.getElementById('cliente').value;
      const telefono = document.getElementById('telefono').value;
      const direccion = document.getElementById('direccion').value;
      if (!cedula || !telefono || !direccion) return alert("Faltan datos del cliente");
      await db.collection('clientes').doc(cedula).set({ telefono, direccion });
      alert("Cliente registrado correctamente");
    }
    
    document.getElementById('cliente').addEventListener('input', buscarClientePorCedula);


    function mostrarFactura() {
      const cliente = document.getElementById('cliente').value;
      const telefono = document.getElementById('telefono').value;
      const direccion = document.getElementById('direccion').value;
      const fechaIngreso = document.getElementById('fechaIngreso').value;
      const fechaEntrega = document.getElementById('fechaEntrega').value;
      const estado = document.getElementById('estado').value;
    
      let html = `
        <html>
        <head><title>Factura Fixitech</title>
        <style>
          body { font-family: sans-serif; padding: 20px; }
          h2 { color: #0f766e; }
          table { width: 100%; border-collapse: collapse; margin-top: 15px; }
          th, td { border: 1px solid #ccc; padding: 8px; }
          th { background-color: #f0f0f0; }
        </style>
        </head>
        <body>
          <h2>Factura - Fixitech</h2>
          <p><strong>Cliente:</strong> ${cliente}</p>
          <p><strong>Tel√©fono:</strong> ${telefono}</p>
          <p><strong>Direcci√≥n:</strong> ${direccion}</p>
          <p><strong>Fecha Ingreso:</strong> ${fechaIngreso}</p>
          <p><strong>Fecha Entrega:</strong> ${fechaEntrega}</p>
          <p><strong>Estado:</strong> ${estado}</p>
    
          <table>
            <thead>
              <tr><th>Descripci√≥n</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th></tr>
            </thead>
            <tbody>
      `;
    
      let total = 0;
      items.forEach(item => {
        html += `<tr>
          <td>${item.descripcion}</td>
          <td>${item.cantidad}</td>
          <td>$${item.precio.toFixed(2)}</td>
          <td>$${item.subtotal.toFixed(2)}</td>
        </tr>`;
        total += item.subtotal;
      });
    
      html += `</tbody></table><h3>Total: $${total.toFixed(2)}</h3></body></html>`;
    
      const nuevaVentana = window.open('', '', 'width=800,height=600');
      nuevaVentana.document.write(html);
      nuevaVentana.document.close();
      nuevaVentana.focus();
      nuevaVentana.print();
    }

</script>
</body>
</html>
