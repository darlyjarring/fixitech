<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Facturaci√≥n y Compras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
    <style>
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        .sidebar {
            width: 250px;
        }
        .main-content {
            margin-left: 250px;
        }
        .menu-item.active {
            background-color: #3f83f8;
            color: white;
        }
        .expiring-soon {
            background-color: #fbd38d;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-content, .printable-content * {
                visibility: visible;
            }
            .printable-content {
                position: absolute;
                left: 0;
                top: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex min-h-screen">

    <div id="loginSection" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-3xl font-bold text-center text-teal-600 mb-6">Iniciar Sesi√≥n Fixitech</h2>
            <p id="error" class="text-red-600 mt-4 text-center hidden">Credenciales incorrectas</p>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="usuario" class="block text-gray-700 font-medium mb-2">Usuario:</label>
                    <input type="text" id="usuario" name="usuario" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Ej: admin" required>
                </div>
                 <div class="mb-4">
                    <label for="password" class="block text-gray-700 font-medium mb-2">Contrase√±a:</label>
                    <input type="password" id="password" name="password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Contrase√±a" required>
                </div>
               
                <button type="button" id="loginButton" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition duration-300">Ingresar</button>

            </form>
        </div>
    </div>


    <div id="sidebar" class="sidebar bg-gray-800 text-white flex-shrink-0 fixed h-full p-4 flex flex-col hidden">
        <h1 class="text-2xl font-bold mb-6 text-center text-teal-400">Sistema de Venta</h1>
        <nav class="flex-grow">
            <ul>
                <li id="menu-dashboard" class="mb-2 hidden">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" id="menu-dashboard">
                        <span class="mr-2">üìä</span> Dashboard                 </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 active" id="menu-nueva-venta">
                        <span class="mr-2">üí∞</span> Nueva Venta
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" id="menu-facturas">
                        <span class="mr-2">üìã</span> Gesti√≥n de Ventas
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" id="menu-clientes">
                        <span class="mr-2">üßë‚Äçü§ù‚Äçüßë</span> Gesti√≥n de Clientes
                    </a>
                </li>
                <li id="menu-productos" class="mb-2 hidden">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" id="menu-productos">
                        <span class="mr-2">üì¶</span> Productos y Servicios
                    </a>
                </li>
                <li id="menu-compras" class="mb-2 hidden">
                    <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" id="menu-compras">
                        <span class="mr-2">üõí</span> Gesti√≥n de Compras
                    </a>
                </li>
                 <li id="menu-consulta-productos" class="mb-2 hidden">
                <a href="#" class="menu-item block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" id="menu-consulta-productos">
                    <span class="mr-2">üîç</span> Consulta de Productos
                </a>
                </li>
            </ul>
        </nav>
        <div class="mt-auto text-center text-gray-400 text-sm">
            <p>Bienvenido, <span id="userNameDisplay" class="font-bold"></span></p>
            <p>Rol: <span id="userRoleDisplay" class="font-bold"></span></p>
            <button class="mt-2 text-red-400 hover:text-red-300" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <div id="main-content" class="main-content flex-grow p-8 hidden">
        
        <div id="dashboardSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-3xl font-semibold mb-6 text-gray-800">Dashboard de Gerencia üìä</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-blue-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-blue-800 mb-4">Productos con Mayor Stock üì¶</h3>
                    <ul id="topStockProductsList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
                <div class="bg-yellow-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-yellow-800 mb-4">Productos por Vencer ‚è≥</h3>
                    <ul id="expiringProductsList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
                <div class="bg-green-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-green-800 mb-4">Productos M√°s Vendidos üìà</h3>
                    <ul id="topSellingProductsList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
                <div class="bg-purple-100 p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-purple-800 mb-4">Vendedores con M√°s Ventas üèÜ</h3>
                    <ul id="topSellingUsersList" class="space-y-2 text-gray-700">
                        <li>Cargando...</li>
                    </ul>
                </div>
            </div>
        </div>

        <div id="nuevaVentaSection" class="bg-white rounded-lg shadow-md p-6">
            <h2 id="formFacturaTitle" class="text-2xl font-semibold mb-6 text-gray-800">Datos del Cliente y Nueva Venta</h2>
            
            <form id="formFactura" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-b pb-4 mb-4">
                    <div class="relative">
                        <label for="cedulaCliente" class="block text-sm font-medium text-gray-700">C√©dula</label>
                        <input type="text" id="cedulaCliente" placeholder="C√©dula del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" onblur="buscarClientePorCedula()">
                    </div>
                    <div class="relative">
                        <label for="nombreCliente" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="nombreCliente" placeholder="Nombre Completo del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                        <button type="button" onclick="guardarClienteDesdeFactura()" class="absolute right-2 top-8 text-sm bg-gray-200 hover:bg-gray-300 p-1 rounded-md" title="Guardar este cliente">üíæ</button>
                    </div>
                    <div>
                        <label for="telefono" class="block text-sm font-medium text-gray-700">Tel√©fono</label>
                        <input type="text" id="telefono" placeholder="N√∫mero de Tel√©fono" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="direccion" class="block text-sm font-medium text-gray-700">Direcci√≥n</label>
                        <input type="text" id="direccion" placeholder="Direcci√≥n del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-1 relative">
                        <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripci√≥n</label>
                        <input type="text" id="descripcion" placeholder="Descripci√≥n del Art√≠culo/Servicio" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" />
                        <ul id="sugerencias" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-48 overflow-y-auto hidden"></ul>
                    </div>
                    <div class="md:col-span-1">
                        <label for="cantidad" class="block text-sm font-medium text-gray-700">Cantidad</label>
                        <input type="number" id="cantidad" value="1" min="1" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div class="md:col-span-1">
                        <label for="precio" class="block text-sm font-medium text-gray-700">Precio Unitario</label>
                        <input type="number" id="precio" placeholder="Precio" step="0.01" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div class="md:col-span-1 flex items-end">
                        <button type="button" onclick="agregarItem()" class="w-full bg-teal-500 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-600 transition duration-200">
                            + Agregar √çtem
                        </button>
                    </div>
                    
                </div>
            </form>

            <div class="mt-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">√çtems de la Venta</h3>
                <div class="bg-gray-50 rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripci√≥n</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unitario</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="tablaItems" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        <tfoot>
                            <tr class="bg-gray-100">
                                <td colspan="3" class="px-3 py-2 text-right font-bold text-lg text-gray-800">Total:</td>
                                <td colspan="2" class="px-3 py-2 text-right font-bold text-lg text-gray-800" id="total">$0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
            <div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="fechaIngreso" class="block text-sm font-medium text-gray-700">Fecha de Ingreso</label>
                    <input type="date" id="fechaIngreso" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="fechaEntrega" class="block text-sm font-medium text-gray-700">Fecha de Entrega</label>
                    <input type="date" id="fechaEntrega" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="estado" class="block text-sm font-medium text-gray-700">Estado</label>
                    <select id="estado" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                        <option value="En espera">En espera</option>
                        <option value="Facturado">Facturado</option>
                        <option value="Entregado">Entregado</option>
                    </select>
                </div>
                <div>
                    <label for="vendedor" class="block text-sm font-medium text-gray-700">Vendedor</label>
                    <input type="text" id="vendedor" class="mt-1 p-2 block w-full border border-gray-300 rounded-md bg-gray-200" readonly>
                </div>
            </div>
            
            <div class="flex justify-end space-x-4 mt-8">
                <button type="button" onclick="mostrarFactura()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                    üîç Previsualizar
                </button>
                <button type="button" id="guardarFacturaBtn" onclick="guardarFactura()" class="bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition duration-200">
                    üíæ Guardar Venta
                </button>
            </div>
        </div>

        <div id="gestionFacturasSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Ventas</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div>
                    <label for="filtroVentasAnio" class="block text-sm font-medium text-gray-700">A√±o</label>
                    <select id="filtroVentasAnio" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div>
                    <label for="filtroVentasMes" class="block text-sm font-medium text-gray-700">Mes</label>
                    <select id="filtroVentasMes" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                        <option value="">Todos</option>
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div>
                    <label for="filtroVentasHoraInicial" class="block text-sm font-medium text-gray-700">Hora Inicial</label>
                    <input type="time" id="filtroVentasHoraInicial" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="filtroVentasHoraFinal" class="block text-sm font-medium text-gray-700">Hora Final</label>
                    <input type="time" id="filtroVentasHoraFinal" onchange="filtrarFacturas()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N¬∞ Factura</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendedor</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaFacturasTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="gestionClientesSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Clientes</h2>


            <form id="formCliente" class="space-y-4 mb-6 hidden">
                <h3 id="formClienteTitle" class="text-xl font-semibold">Editar Cliente</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label for="editCedula" class="block text-sm font-medium text-gray-700">C√©dula</label>
                        <input type="text" id="editCedula" placeholder="C√©dula del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md bg-gray-200" readonly>
                    </div>
                    <div>
                        <label for="editNombre" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="editNombre" placeholder="Nombre Completo del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="editTelefono" class="block text-sm font-medium text-gray-700">Tel√©fono</label>
                        <input type="text" id="editTelefono" placeholder="N√∫mero de Tel√©fono" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="editDireccion" class="block text-sm font-medium text-gray-700">Direcci√≥n</label>
                        <input type="text" id="editDireccion" placeholder="Direcci√≥n del Cliente" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="limpiarFormularioCliente()" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-600 transition duration-200">
                        Cancelar
                    </button>
                    <button type="button" onclick="guardarCliente()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                        üíæ Guardar Cambios
                    </button>
                </div>
            </form>

            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="filtroClienteNombre" class="block text-sm font-medium text-gray-700">Buscar por Nombre o C√©dula</label>
                    <input type="text" id="filtroClienteNombre" oninput="filtrarClientes()" placeholder="Ej: Ana L√≥pez" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
            </div>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√©dula</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tel√©fono</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Direcci√≥n</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaClientesTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div id="gestionProductosSection" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 id="formProductoServicioTitle" class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Productos y Servicios</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div>
        <label for="filtroNombreProducto" class="block text-sm font-medium text-gray-700">Buscar por Nombre</label>
        <input type="text" id="filtroNombreProducto" oninput="filtrarProductos()" placeholder="Ej: Memoria RAM" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
    </div>
    <div>
        <label for="filtroTipoProducto" class="block text-sm font-medium text-gray-700">Filtrar por Tipo</label>
        <select id="filtroTipoProducto" onchange="filtrarProductos()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
            <option value="">Todos</option>
            <option value="producto">Producto</option>
            <option value="servicio">Servicio</option>
        </select>
    </div>
    <div>
        <label for="filtroVencimientoProducto" class="block text-sm font-medium text-gray-700">Vencimiento antes de</label>
        <input type="date" id="filtroVencimientoProducto" onchange="filtrarProductos()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
    </div>
</div>
            <form id="formProductoServicio" class="space-y-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label for="nombreProducto" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="nombreProducto" placeholder="Nombre del Producto/Servicio" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="tipoProducto" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="tipoProducto" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" onchange="toggleStockInput()">
                            <option value="producto">Producto</option>
                            <option value="servicio">Servicio</option>
                        </select>
                    </div>
                    <div>
                        <label for="precioProducto" class="block text-sm font-medium text-gray-700">Precio de Venta</label>
                        <input type="number" id="precioProducto" placeholder="Precio" step="0.01" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div id="stockInputDiv">
                        <label for="stockProducto" class="block text-sm font-medium text-gray-700">Stock Inicial</label>
                        <input type="number" id="stockProducto" value="0" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="fechaVencimientoProducto" class="block text-sm font-medium text-gray-700">Fecha de Vencimiento</label>
                        <input type="date" id="fechaVencimientoProducto" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                <div class="flex justify-end">
                    <button type="button" id="guardarProductoBtn" onclick="guardarProductoServicio()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                        üíæ Guardar Producto/Servicio
                    </button>
                </div>
            </form>

            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vencimiento</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaProductosTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>


    <div id="gestionComprasSection" class="hidden bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Gesti√≥n de Compras</h2>
        
        <form id="formCompra" class="space-y-4 mb-6">
            <h3 class="text-xl font-semibold mb-2">Registrar Nueva Compra</h3>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label for="numeroFacturaCompra" class="block text-sm font-medium text-gray-700">N√∫mero de Factura</label>
                    <input type="text" id="numeroFacturaCompra" placeholder="Ej: 001-002-12345" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="fechaCompra" class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="date" id="fechaCompra" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="productoCompra" class="block text-sm font-medium text-gray-700">Producto</label>
                    <select id="productoCompra" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                    </select>
                </div>
                <div>
                    <label for="cantidadCompra" class="block text-sm font-medium text-gray-700">Cantidad</label>
                    <input type="number" id="cantidadCompra" value="1" min="1" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="costoCompra" class="block text-sm font-medium text-gray-700">Costo Unitario</label>
                    <input type="number" id="costoCompra" placeholder="Costo" step="0.01" min="0" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div>
                    <label for="fechaVencimientoCompra" class="block text-sm font-medium text-gray-700">Fecha de Vencimiento del Lote</label>
                    <input type="date" id="fechaVencimientoCompra" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
                </div>
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" onclick="guardarCompra()" class="bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition duration-200">
                    üíæ Guardar Compra
                </button>
            </div>
        </form>
    
        <div class="mt-8">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Historial de Compras</h3>
            <div class="bg-gray-50 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N¬∞ Factura</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Costo Unitario</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Costo Total</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                        </tr>
                    </thead>
                    <tbody id="listaComprasTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="consultaProductosSection" class="hidden bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800">Consulta de Productos</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div>
                <label for="filtroNombreConsulta" class="block text-sm font-medium text-gray-700">Buscar por Nombre</label>
                <input type="text" id="filtroNombreConsulta" oninput="filtrarProductosEnConsulta()" placeholder="Ej: Disco duro" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
            </div>
            <div>
                <label for="filtroTipoConsulta" class="block text-sm font-medium text-gray-700">Filtrar por Tipo</label>
                <select id="filtroTipoConsulta" onchange="filtrarProductosEnConsulta()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                    <option value="">Todos</option>
                    <option value="producto">Producto</option>
                    <option value="servicio">Servicio</option>
                </select>
            </div>
            <div>
                <label for="filtroVencimientoConsulta" class="block text-sm font-medium text-gray-700">Vencimiento antes de</label>
                <input type="date" id="filtroVencimientoConsulta" onchange="filtrarProductosEnConsulta()" class="mt-1 p-2 block w-full border border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500">
            </div>
        </div>

        <div class="bg-gray-50 rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
                        <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vencimiento</th>
                    </tr>
                </thead>
                <tbody id="listaConsultaTableBody" class="bg-white divide-y divide-gray-200">
                </tbody>
            </table>
        </div>
    </div>
        
    </div>

    <div id="pdfModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 relative">
            <button class="absolute top-4 right-4 text-gray-600 hover:text-gray-900" onclick="cerrarModal()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Previsualizaci√≥n de Factura</h2>
            <div id="pdf-content" class="printable-content"></div>
            <div class="flex justify-end space-x-4 mt-6">
                <button onclick="generarYDescargarPDF()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                    üì• Descargar PDF
                </button>
                <button onclick="window.print()" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-600 transition duration-200">
                    üñ®Ô∏è Imprimir
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let db;
        let todosLosClientes = [];
        let todosLosProductosYServicios = [];
        let todasLasFacturas = [];
        let todosLosUsuarios = [];
        let todosLosItemsVenta = [];
        let usuarioActual = {};
        let idFacturaEnEdicion = null;
        let facturasFiltradas = [];

        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_AUTH_DOMAIN",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_STORAGE_BUCKET",
            messagingSenderId: "TU_MESSAGING_SENDER_ID",
            appId: "TU_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();

        // Funciones de utilidad
        function formatearMoneda(valor) {
            return parseFloat(valor).toLocaleString('es-EC', { style: 'currency', currency: 'USD' });
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else {
                date = new Date(timestamp);
            }
            return date.toLocaleDateString('es-EC');
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return '';
            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else {
                date = new Date(timestamp);
            }
            return date.toLocaleDateString('es-EC', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }
        
        function mostrarSeccion(seccionId) {
            const secciones = document.querySelectorAll('#main-content > div');
            secciones.forEach(seccion => {
                seccion.classList.add('hidden');
            });
            const seccionActiva = document.getElementById(seccionId);
            if (seccionActiva) {
                seccionActiva.classList.remove('hidden');
            }

            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                item.classList.remove('active');
            });
            const menuActivo = document.getElementById(`menu-${seccionId.replace('Section', '')}`);
            if (menuActivo) {
                menuActivo.classList.add('active');
            }
        }

        // L√≥gica de autenticaci√≥n
        document.getElementById('loginButton').addEventListener('click', login);

        async function login() {
            const usuario = document.getElementById('usuario').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('error');
            try {
                const snapshot = await db.collection('usuarios').where('usuario', '==', usuario).where('password', '==', password).get();
                if (snapshot.empty) {
                    errorElement.classList.remove('hidden');
                } else {
                    usuarioActual = snapshot.docs[0].data();
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('sidebar').classList.remove('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    document.getElementById('userNameDisplay').textContent = usuarioActual.nombre;
                    document.getElementById('userRoleDisplay').textContent = usuarioActual.rol;
                    document.getElementById('vendedor').value = usuarioActual.nombre;
                    await cargarDatosIniciales();
                    mostrarSeccion('nuevaVentaSection');
                    if (usuarioActual.rol === 'admin') {
                        document.getElementById('menu-dashboard').classList.remove('hidden');
                        document.getElementById('menu-productos').classList.remove('hidden');
                        document.getElementById('menu-compras').classList.remove('hidden');
                        document.getElementById('menu-consulta-productos').classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error("Error al iniciar sesi√≥n:", error);
                errorElement.classList.remove('hidden');
            }
        }

        function logout() {
            usuarioActual = {};
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('loginForm').reset();
            document.getElementById('error').classList.add('hidden');
        }

        // Carga de datos iniciales
        async function cargarDatosIniciales() {
            try {
                await Promise.all([
                    cargarProductosServicios(),
                    cargarClientes(),
                    cargarFacturas(),
                    cargarCompras(),
                    cargarUsuarios(),
                ]);
            } catch (error) {
                console.error("Error al cargar los datos iniciales: ", error);
            }
        }
        
        async function cargarProductosServicios() {
            const snapshot = await db.collection('productos-servicios').orderBy('nombre').get();
            todosLosProductosYServicios = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            cargarOpcionesDeProductosEnVentas();
            renderizarProductos(todosLosProductosYServicios);
            renderizarProductosEnConsulta(todosLosProductosYServicios);
            cargarOpcionesDeProductosEnCompras();
        }

        async function cargarClientes() {
            const snapshot = await db.collection('clientes').get();
            todosLosClientes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderizarClientes(todosLosClientes);
        }

        async function cargarFacturas() {
            const snapshot = await db.collection('facturas').orderBy('fecha', 'desc').get();
            todasLasFacturas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            filtrarFacturas();
        }

        async function cargarCompras() {
            const snapshot = await db.collection('compras').orderBy('fecha', 'desc').get();
            const compras = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderizarCompras(compras);
        }

        async function cargarUsuarios() {
            const snapshot = await db.collection('usuarios').get();
            todosLosUsuarios = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        // L√≥gica de la secci√≥n de Nueva Venta
        function cargarOpcionesDeProductosEnVentas() {
            const inputDescripcion = document.getElementById('descripcion');
            const sugerenciasUl = document.getElementById('sugerencias');

            inputDescripcion.addEventListener('input', () => {
                const valorInput = inputDescripcion.value.toLowerCase();
                const sugerencias = todosLosProductosYServicios.filter(p => p.nombre.toLowerCase().includes(valorInput));
                sugerenciasUl.innerHTML = '';
                if (valorInput.length > 0) {
                    sugerencias.forEach(sug => {
                        const li = document.createElement('li');
                        li.textContent = sug.nombre;
                        li.classList.add('px-4', 'py-2', 'cursor-pointer', 'hover:bg-gray-100');
                        li.addEventListener('click', () => {
                            inputDescripcion.value = sug.nombre;
                            document.getElementById('precio').value = sug.precioVenta;
                            sugerenciasUl.classList.add('hidden');
                        });
                        sugerenciasUl.appendChild(li);
                    });
                    sugerenciasUl.classList.remove('hidden');
                } else {
                    sugerenciasUl.classList.add('hidden');
                }
            });

            document.addEventListener('click', (event) => {
                if (!sugerenciasUl.contains(event.target) && event.target !== inputDescripcion) {
                    sugerenciasUl.classList.add('hidden');
                }
            });
        }

        function agregarItem(itemData = null) {
            const tablaItemsBody = document.getElementById('tablaItems');
            const descripcion = itemData ? itemData.descripcion : document.getElementById('descripcion').value;
            const cantidad = itemData ? itemData.cantidad : parseFloat(document.getElementById('cantidad').value);
            const precio = itemData ? itemData.precio : parseFloat(document.getElementById('precio').value);

            if (!descripcion || isNaN(cantidad) || cantidad <= 0 || isNaN(precio) || precio < 0) {
                alert('Por favor, ingrese una descripci√≥n, cantidad y precio v√°lidos.');
                return;
            }

            const subtotal = cantidad * precio;
            const itemId = itemData ? itemData.id : `temp-${Date.now()}`;
            const item = {
                id: itemId,
                descripcion,
                cantidad,
                precio,
                subtotal
            };

            const itemExistente = todosLosItemsVenta.findIndex(i => i.descripcion === descripcion);
            if (itemExistente !== -1) {
                todosLosItemsVenta[itemExistente].cantidad += cantidad;
                todosLosItemsVenta[itemExistente].subtotal += subtotal;
            } else {
                todosLosItemsVenta.push(item);
            }

            renderizarItemsVenta();
            calcularTotal();
            document.getElementById('descripcion').value = '';
            document.getElementById('cantidad').value = '1';
            document.getElementById('precio').value = '';
        }

        function renderizarItemsVenta() {
            const tablaItemsBody = document.getElementById('tablaItems');
            tablaItemsBody.innerHTML = '';
            todosLosItemsVenta.forEach((item, index) => {
                const newRow = tablaItemsBody.insertRow();
                newRow.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${item.descripcion}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 text-center">${item.cantidad}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${formatearMoneda(item.precio)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${formatearMoneda(item.subtotal)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-center">
                        <button type="button" class="text-red-500 hover:text-red-700 font-bold" onclick="eliminarItem(${index})">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
            });
        }

        function eliminarItem(index) {
            todosLosItemsVenta.splice(index, 1);
            renderizarItemsVenta();
            calcularTotal();
        }

        function calcularTotal() {
            const total = todosLosItemsVenta.reduce((sum, item) => sum + item.subtotal, 0);
            document.getElementById('total').textContent = formatearMoneda(total);
        }

        async function guardarFactura() {
            const cedulaCliente = document.getElementById('cedulaCliente').value;
            const nombreCliente = document.getElementById('nombreCliente').value;
            const telefono = document.getElementById('telefono').value;
            const direccion = document.getElementById('direccion').value;
            const fechaIngreso = document.getElementById('fechaIngreso').value;
            const fechaEntrega = document.getElementById('fechaEntrega').value;
            const estado = document.getElementById('estado').value;

            if (!cedulaCliente || !nombreCliente || todosLosItemsVenta.length === 0) {
                alert('Debe completar los datos del cliente y agregar al menos un √≠tem a la venta.');
                return;
            }

            const total = todosLosItemsVenta.reduce((sum, item) => sum + item.subtotal, 0);
            const fechaActual = firebase.firestore.Timestamp.now();
            const fechaIngresoTimestamp = fechaIngreso ? firebase.firestore.Timestamp.fromDate(new Date(fechaIngreso)) : null;
            const fechaEntregaTimestamp = fechaEntrega ? firebase.firestore.Timestamp.fromDate(new Date(fechaEntrega)) : null;

            const nuevaFactura = {
                cedulaCliente,
                nombreCliente,
                telefono,
                direccion,
                items: todosLosItemsVenta,
                total,
                vendedor: usuarioActual.nombre,
                estado,
                fecha: fechaActual,
                fechaIngreso: fechaIngresoTimestamp,
                fechaEntrega: fechaEntregaTimestamp,
            };

            const guardarBtn = document.getElementById('guardarFacturaBtn');
            guardarBtn.disabled = true;

            try {
                if (idFacturaEnEdicion) {
                    await db.collection('facturas').doc(idFacturaEnEdicion).update(nuevaFactura);
                    alert('Factura actualizada con √©xito!');
                } else {
                    await db.collection('facturas').add(nuevaFactura);
                    alert('Factura guardada con √©xito!');
                }
                
                // Actualizar stock de productos
                for (const item of todosLosItemsVenta) {
                    const producto = todosLosProductosYServicios.find(p => p.nombre === item.descripcion);
                    if (producto && producto.tipo === 'producto') {
                        const nuevoStock = producto.stock - item.cantidad;
                        await db.collection('productos-servicios').doc(producto.id).update({
                            stock: nuevoStock
                        });
                    }
                }
                
                limpiarFormularioFactura();
                await cargarFacturas();
                await cargarProductosServicios();
            } catch (error) {
                console.error("Error al guardar la factura: ", error);
                alert("Hubo un error al guardar la factura. Intente de nuevo.");
            } finally {
                guardarBtn.disabled = false;
            }
        }
        
        function limpiarFormularioFactura() {
            document.getElementById('formFactura').reset();
            todosLosItemsVenta = [];
            renderizarItemsVenta();
            calcularTotal();
            idFacturaEnEdicion = null;
            document.getElementById('guardarFacturaBtn').textContent = 'üíæ Guardar Venta';
            document.getElementById('formFacturaTitle').textContent = 'Datos del Cliente y Nueva Venta';
        }

        function editarFactura(facturaId) {
            const factura = todasLasFacturas.find(f => f.id === facturaId);
            if (!factura) {
                alert("Factura no encontrada.");
                return;
            }

            mostrarSeccion('nuevaVentaSection');
            idFacturaEnEdicion = facturaId;
            document.getElementById('guardarFacturaBtn').textContent = 'üíæ Guardar Cambios';
            document.getElementById('formFacturaTitle').textContent = `Editar Venta #${factura.id.substring(0, 6)}`;

            document.getElementById('cedulaCliente').value = factura.cedulaCliente;
            document.getElementById('nombreCliente').value = factura.nombreCliente;
            document.getElementById('telefono').value = factura.telefono;
            document.getElementById('direccion').value = factura.direccion;
            document.getElementById('fechaIngreso').value = factura.fechaIngreso ? factura.fechaIngreso.toDate().toISOString().split('T')[0] : '';
            document.getElementById('fechaEntrega').value = factura.fechaEntrega ? factura.fechaEntrega.toDate().toISOString().split('T')[0] : '';
            document.getElementById('estado').value = factura.estado;

            todosLosItemsVenta = [...factura.items];
            renderizarItemsVenta();
            calcularTotal();
        }

        async function eliminarFactura(facturaId) {
            if (confirm('¬øEst√° seguro de que desea eliminar esta factura? Esta acci√≥n es irreversible.')) {
                try {
                    await db.collection('facturas').doc(facturaId).delete();
                    alert('Factura eliminada con √©xito.');
                    await cargarFacturas();
                } catch (error) {
                    console.error("Error al eliminar la factura: ", error);
                    alert("Hubo un error al eliminar la factura. Intente de nuevo.");
                }
            }
        }

        function mostrarFactura() {
            const pdfContent = document.getElementById('pdf-content');
            pdfContent.innerHTML = '';
            
            const cedulaCliente = document.getElementById('cedulaCliente').value;
            const nombreCliente = document.getElementById('nombreCliente').value;
            const telefono = document.getElementById('telefono').value;
            const direccion = document.getElementById('direccion').value;
            const fechaIngreso = document.getElementById('fechaIngreso').value;
            const fechaEntrega = document.getElementById('fechaEntrega').value;
            const total = document.getElementById('total').textContent;

            if (!nombreCliente || todosLosItemsVenta.length === 0) {
                alert('Debe completar los datos del cliente y agregar al menos un √≠tem para previsualizar.');
                return;
            }

            const headerHTML = `
                <div class="p-6">
                    <h1 class="text-3xl font-bold mb-2">FACTURA</h1>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p><strong>Cliente:</strong> ${nombreCliente}</p>
                            <p><strong>C√©dula:</strong> ${cedulaCliente}</p>
                        </div>
                        <div class="text-right">
                            <p><strong>Fecha:</strong> ${new Date().toLocaleDateString('es-EC')}</p>
                            <p><strong>N√∫mero:</strong> ${idFacturaEnEdicion ? idFacturaEnEdicion.substring(0, 6).toUpperCase() : 'Borrador'}</p>
                        </div>
                        <div>
                            <p><strong>Tel√©fono:</strong> ${telefono}</p>
                            <p><strong>Direcci√≥n:</strong> ${direccion}</p>
                        </div>
                        <div class="text-right">
                            <p><strong>Fecha de Ingreso:</strong> ${fechaIngreso}</p>
                            <p><strong>Fecha de Entrega:</strong> ${fechaEntrega}</p>
                        </div>
                    </div>
                </div>
            `;
            pdfContent.innerHTML += headerHTML;

            const itemsHTML = `
                <div class="p-6">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-2 text-left text-sm font-semibold text-gray-700">Descripci√≥n</th>
                                <th class="py-2 text-center text-sm font-semibold text-gray-700">Cantidad</th>
                                <th class="py-2 text-right text-sm font-semibold text-gray-700">Precio Unitario</th>
                                <th class="py-2 text-right text-sm font-semibold text-gray-700">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${todosLosItemsVenta.map(item => `
                                <tr>
                                    <td class="py-2 whitespace-nowrap text-sm text-gray-900">${item.descripcion}</td>
                                    <td class="py-2 whitespace-nowrap text-sm text-gray-500 text-center">${item.cantidad}</td>
                                    <td class="py-2 whitespace-nowrap text-sm text-gray-500 text-right">${formatearMoneda(item.precio)}</td>
                                    <td class="py-2 whitespace-nowrap text-sm text-gray-500 text-right">${formatearMoneda(item.subtotal)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="py-2 text-right text-lg font-bold text-gray-800">Total:</td>
                                <td class="py-2 text-right text-lg font-bold text-gray-800">${total}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            pdfContent.innerHTML += itemsHTML;

            const modal = document.getElementById('pdfModal');
            modal.classList.remove('hidden');
        }
        
        function cerrarModal() {
            document.getElementById('pdfModal').classList.add('hidden');
        }

        async function generarYDescargarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const facturaData = {
                cedulaCliente: document.getElementById('cedulaCliente').value,
                nombreCliente: document.getElementById('nombreCliente').value,
                telefono: document.getElementById('telefono').value,
                direccion: document.getElementById('direccion').value,
                fechaIngreso: document.getElementById('fechaIngreso').value,
                fechaEntrega: document.getElementById('fechaEntrega').value,
                items: todosLosItemsVenta,
                total: todosLosItemsVenta.reduce((sum, item) => sum + item.subtotal, 0),
                fecha: new Date(),
                numeroFactura: idFacturaEnEdicion ? idFacturaEnEdicion.substring(0, 6).toUpperCase() : 'Borrador'
            };

            doc.setFontSize(22);
            doc.text("FACTURA", 20, 20);

            doc.setFontSize(12);
            doc.text(`Cliente: ${facturaData.nombreCliente}`, 20, 30);
            doc.text(`C√©dula: ${facturaData.cedulaCliente}`, 20, 36);
            doc.text(`Tel√©fono: ${facturaData.telefono}`, 20, 42);
            doc.text(`Direcci√≥n: ${facturaData.direccion}`, 20, 48);

            doc.text(`Fecha: ${facturaData.fecha.toLocaleDateString('es-EC')}`, 150, 30);
            doc.text(`N¬∞ Factura: ${facturaData.numeroFactura}`, 150, 36);
            doc.text(`Fecha de Ingreso: ${facturaData.fechaIngreso}`, 150, 42);
            doc.text(`Fecha de Entrega: ${facturaData.fechaEntrega}`, 150, 48);

            const tableColumn = ["Descripci√≥n", "Cantidad", "Precio Unitario", "Subtotal"];
            const tableRows = facturaData.items.map(item => [
                item.descripcion,
                item.cantidad,
                formatearMoneda(item.precio),
                formatearMoneda(item.subtotal),
            ]);

            doc.autoTable({
                startY: 60,
                head: [tableColumn],
                body: tableRows,
                theme: 'striped',
                headStyles: { fillColor: [243, 244, 246], textColor: [55, 65, 81] },
                bodyStyles: { textColor: [51, 51, 51] },
                didDrawPage: function (data) {
                    doc.text("Total: " + formatearMoneda(facturaData.total), data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

            doc.save(`factura_${facturaData.numeroFactura}.pdf`);
        }
        
        // L√≥gica de la secci√≥n de Gesti√≥n de Ventas
        function renderizarFacturas(facturas) {
            const tablaFacturasBody = document.getElementById('listaFacturasTableBody');
            tablaFacturasBody.innerHTML = '';

            facturas.forEach(factura => {
                const fila = document.createElement('tr');
                const fecha = factura.fecha ? formatDate(factura.fecha) : 'N/A';
                fila.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${factura.id.substring(0, 6)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${factura.nombreCliente}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${formatearMoneda(factura.total)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${factura.vendedor}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${factura.estado}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${fecha}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right text-sm font-medium">
                        <button type="button" class="text-blue-600 hover:text-blue-900 mr-2" onclick="editarFactura('${factura.id}')">‚úèÔ∏è</button>
                        <button type="button" class="text-red-600 hover:text-red-900" onclick="eliminarFactura('${factura.id}')">üóëÔ∏è</button>
                    </td>
                `;
                tablaFacturasBody.appendChild(fila);
            });
        }
        
        function filtrarFacturas() {
            const anio = document.getElementById('filtroVentasAnio').value;
            const mes = document.getElementById('filtroVentasMes').value;
            const horaInicial = document.getElementById('filtroVentasHoraInicial').value;
            const horaFinal = document.getElementById('filtroVentasHoraFinal').value;
            
            let facturasFiltradas = todasLasFacturas;

            if (anio) {
                facturasFiltradas = facturasFiltradas.filter(f => f.fecha && f.fecha.toDate().getFullYear() == anio);
            }
            if (mes) {
                facturasFiltradas = facturasFiltradas.filter(f => f.fecha && f.fecha.toDate().getMonth() + 1 == mes);
            }
            
            renderizarFacturas(facturasFiltradas);
        }

        // L√≥gica de la secci√≥n de Gesti√≥n de Clientes
        function renderizarClientes(clientes) {
            const tablaClientesBody = document.getElementById('listaClientesTableBody');
            tablaClientesBody.innerHTML = '';
            clientes.forEach(cliente => {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${cliente.cedula}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${cliente.nombre}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${cliente.telefono}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${cliente.direccion}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right text-sm font-medium">
                        <button type="button" class="text-blue-600 hover:text-blue-900 mr-2" onclick="editarCliente('${cliente.id}')">‚úèÔ∏è</button>
                        <button type="button" class="text-red-600 hover:text-red-900" onclick="eliminarCliente('${cliente.id}')">üóëÔ∏è</button>
                    </td>
                `;
                tablaClientesBody.appendChild(fila);
            });
        }

        async function buscarClientePorCedula() {
            const cedula = document.getElementById('cedulaCliente').value;
            const cliente = todosLosClientes.find(c => c.cedula === cedula);
            if (cliente) {
                document.getElementById('nombreCliente').value = cliente.nombre;
                document.getElementById('telefono').value = cliente.telefono;
                document.getElementById('direccion').value = cliente.direccion;
            } else {
                document.getElementById('nombreCliente').value = '';
                document.getElementById('telefono').value = '';
                document.getElementById('direccion').value = '';
            }
        }
        
        async function guardarClienteDesdeFactura() {
            const cedula = document.getElementById('cedulaCliente').value;
            const nombre = document.getElementById('nombreCliente').value;
            const telefono = document.getElementById('telefono').value;
            const direccion = document.getElementById('direccion').value;

            if (!cedula || !nombre) {
                alert('La c√©dula y el nombre del cliente son obligatorios.');
                return;
            }

            try {
                const clienteExistente = todosLosClientes.find(c => c.cedula === cedula);
                if (clienteExistente) {
                    await db.collection('clientes').doc(clienteExistente.id).update({ nombre, telefono, direccion });
                    alert('Cliente actualizado con √©xito.');
                } else {
                    await db.collection('clientes').add({ cedula, nombre, telefono, direccion });
                    alert('Cliente guardado con √©xito.');
                }
                await cargarClientes();
            } catch (error) {
                console.error("Error al guardar cliente: ", error);
                alert("Hubo un error al guardar el cliente.");
            }
        }

        function editarCliente(clienteId) {
            const cliente = todosLosClientes.find(c => c.id === clienteId);
            if (cliente) {
                document.getElementById('formCliente').classList.remove('hidden');
                document.getElementById('formClienteTitle').textContent = 'Editar Cliente';
                document.getElementById('editCedula').value = cliente.cedula;
                document.getElementById('editNombre').value = cliente.nombre;
                document.getElementById('editTelefono').value = cliente.telefono;
                document.getElementById('editDireccion').value = cliente.direccion;
                document.getElementById('formCliente').dataset.clienteId = clienteId;
            }
        }

        function limpiarFormularioCliente() {
            document.getElementById('formCliente').reset();
            document.getElementById('formCliente').classList.add('hidden');
            document.getElementById('formCliente').dataset.clienteId = '';
        }

        async function guardarCliente() {
            const clienteId = document.getElementById('formCliente').dataset.clienteId;
            const cedula = document.getElementById('editCedula').value;
            const nombre = document.getElementById('editNombre').value;
            const telefono = document.getElementById('editTelefono').value;
            const direccion = document.getElementById('editDireccion').value;

            if (!cedula || !nombre) {
                alert('La c√©dula y el nombre son obligatorios.');
                return;
            }

            try {
                await db.collection('clientes').doc(clienteId).update({ nombre, telefono, direccion });
                alert('Cliente actualizado con √©xito!');
                limpiarFormularioCliente();
                await cargarClientes();
            } catch (error) {
                console.error("Error al guardar cliente: ", error);
                alert("Hubo un error al guardar los cambios del cliente.");
            }
        }

        async function eliminarCliente(clienteId) {
            if (confirm('¬øEst√° seguro de que desea eliminar este cliente?')) {
                try {
                    await db.collection('clientes').doc(clienteId).delete();
                    alert('Cliente eliminado con √©xito.');
                    await cargarClientes();
                } catch (error) {
                    console.error("Error al eliminar el cliente: ", error);
                    alert("Hubo un error al eliminar el cliente.");
                }
            }
        }
        
        function filtrarClientes() {
            const filtro = document.getElementById('filtroClienteNombre').value.toLowerCase();
            const clientesFiltrados = todosLosClientes.filter(c => 
                c.nombre.toLowerCase().includes(filtro) || c.cedula.toLowerCase().includes(filtro)
            );
            renderizarClientes(clientesFiltrados);
        }

        // L√≥gica de la secci√≥n de Gesti√≥n de Productos y Servicios
        function renderizarProductos(productos) {
            const tablaProductosBody = document.getElementById('listaProductosTableBody');
            tablaProductosBody.innerHTML = '';
            productos.forEach(producto => {
                const esProducto = producto.tipo === 'producto';
                const stockDisplay = esProducto ? producto.stock : 'N/A';
                const fechaVencimiento = producto.fechaVencimiento ? formatDate(producto.fechaVencimiento) : 'N/A';
                const fila = document.createElement('tr');
                if (esProducto && producto.fechaVencimiento && producto.fechaVencimiento.toDate() < new Date()) {
                    fila.classList.add('expiring-soon');
                }
                fila.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${producto.nombre}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${producto.tipo}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${formatearMoneda(producto.precioVenta)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 text-center">${stockDisplay}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${fechaVencimiento}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right text-sm font-medium">
                        <button type="button" class="text-blue-600 hover:text-blue-900 mr-2" onclick="editarProducto('${producto.id}')">‚úèÔ∏è</button>
                        <button type="button" class="text-red-600 hover:text-red-900" onclick="eliminarProducto('${producto.id}')">üóëÔ∏è</button>
                    </td>
                `;
                tablaProductosBody.appendChild(fila);
            });
        }
        
        function toggleStockInput() {
            const tipo = document.getElementById('tipoProducto').value;
            const stockDiv = document.getElementById('stockInputDiv');
            if (tipo === 'servicio') {
                stockDiv.classList.add('hidden');
                document.getElementById('stockProducto').value = 0;
            } else {
                stockDiv.classList.remove('hidden');
            }
        }
        
        async function guardarProductoServicio() {
            const nombre = document.getElementById('nombreProducto').value;
            const tipo = document.getElementById('tipoProducto').value;
            const precioVenta = parseFloat(document.getElementById('precioProducto').value);
            const stock = tipo === 'producto' ? parseInt(document.getElementById('stockProducto').value, 10) : 0;
            const fechaVencimiento = document.getElementById('fechaVencimientoProducto').value;

            if (!nombre || isNaN(precioVenta) || precioVenta < 0) {
                alert('Por favor, complete todos los campos requeridos.');
                return;
            }
            if (tipo === 'producto' && isNaN(stock) || stock < 0) {
                alert('El stock debe ser un n√∫mero v√°lido.');
                return;
            }

            const producto = {
                nombre,
                tipo,
                precioVenta,
                stock,
                fechaVencimiento: fechaVencimiento ? firebase.firestore.Timestamp.fromDate(new Date(fechaVencimiento)) : null,
            };

            const guardarBtn = document.getElementById('guardarProductoBtn');
            guardarBtn.disabled = true;

            try {
                const productoExistente = todosLosProductosYServicios.find(p => p.nombre === nombre);
                if (productoExistente) {
                    await db.collection('productos-servicios').doc(productoExistente.id).update(producto);
                    alert('Producto/Servicio actualizado con √©xito!');
                } else {
                    await db.collection('productos-servicios').add(producto);
                    alert('Producto/Servicio guardado con √©xito!');
                }
                
                document.getElementById('formProductoServicio').reset();
                await cargarProductosServicios();
            } catch (error) {
                console.error("Error al guardar producto/servicio: ", error);
                alert("Hubo un error al guardar el producto/servicio.");
            } finally {
                guardarBtn.disabled = false;
            }
        }
        
        async function eliminarProducto(productoId) {
            if (confirm('¬øEst√° seguro de que desea eliminar este producto/servicio?')) {
                try {
                    await db.collection('productos-servicios').doc(productoId).delete();
                    alert('Producto/Servicio eliminado con √©xito.');
                    await cargarProductosServicios();
                } catch (error) {
                    console.error("Error al eliminar el producto/servicio: ", error);
                    alert("Hubo un error al eliminar el producto/servicio.");
                }
            }
        }
        
        function filtrarProductos() {
            const nombreFiltro = document.getElementById('filtroNombreProducto').value.toLowerCase();
            const tipoFiltro = document.getElementById('filtroTipoProducto').value;
            const vencimientoFiltro = document.getElementById('filtroVencimientoProducto').value;

            const productosFiltrados = todosLosProductosYServicios.filter(p => {
                const coincideNombre = p.nombre.toLowerCase().includes(nombreFiltro);
                const coincideTipo = tipoFiltro === '' || p.tipo === tipoFiltro;
                const coincideVencimiento = !vencimientoFiltro || (p.fechaVencimiento && p.fechaVencimiento.toDate() < new Date(vencimientoFiltro));
                return coincideNombre && coincideTipo && coincideVencimiento;
            });

            renderizarProductos(productosFiltrados);
        }

        // L√≥gica de la secci√≥n de Compras
        function cargarOpcionesDeProductosEnCompras() {
            const selectCompraProducto = document.getElementById('productoCompra');
            selectCompraProducto.innerHTML = '<option value="">-- Seleccione un Producto --</option>';
            todosLosProductosYServicios.filter(p => p.tipo === 'producto').forEach(producto => {
                const option = document.createElement('option');
                option.value = producto.id;
                option.textContent = producto.nombre;
                selectCompraProducto.appendChild(option);
            });
        }
        
        async function guardarCompra() {
            const numeroFactura = document.getElementById('numeroFacturaCompra').value;
            const fechaCompra = document.getElementById('fechaCompra').value;
            const productoId = document.getElementById('productoCompra').value;
            const cantidad = parseInt(document.getElementById('cantidadCompra').value, 10);
            const costo = parseFloat(document.getElementById('costoCompra').value);
            const fechaVencimiento = document.getElementById('fechaVencimientoCompra').value;

            if (!numeroFactura || !fechaCompra || !productoId || isNaN(cantidad) || cantidad <= 0 || isNaN(costo) || costo < 0) {
                alert('Por favor, complete todos los campos de la compra.');
                return;
            }

            const producto = todosLosProductosYServicios.find(p => p.id === productoId);
            if (!producto) {
                alert('Producto no encontrado.');
                return;
            }
            
            const fechaCompraTimestamp = firebase.firestore.Timestamp.fromDate(new Date(fechaCompra));
            const fechaVencimientoTimestamp = fechaVencimiento ? firebase.firestore.Timestamp.fromDate(new Date(fechaVencimiento)) : null;

            const nuevaCompra = {
                numeroFactura,
                fecha: fechaCompraTimestamp,
                productoId,
                productoNombre: producto.nombre,
                cantidad,
                costo,
                costoTotal: cantidad * costo,
                fechaVencimiento: fechaVencimientoTimestamp,
                usuario: usuarioActual.nombre,
            };

            try {
                await db.collection('compras').add(nuevaCompra);
                
                const nuevoStock = producto.stock + cantidad;
                await db.collection('productos-servicios').doc(productoId).update({
                    stock: nuevoStock
                });

                alert('Compra registrada y stock actualizado con √©xito!');
                document.getElementById('formCompra').reset();
                await cargarCompras();
                await cargarProductosServicios();
            } catch (error) {
                console.error("Error al guardar la compra: ", error);
                alert("Hubo un error al registrar la compra. Intente de nuevo.");
            }
        }

        function renderizarCompras(compras) {
            const tablaComprasBody = document.getElementById('listaComprasTableBody');
            tablaComprasBody.innerHTML = '';
            compras.forEach(compra => {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${formatDate(compra.fecha)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${compra.numeroFactura}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${compra.productoNombre}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 text-center">${compra.cantidad}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${formatearMoneda(compra.costo)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${formatearMoneda(compra.costoTotal)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${compra.usuario}</td>
                `;
                tablaComprasBody.appendChild(fila);
            });
        }

        // L√≥gica de la secci√≥n de Consulta de Productos
        function renderizarProductosEnConsulta(productos) {
            const tablaConsultaBody = document.getElementById('listaConsultaTableBody');
            tablaConsultaBody.innerHTML = '';
            productos.forEach(producto => {
                const esProducto = producto.tipo === 'producto';
                const stockDisplay = esProducto ? producto.stock : 'N/A';
                const fechaVencimiento = producto.fechaVencimiento ? formatDate(producto.fechaVencimiento) : 'N/A';
                const fila = document.createElement('tr');
                if (esProducto && producto.fechaVencimiento && producto.fechaVencimiento.toDate() < new Date()) {
                    fila.classList.add('expiring-soon');
                }
                fila.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${producto.nombre}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${producto.tipo}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${formatearMoneda(producto.precioVenta)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 text-center">${stockDisplay}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${fechaVencimiento}</td>
                `;
                tablaConsultaBody.appendChild(fila);
            });
        }
        
        function filtrarProductosEnConsulta() {
            const nombreFiltro = document.getElementById('filtroNombreConsulta').value.toLowerCase();
            const tipoFiltro = document.getElementById('filtroTipoConsulta').value;
            const vencimientoFiltro = document.getElementById('filtroVencimientoConsulta').value;

            const productosFiltrados = todosLosProductosYServicios.filter(p => {
                const coincideNombre = p.nombre.toLowerCase().includes(nombreFiltro);
                const coincideTipo = tipoFiltro === '' || p.tipo === tipoFiltro;
                const coincideVencimiento = !vencimientoFiltro || (p.fechaVencimiento && p.fechaVencimiento.toDate() < new Date(vencimientoFiltro));
                return coincideNombre && coincideTipo && coincideVencimiento;
            });
            renderizarProductosEnConsulta(productosFiltrados);
        }

        // L√≥gica del Dashboard (solo para administradores)
        async function cargarDashboard() {
            if (usuarioActual.rol !== 'admin') {
                return;
            }
            await Promise.all([
                cargarProductosConMayorStock(),
                cargarProductosPorVencer(),
                cargarProductosMasVendidos(),
                cargarVendedoresConMasVentas(),
            ]);
        }

        async function cargarProductosConMayorStock() {
            const productos = todosLosProductosYServicios.filter(p => p.tipo === 'producto').sort((a, b) => b.stock - a.stock).slice(0, 5);
            const lista = document.getElementById('topStockProductsList');
            lista.innerHTML = productos.map(p => `<li>${p.nombre}: ${p.stock}</li>`).join('');
        }

        async function cargarProductosPorVencer() {
            const hoy = new Date();
            const enUnMes = new Date();
            enUnMes.setMonth(hoy.getMonth() + 1);

            const productos = todosLosProductosYServicios.filter(p => 
                p.tipo === 'producto' && p.fechaVencimiento && p.fechaVencimiento.toDate() > hoy && p.fechaVencimiento.toDate() < enUnMes
            );
            const lista = document.getElementById('expiringProductsList');
            lista.innerHTML = productos.map(p => {
                const fecha = p.fechaVencimiento.toDate().toLocaleDateString('es-EC');
                return `<li class="expiring-soon">${p.nombre} (Vence: ${fecha})</li>`;
            }).join('');
        }

        async function cargarProductosMasVendidos() {
            const ventasPorProducto = {};
            todasLasFacturas.forEach(f => {
                f.items.forEach(item => {
                    const nombreProducto = item.descripcion;
                    if (ventasPorProducto[nombreProducto]) {
                        ventasPorProducto[nombreProducto] += item.cantidad;
                    } else {
                        ventasPorProducto[nombreProducto] = item.cantidad;
                    }
                });
            });
            const productosMasVendidos = Object.entries(ventasPorProducto).sort(([, a], [, b]) => b - a).slice(0, 5);
            const lista = document.getElementById('topSellingProductsList');
            lista.innerHTML = productosMasVendidos.map(([nombre, cantidad]) => `<li>${nombre}: ${cantidad} vendidos</li>`).join('');
        }

        async function cargarVendedoresConMasVentas() {
            const ventasPorVendedor = {};
            todasLasFacturas.forEach(f => {
                const vendedor = f.vendedor || 'Desconocido';
                if (ventasPorVendedor[vendedor]) {
                    ventasPorVendedor[vendedor] += f.total;
                } else {
                    ventasPorVendedor[vendedor] = f.total;
                }
            });
            const vendedoresMasVentas = Object.entries(ventasPorVendedor).sort(([, a], [, b]) => b - a).slice(0, 5);
            const lista = document.getElementById('topSellingUsersList');
            lista.innerHTML = vendedoresMasVentas.map(([nombre, total]) => `<li>${nombre}: ${formatearMoneda(total)}</li>`).join('');
        }

        // L√≥gica de navegaci√≥n
        document.getElementById('menu-dashboard').addEventListener('click', () => {
            mostrarSeccion('dashboardSection');
            cargarDashboard();
        });
        document.getElementById('menu-nueva-venta').addEventListener('click', () => {
            mostrarSeccion('nuevaVentaSection');
            limpiarFormularioFactura();
        });
        document.getElementById('menu-facturas').addEventListener('click', () => {
            mostrarSeccion('gestionFacturasSection');
            filtrarFacturas();
        });
        document.getElementById('menu-clientes').addEventListener('click', () => {
            mostrarSeccion('gestionClientesSection');
            filtrarClientes();
        });
        document.getElementById('menu-productos').addEventListener('click', () => {
            mostrarSeccion('gestionProductosSection');
            filtrarProductos();
        });
        document.getElementById('menu-compras').addEventListener('click', () => {
            mostrarSeccion('gestionComprasSection');
        });
        document.getElementById('menu-consulta-productos').addEventListener('click', () => {
            mostrarSeccion('consultaProductosSection');
            filtrarProductosEnConsulta();
        });
    </script>
</body>
</html>
